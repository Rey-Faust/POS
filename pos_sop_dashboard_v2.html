<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Console V2</title>
  <style>
    :root {
      --bg-base: #f4efe5;
      --bg-surface: #fffaf1;
      --bg-panel: #ffffff;
      --text-main: #1f2933;
      --text-sub: #52606d;
      --line: #e9dfce;
      --work: #9d3d2f;
      --comm: #0f766e;
      --sleep: #205295;
      --accent: #8a6f43;
      --ok: #2f855a;
      --danger: #c53030;
      --shadow-soft: 0 12px 30px rgba(58, 42, 22, 0.08);
      --shadow-card: 0 6px 14px rgba(58, 42, 22, 0.06);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --font-main: "Avenir Next", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      --font-display: "Iowan Old Style", "Songti SC", "STSong", serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      color: var(--text-main);
      background:
        radial-gradient(circle at 15% 10%, #f2d4b4 0%, transparent 30%),
        radial-gradient(circle at 90% 90%, #d8ebe6 0%, transparent 34%),
        linear-gradient(145deg, #f6f1e8, #f2ecdf);
      min-height: 100vh;
      padding: 24px;
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
      background: var(--bg-surface);
      border: 1px solid #eadfce;
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .topbar {
      padding: 12px 16px 10px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(120deg, rgba(157, 61, 47, 0.08), rgba(32, 82, 149, 0.08)),
        #fff9f0;
    }

    .title {
      margin: 0;
      font-family: var(--font-display);
      font-size: 22px;
      letter-spacing: 0.15px;
      font-weight: 700;
    }

    .purpose {
      margin: 3px 0 0;
      color: var(--text-sub);
      font-size: 12px;
      line-height: 1.35;
      max-width: 920px;
      opacity: 0.85;
    }

    .head-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .layer-switch {
      display: inline-flex;
      gap: 6px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 3px;
      background: #fff;
    }

    .layer-btn {
      border: none;
      background: transparent;
      color: var(--text-sub);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .layer-btn.active {
      background: #20262f;
      color: #fff;
      box-shadow: 0 4px 10px rgba(32, 38, 47, 0.25);
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tool-btn {
      border: 1px solid #d7cab5;
      background: #fffdf8;
      color: #664f2e;
      border-radius: 999px;
      padding: 7px 13px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tool-btn:hover {
      transform: translateY(-1px);
      background: #fff8ec;
    }

    .tool-icon-btn {
      width: 30px;
      height: 30px;
      border: 1px solid #e4d7c3;
      border-radius: 50%;
      background: #fffdf8;
      color: #8a7350;
      font-size: 13px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.7;
      transition: 0.2s ease;
    }

    .tool-icon-btn:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    main {
      padding: 18px;
    }

    .view {
      display: none;
      animation: fadeIn 0.35s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sop-layout {
      display: grid;
      grid-template-columns: 360px minmax(0, 1fr);
      gap: 14px;
    }

    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }

    .panel-head {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
    }

    .sop-head-two-row {
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .sop-head-two-row .panel-title {
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .sop-head-two-row .mode-filter {
      padding: 0;
      border: none;
      background: transparent;
      width: auto;
      flex: 1 1 auto;
      flex-wrap: nowrap;
    }

    .progress-wrap {
      min-width: 180px;
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      color: var(--text-sub);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f1e8d9;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #be5949, #8a6f43);
      transition: width 0.25s ease;
    }

    .mode-filter {
      padding: 10px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      background: #fffcf7;
    }

    .chip {
      border: 1px solid #e7dac6;
      background: #fff;
      color: var(--text-sub);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip.active {
      background: #2d3748;
      border-color: #2d3748;
      color: #fff;
    }

    .module-list {
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .module-card {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ede1d0;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      margin-bottom: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fffdfa;
      min-width: max-content;
    }

    .module-card:hover {
      transform: translateY(-1px);
      border-color: #d6c3aa;
    }

    .module-card.active {
      border-width: 2px;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(58, 42, 22, 0.1);
    }

    .module-index {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 12px;
    }

    .badge-work { background: var(--work); }
    .badge-comm { background: var(--comm); }
    .badge-sleep { background: var(--sleep); }

    .module-name {
      margin: 0;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.1px;
      white-space: nowrap;
    }

    .module-meta {
      margin-top: 3px;
      font-size: 12px;
      color: var(--text-sub);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .module-progress {
      margin-top: 8px;
      width: 100%;
      height: 5px;
      background: #f0e5d3;
      border-radius: 999px;
      overflow: hidden;
    }

    .module-card .module-meta,
    .module-card .module-progress {
      display: none;
    }

    .module-progress-fill {
      height: 100%;
      width: 0%;
      background: #3a6d63;
    }

    .detail {
      padding: 18px;
    }

    .detail-head {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      align-items: start;
    }

    .detail-title {
      margin: 0;
      font-size: 22px;
      font-family: var(--font-display);
    }

    .detail-sub {
      margin: 7px 0 0;
      color: var(--text-sub);
      font-size: 13px;
      line-height: 1.6;
    }

    .timer {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 8px;
      min-width: 208px;
      background: #fffdf8;
    }

    .timer-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .timer-clock {
      font-family: "Menlo", "Consolas", monospace;
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      text-align: left;
      color: #2d3748;
      line-height: 1;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
    }

    .timer-actions {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .timer-btn {
      border: 1px solid #cdb99f;
      background: #fff;
      color: #5a4a30;
      font-size: 15px;
      font-weight: 700;
      border-radius: 10px;
      padding: 6px 6px;
      cursor: pointer;
    }

    .timer-btn.primary {
      background: #2f4858;
      color: #fff;
      border-color: #2f4858;
    }

    .timer-mini-btn {
      border: 1px solid #d8c4a7;
      background: #fffefb;
      color: #705836;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .budget-mini {
      display: flex;
      gap: 4px;
      align-items: center;
      opacity: 0.68;
    }

    .budget-total {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1;
      font-family: "Menlo", "Consolas", monospace;
    }

    .section {
      margin-top: 18px;
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 14px;
      background: #fffdfa;
    }

    .section-title {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 800;
      color: #503d23;
    }

    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .section-head .section-title {
      margin: 0;
    }

    .section-action-btn {
      border: 1px solid #d9c6aa;
      background: #fffefb;
      color: #715934;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 16px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .todo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .todo-node {
      border: 1px solid #efe3d1;
      border-radius: 10px;
      background: #fff;
      padding: 6px;
    }

    .todo-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
      padding: 4px 6px;
      border-radius: 9px;
    }

    .todo-row.reflection {
      background: #fff7ea;
      border: 1px dashed #dcc6a7;
      border-radius: 9px;
    }

    .todo-check {
      width: 16px;
      height: 16px;
      accent-color: #2f855a;
      cursor: pointer;
    }

    .todo-input {
      border: none;
      width: 100%;
      font-size: 14px;
      background: transparent;
      color: var(--text-main);
      outline: none;
      padding: 4px 0;
      font-family: inherit;
      line-height: 1.4;
      min-height: 26px;
      height: 26px;
      overflow: hidden;
    }

    textarea.todo-input {
      resize: none;
    }

    .todo-row.done .todo-input {
      text-decoration: line-through;
      color: #8898a7;
    }

    .todo-main-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mini-action {
      border: 1px solid #dac7aa;
      background: #fffefb;
      color: #725d3c;
      border-radius: 7px;
      font-size: 12px;
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .todo-del {
      border: none;
      background: transparent;
      color: #9da9b5;
      cursor: pointer;
      font-size: 14px;
      padding: 3px 5px;
      border-radius: 6px;
    }

    .todo-del:hover {
      background: #f5efe4;
      color: var(--danger);
    }

    .sub-list {
      margin-left: 26px;
      margin-top: 6px;
      border-left: 2px solid #efe2ce;
      padding-left: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sub-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
      padding: 4px 6px;
      border-radius: 8px;
      background: #fffaf2;
      border: 1px solid #f3e6d5;
    }

    .sub-row .todo-check {
      width: 14px;
      height: 14px;
    }

    .sub-row.done .todo-input {
      text-decoration: line-through;
      color: #9aa5b1;
    }

    .small-btn {
      border: 1px dashed #ccb697;
      background: #fff;
      color: #715934;
      border-radius: 8px;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .hint {
      margin: 0;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .dashboard-single {
      display: block;
    }

    .dashboard-board {
      padding: 16px;
    }

    .domain-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .domain-pick {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .domain-pick-btn {
      border: 1px solid #decbb2;
      background: #fff;
      color: #6e5736;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }

    .domain-pick-btn.active {
      background: #2e3744;
      color: #fff;
      border-color: #2e3744;
    }

    .domain-focus {
      border: 1px solid #e7d7c3;
      border-radius: 12px;
      background: #fffdf9;
      overflow: hidden;
    }

    .domain-card {
      border: 1px solid #eadcc8;
      border-radius: var(--radius-md);
      background: #fffdf9;
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }

    .domain-head {
      padding: 12px;
      border-bottom: 1px solid #eadcc8;
      background: #fff8ee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .domain-name {
      margin: 0;
      font-size: 15px;
      font-weight: 800;
    }

    .domain-content {
      padding: 12px;
    }

    .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 7px;
    }

    .label-row .label {
      margin: 0;
    }

    .icon-round-btn {
      width: 24px;
      height: 24px;
      border: 1px solid #d9c7aa;
      background: #fffefb;
      color: #715934;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      line-height: 1;
    }

    .fqa-item + .fqa-item {
      margin-top: 8px;
    }

    .fqa-item-head {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .fqa-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .fqa-answer {
      margin-top: 6px;
    }

    .sop-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .sop-file {
      margin-top: 4px;
      font-size: 11px;
      color: #6f7b87;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .text-input {
      resize: none;
      min-height: 34px;
      height: 34px;
      overflow: hidden;
      line-height: 1.4;
      font-family: inherit;
    }

    .detail-block + .detail-block {
      margin-top: 14px;
    }

    .label {
      margin: 0 0 7px;
      font-size: 12px;
      color: #7c6542;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .text-input {
      width: 100%;
      border: 1px solid #e7d8c3;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 14px;
      outline: none;
      background: #fffefb;
      color: #1f2933;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .list-edit {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .line-edit {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: center;
    }

    .kpi-row.done .text-input {
      text-decoration: line-through;
      color: #8898a7;
    }

    .empty-note {
      color: var(--text-sub);
      font-size: 13px;
      margin: 4px 0;
    }

    @media (max-width: 980px) {
      body {
        padding: 12px;
      }

      .purpose {
        display: none;
      }

      .sop-layout {
        grid-template-columns: 1fr;
      }

      .sop-head-two-row {
        padding: 12px;
      }

      .domain-grid {
        grid-template-columns: 1fr;
      }

      .domain-pick {
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .domain-pick-btn {
        white-space: nowrap;
      }

      .timer {
        min-width: 100%;
      }

      .timer-clock {
        font-size: 30px;
      }

    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1 class="title">POS Console V2</h1>
      <p class="purpose">
        ÁõÆÊ†áÔºö‰ΩéÊ≥¢Âä®„ÄÅÂèØÂ§çÁõò„ÄÅÂèØÈïøÊúüÁßØÁ¥Ø„ÄÇ
      </p>
      <div class="head-row">
        <div class="layer-switch" role="tablist" aria-label="POS Layers">
          <button class="layer-btn active" id="layerSopBtn" type="button" onclick="switchLayer('sop')">SOP ÊâßË°åÂ±Ç</button>
          <button class="layer-btn" id="layerDashboardBtn" type="button" onclick="switchLayer('dashboard')">Dashboard ÂÜ≥Á≠ñÂ±Ç</button>
        </div>
        <div class="toolbar">
          <button class="tool-icon-btn" type="button" onclick="exportData()" title="ÂØºÂá∫ CSV" aria-label="ÂØºÂá∫ CSV">‚§ì</button>
        </div>
      </div>
    </header>

    <main>
      <section class="view active" id="sopView">
        <div class="sop-layout">
          <aside class="panel">
            <div class="panel-head sop-head-two-row">
              <h2 class="panel-title">‰ªäÊó• SOP ÊµÅÁ®ã</h2>
              <div class="mode-filter" id="modeFilter"></div>
            </div>
            <div class="module-list" id="moduleList"></div>
          </aside>

          <section class="panel detail" id="moduleDetail"></section>
        </div>
      </section>

      <section class="view" id="dashboardView">
        <section class="panel dashboard-single">
          <div class="panel-head">
            <h2 class="panel-title">ÂõõÂ§ßÊ†∏ÂøÉÂüü‰∏éÂÜ≥Á≠ñÈù¢Êùø</h2>
            <span class="hint">ÁÇπÈÄâÊ®°ÂùóÂêéÁª¥Êä§ FQA„ÄÅPrinciples„ÄÅSOP‰∏éÊ®°Áâà„ÄÇ</span>
          </div>
          <div class="dashboard-board">
            <div class="domain-grid" id="domainGrid"></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "pos_console_v2";
    const MODE_LABEL = { work: "Work", comm: "Communication", sleep: "Sleep" };
    const MODE_COLOR_CLASS = { work: "badge-work", comm: "badge-comm", sleep: "badge-sleep" };
    const DOMAIN_ORDER = ["health", "cognition", "relationship", "wealth"];

    const defaultState = {
      layer: "sop",
      modeFilter: "work",
      activeModuleId: "wake",
      dailyBudgetMinutes: 425,
      modules: [
        {
          id: "wake",
          order: 1,
          mode: "sleep",
          title: "Sleep Ëµ∑Â∫ä",
          duration: 25,
          intent: "ÊãâËµ∑Ë∫´‰Ωì‰∏éÊ≥®ÊÑèÂäõÔºå‰∏∫Êï¥Â§©ÂÜ≥Á≠ñË¥®ÈáèÊâìÂ∫ï„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "ÂºÄÁ™óËßÅÂÖâ 5 ÂàÜÈíüÔºåÂñù 500ml Ê∞¥", done: false },
            { text: "3-5 ÂàÜÈíüÊãâ‰º∏ÊàñËΩªÂ∫¶ÂøÉÁéáÊøÄÊ¥ª", done: false },
            { text: "Á°ÆËÆ§‰ªäÂ§©‰∏ªÁõÆÊ†á‰∏éÁ¶ÅÂÅö‰∫ãÈ°π", done: false }
          ],
          hint: "Sleep Ê®°Âùó‰ª•ÁîüÁêÜÁä∂ÊÄÅ‰∏éËäÇÂæãÁ®≥ÂÆö‰∏∫‰∏ª„ÄÇ"
        },
        {
          id: "work-start",
          order: 2,
          mode: "work",
          title: "Work ÂêØÂä®",
          duration: 30,
          intent: "Âú®ÊúÄÁü≠Êó∂Èó¥ÂÜÖËøõÂÖ•ÂèØÊâßË°åÁä∂ÊÄÅ„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "Êï¥ÁêÜÊ°åÈù¢ÂíåÊï∞Â≠óÁéØÂ¢ÉÔºåÂ±èËîΩÂπ≤Êâ∞", done: false },
            { text: "ÂõûÁúã DashboardÔºåÊòéÁ°Æ‰ªäÊó•ÊúÄÂÖ≥ÈîÆ‰∫ßÂá∫", done: false },
            { text: "Â∞Ü‰ªªÂä°ÊãÜ‰∏∫ 1 ‰∏™‰∏ª‰ªªÂä° + 2 ‰∏™Ê¨°‰ªªÂä°", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-1",
          order: 3,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ1",
          duration: 90,
          intent: "‰ºòÂÖàÊé®ËøõÊúÄÈ´òÊù†ÊùÜ‰∏ª‰∫ßÂá∫„ÄÇ",
          reflection: "",
          remainingSeconds: 90 * 60,
          todos: [
            { text: "ÂÖàÂÆåÊàêÊúÄÈöæ 20% Â∑•‰Ωú", done: false },
            { text: "ÊØè 30 ÂàÜÈíüÊ£ÄÊü•ÊòØÂê¶ÂÅèÁ¶ªÁõÆÊ†á", done: false },
            { text: "ËÆ∞ÂΩïÈòªÂ°ûÁÇπÂπ∂ÊèêÂá∫‰∏Ä‰∏™Êõø‰ª£ÊñπÊ°à", done: false }
          ],
          hint: ""
        },
        {
          id: "comm-1",
          order: 4,
          mode: "comm",
          title: "Comm 1",
          duration: 25,
          intent: "ËøõË°åÈ´ò‰ª∑ÂÄºÊ≤üÈÄöÔºåËÄåÈùû‰ø°ÊÅØÂ†ÜÁßØ„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "ÈÄâ 1 ‰∏™ÂÖ≥ÈîÆÂÖ≥Á≥ªÂØπË±°", done: false },
            { text: "ËæìÂá∫‰∏ÄÊ¨°Êúâ‰ª∑ÂÄºËß¶ËææÔºàÊú∫‰ºö/ËµÑÊ∫ê/ÂèçÈ¶àÔºâ", done: false },
            { text: "ËÆ∞ÂΩïÂêéÁª≠Âä®‰ΩúÂíåÊà™Ê≠¢Êó•Êúü", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-2",
          order: 5,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ2",
          duration: 90,
          intent: "ÂÆåÊàêÊ¨°Á∫ßÊ†∏ÂøÉ‰ªªÂä°ÔºåÂáèÂ∞ë‰ªªÂä°ÂÄ∫„ÄÇ",
          reflection: "",
          remainingSeconds: 90 * 60,
          todos: [
            { text: "Êé®ËøõÊ¨°‰∫ßÂá∫Âπ∂ÂΩ¢ÊàêÂèØ‰∫§‰ªòÁªìÊûú", done: false },
            { text: "ÂØπÊµÅÁ®ãËøõË°å 1 Ê¨°ÂæÆ‰ºòÂåñ", done: false },
            { text: "Ê≤âÊ∑ÄÂèØÂ§çÁî®Ê®°ÊùøÊàñÊ£ÄÊü•Âçï", done: false }
          ],
          hint: ""
        },
        {
          id: "work-inbox",
          order: 6,
          mode: "work",
          title: "Work Inbox",
          duration: 30,
          intent: "ÈõÜ‰∏≠Â§ÑÁêÜÁ¢é‰ªªÂä°ÔºåÈÅøÂÖç‰æµËöÄÊ∑±Â∫¶Êó∂Èó¥„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "Áªü‰∏ÄÂ§ÑÁêÜÁü≠ÂõûÂ§ç‰∏é‰∏¥Êó∂ËØ∑Ê±Ç", done: false },
            { text: "Âà§Êñ≠ÂèØÂà†Èô§/ÂèØÂßîÊ¥æ/ÂèØÂª∂Êúü‰∫ãÈ°π", done: false },
            { text: "ÊääÈúÄË¶ÅÊ∑±Â∫¶ÁöÑ‰∫ãÈ°πÁßªÂÖ•ÊòéÊó•ÈòüÂàó", done: false }
          ],
          hint: ""
        },
        {
          id: "comm-2",
          order: 7,
          mode: "comm",
          title: "Comm 2",
          duration: 25,
          intent: "ÂÅö‰∏ÄÊ¨°ÂÖ≥Á≥ªÊ∑±ÂåñÂä®‰ΩúÔºåÂΩ¢ÊàêÈïøÊúüÂ§çÂà©„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "Â§çÁõò Comm 1 ÊòØÂê¶‰∫ßÁîü‰ª∑ÂÄº‰∫§Êç¢", done: false },
            { text: "ÂèëÂá∫ 1 Êù°È´òË¥®ÈáèË∑üËøõ‰ø°ÊÅØ", done: false },
            { text: "Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ‰∏é‰∏ã‰∏ÄÊ¨°Ëß¶ËææÊó∂Èó¥", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-3",
          order: 8,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ3",
          duration: 60,
          intent: "Â≠¶‰π†Âπ∂ÂçáÁ∫ßÁ≥ªÁªüËÉΩÂäõÔºåÂΩ¢Êàê‰∏≠ÈïøÊúüÊî∂Áõä„ÄÇ",
          reflection: "",
          remainingSeconds: 60 * 60,
          todos: [
            { text: "Â≠¶‰π†Âπ∂ËÆ≤Ëß£‰∏Ä‰∏™ÂÖ≥ÈîÆÊ¶ÇÂøµ/Ê®°Âûã", done: false },
            { text: "ÊääÊ¶ÇÂøµÂÜôÂÖ•Ëá™Â∑±ÁöÑÊµÅÁ®ãÁ≥ªÁªü", done: false },
            { text: "ÂÆö‰πâÊòéÂ§©ÂèØÈ™åËØÅÁöÑÂ∫îÁî®Âú∫ÊôØ", done: false }
          ],
          hint: ""
        },
        {
          id: "work-end",
          order: 9,
          mode: "work",
          title: "Work ÁªìÊùü‰∫§Êé•",
          duration: 20,
          intent: "ÂÆåÊàê‰∫§Êé•‰∏éÈó≠ÁéØÔºåÈôç‰ΩéÊòéÊó•ÂêØÂä®ÊàêÊú¨„ÄÇ",
          reflection: "",
          remainingSeconds: 20 * 60,
          todos: [
            { text: "Êõ¥Êñ∞Ë¥¶Êú¨/ÊåáÊ†áÂπ∂ËÆ∞ÂΩïÂÖ≥ÈîÆÊï∞ÊçÆ", done: false },
            { text: "ÂÜô‰∏ãÊòéÊó•ÂêØÂä®Ê∏ÖÂçïÔºàÂâç 3 È°πÔºâ", done: false },
            { text: "ÂàóÂá∫ 1 ‰∏™Á≥ªÁªü‰ºòÂåñÁÇπ", done: false }
          ],
          hint: ""
        },
        {
          id: "bedtime",
          order: 10,
          mode: "sleep",
          title: "Sleep ÂÖ•Áù°",
          duration: 30,
          intent: "ÈÄöËøáÁ®≥ÂÆöÂÖ•Áù°ÊµÅÁ®ãÈôç‰ΩéÊ¨°Êó•Ê≥¢Âä®„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "ËøúÁ¶ªÊâãÊú∫‰∏éÂº∫Âà∫ÊøÄÂÜÖÂÆπ 30 ÂàÜÈíü", done: false },
            { text: "ÁÆÄÂçïÊï¥ÁêÜÁéØÂ¢ÉÂπ∂ÂÆåÊàêÊ¥óÊº±", done: false },
            { text: "ÂëºÂê∏ÊîæÊùæ 3 ÂàÜÈíüÂêéÂÖ•Áù°", done: false }
          ],
          hint: "Sleep Ê®°ÂùóÈªòËÆ§Âè™ÂÅöÊâßË°å‰∏éÁîüÁêÜÂ§ç‰ΩçÔºåÈùûÂ§çÊùÇÂèçÊÄù„ÄÇ"
        }
      ],
      dashboard: {
        activeDomain: "health",
        domains: {
          health: {
            name: "Health",
            color: "#9d3d2f",
            fqas: [
              { question: "‰ªäÂ§©Ë∫´‰ΩìÊúâÂäõ„ÄÅÂ§¥ËÑëÊ∏ÖÈÜí„ÄÅÊÉÖÁª™Á®≥ÂÆöÂêóÔºü", answer: "", expanded: false }
            ],
            principles: [
              "‰ºòÂÖàÁ∫ßÂõ∫ÂÆöÔºöÁù°Áú† > ËøêÂä® > ÊîæÊùæ > Â≠¶‰π† > Â∑•‰Ωú",
              "‰ºòÂÖà‰øÆÂ§çÊ≥¢Âä®Ê∫êÔºå‰∏çÂ∏¶ÁùÄÈÄèÊîØÂÅöÂÜ≥Á≠ñ",
              "ÊØèÊó•ÊúÄÂ∞ë‰∏ÄÊ¨°‰∏ªÂä®ÊÅ¢Â§çÔºàÂëºÂê∏/Êï£Ê≠•/Êãâ‰º∏Ôºâ"
            ],
            sops: [
              { text: "Áù°Áú†Êó∂Èïø ‚â• 7.5h", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ËøêÂä® 30-60 ÂàÜÈíü", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "12:00-20:00 ËøõÈ£üÁ™óÂè£", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          cognition: {
            name: "Cognition",
            color: "#205295",
            fqas: [
              { question: "ÊàëÊòØÂê¶Âú®ÊûÑÂª∫‰∏çÊñ≠ÂçáÁ∫ßÁöÑÂ§ßËÑëÊìç‰ΩúÁ≥ªÁªüÔºü", answer: "", expanded: false }
            ],
            principles: [
              "ÂÖàÂÆö‰πâÁõÆÊ†áÂíåÁ∫¶ÊùüÔºåÂÜçÂèëÊï£‰∏éÂõûÂΩí",
              "ÊâæÂÖ≥ÈîÆÂèòÈáèÔºåÈÅøÂÖç‰ø°ÊÅØËøáËΩΩ",
              "ËæìÂá∫ÊØîËæìÂÖ•Êõ¥ÈáçË¶ÅÔºöÂ≠¶ÂÆåË¶ÅËÉΩËÆ≤ÊòéÁôΩ"
            ],
            sops: [
              { text: "ÂÆåÊàê 1 Ê¨°ÁªìÊûÑÂåñÂ§çÁõò", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂÜôÂá∫ 1 ‰∏™ÂèØÂ§çÁî®ÂÜ≥Á≠ñÊ®°Êùø", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂΩìÂ§©Ê¶ÇÂøµËÆ≤Ëß£ 10 ÂàÜÈíü", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          relationship: {
            name: "Relationship",
            color: "#0f766e",
            fqas: [
              { question: "‰ªäÂ§©ÊàëÊòØÂê¶ÂØπ‰∏Ä‰ΩçÂÖ≥ÈîÆÂÖ≥Á≥ªÂÅö‰∫ÜÈ´òË¥®ÈáèËÅîÁ≥ªÔºü", answer: "", expanded: false }
            ],
            principles: [
              "ÂÖàÊèê‰æõ‰ª∑ÂÄºÔºåÂÜçÊèêÂá∫ËØ∑Ê±Ç",
              "ÂÖ≥Á≥ªÁª¥Êä§Ë¶ÅÂèØËøΩË∏™ÔºöËÆ∞ÂΩï -> ËøΩË∏™ -> Âä†Ê∑±",
              "Ê≤üÈÄöËøΩÊ±ÇÊ∏ÖÊô∞‰∏éÈïøÊúü‰ø°‰ªªÔºå‰∏çËøΩÊ±ÇÁü≠ÊúüÂ•ΩÊÑü"
            ],
            sops: [
              { text: "È´òË¥®ÈáèËß¶Ëææ >= 1 ‰∫∫", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "Êõ¥Êñ∞ÂÖ≥Á≥ªË∑üËøõËÆ∞ÂΩï", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "Êé®Âä® 1 Ê¨°ÂèåÂêëÂêà‰ΩúÊú∫‰ºö", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          wealth: {
            name: "Wealth",
            color: "#8a6f43",
            fqas: [
              { question: "ÊàëÊòØÂê¶Âú®ÂÅöÈ¢ÑÁÆóÂÖÖË∂≥‰∏îËÉΩÊèêÂçáËá™Áî±Â∫¶ÁöÑ‰∫ãÔºü", answer: "", expanded: false }
            ],
            principles: [
              "Ê∏ÖÊô∞ÊÄùËÄÉÂÖà‰∫éË°åÂä®ÔºåÈÅøÂÖçÂÜ≤Âä®ÊäïÂÖ•",
              "‰∏çÂÅöÊó∂Èó¥ÊàñËµÑÈáëÈ¢ÑÁÆó‰∏çË∂≥ÁöÑÈ°πÁõÆ",
              "Áé∞ÈáëÊµÅ„ÄÅÂÆâÂÖ®Âû´„ÄÅÈïøÊúüÁßØÁ¥Ø‰∏âËÄÖÂπ∂Èáç"
            ],
            sops: [
              { text: "ÂΩìÊúàÁé∞ÈáëÊµÅ‰∏∫Ê≠£", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂÇ®ËìÑÁéáËææÂà∞ÁõÆÊ†áÂå∫Èó¥", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ËµÑ‰∫ßÈÖçÁΩÆÊåâËßÑÂàôÂ§çÁõò", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          }
        }
      }
    };

    let state = null;
    let timerInterval = null;
    let timerModuleId = null;

    function clone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return clone(defaultState);
      }
      try {
        const saved = JSON.parse(raw);
        return mergeState(saved);
      } catch (error) {
        return clone(defaultState);
      }
    }

    function mergeState(saved) {
      const base = clone(defaultState);
      if (!saved || typeof saved !== "object") {
        return base;
      }

      if (saved.layer === "sop" || saved.layer === "dashboard") {
        base.layer = saved.layer;
      }
      if (MODE_LABEL[saved.modeFilter]) {
        base.modeFilter = saved.modeFilter;
      }
      if (typeof saved.activeModuleId === "string") {
        base.activeModuleId = saved.activeModuleId;
      }
      if (Number.isFinite(saved.dailyBudgetMinutes) && saved.dailyBudgetMinutes > 0) {
        base.dailyBudgetMinutes = Math.round(saved.dailyBudgetMinutes);
      }

      if (Array.isArray(saved.modules)) {
        const savedMap = new Map(saved.modules.map((m) => [m.id, m]));
        base.modules = base.modules.map((m) => {
          const s = savedMap.get(m.id);
          if (!s || typeof s !== "object") {
            return {
              ...m,
              todos: m.todos.map((todo) => normalizeTodo(todo))
            };
          }
          const todos = Array.isArray(s.todos) && s.todos.length
            ? s.todos.map((todo) => normalizeTodo(todo))
            : m.todos.map((todo) => normalizeTodo(todo));
          const legacyReflection = typeof s.reflection === "string" ? s.reflection.trim() : "";
          if (legacyReflection) {
            todos.push({
              text: `ReflectionÔºàÂèØÈÄâÔºâÔºö${legacyReflection}`,
              done: false,
              subs: []
            });
          }
          return {
            ...m,
            title: typeof s.title === "string" ? s.title : m.title,
            duration: Number.isFinite(s.duration) && s.duration > 0 ? s.duration : m.duration,
            intent: typeof s.intent === "string" ? s.intent : m.intent,
            hint: typeof s.hint === "string" ? s.hint : m.hint,
            remainingSeconds: Number.isFinite(s.remainingSeconds) && s.remainingSeconds >= 0
              ? Math.floor(s.remainingSeconds)
              : m.duration * 60,
            todos
          };
        });
      }

      if (saved.dashboard && typeof saved.dashboard === "object") {
        const savedDashboard = saved.dashboard;
        if (DOMAIN_ORDER.includes(savedDashboard.activeDomain)) {
          base.dashboard.activeDomain = savedDashboard.activeDomain;
        }
        if (savedDashboard.domains && typeof savedDashboard.domains === "object") {
          DOMAIN_ORDER.forEach((key) => {
            const domainBase = base.dashboard.domains[key];
            const domainSaved = savedDashboard.domains[key];
            if (!domainSaved || typeof domainSaved !== "object") {
              return;
            }
            if (Array.isArray(domainSaved.principles) && domainSaved.principles.length) {
              domainBase.principles = domainSaved.principles.map((line) =>
                typeof line === "string" ? line : ""
              );
            }

            if (Array.isArray(domainSaved.fqas) && domainSaved.fqas.length) {
              domainBase.fqas = domainSaved.fqas.map((item) => normalizeFqa(item));
            } else {
              const legacyQuestion = typeof domainSaved.question === "string"
                ? domainSaved.question
                : (domainBase.fqas[0]?.question || "");
              domainBase.fqas = [{ question: legacyQuestion, answer: "", expanded: false }];
            }

            if (Array.isArray(domainSaved.sops) && domainSaved.sops.length) {
              domainBase.sops = domainSaved.sops.map((item) => normalizeSop(item));
            } else if (Array.isArray(domainSaved.kpis) && domainSaved.kpis.length) {
              domainBase.sops = domainSaved.kpis.map((item) => normalizeSop(item));
            }
          });
        }
      }

      return base;
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function normalizeTodo(todo) {
      const normalized = {
        text: typeof todo?.text === "string" ? todo.text : "",
        done: Boolean(todo?.done),
        subs: []
      };
      if (Array.isArray(todo?.subs)) {
        normalized.subs = todo.subs.map((sub) => ({
          text: typeof sub?.text === "string" ? sub.text : "",
          done: Boolean(sub?.done)
        }));
      }
      return normalized;
    }

    function normalizeFqa(item) {
      return {
        question: typeof item?.question === "string" ? item.question : "",
        answer: typeof item?.answer === "string" ? item.answer : "",
        expanded: Boolean(item?.expanded)
      };
    }

    function normalizeSop(item) {
      return {
        text: typeof item?.text === "string" ? item.text : "",
        done: Boolean(item?.done),
        fileName: typeof item?.fileName === "string" ? item.fileName : "",
        fileType: typeof item?.fileType === "string" ? item.fileType : "",
        fileData: typeof item?.fileData === "string" ? item.fileData : ""
      };
    }

    function wireAutoGrow(textarea, minHeight = 26) {
      if (!textarea) {
        return;
      }
      const fit = () => {
        textarea.style.height = "auto";
        textarea.style.height = `${Math.max(textarea.scrollHeight, minHeight)}px`;
      };
      fit();
      textarea.addEventListener("input", fit);
    }

    function percent(value) {
      return `${Math.max(0, Math.min(100, Math.round(value)))}%`;
    }

    function moduleProgress(module) {
      if (!module.todos.length) {
        return 0;
      }
      let totalCount = 0;
      let doneCount = 0;
      module.todos.forEach((todo) => {
        totalCount += 1;
        if (todo.done) {
          doneCount += 1;
        }
        if (Array.isArray(todo.subs)) {
          totalCount += todo.subs.length;
          doneCount += todo.subs.filter((sub) => sub.done).length;
        }
      });
      if (!totalCount) {
        return 0;
      }
      return (doneCount / totalCount) * 100;
    }

    function getVisibleModules() {
      return state.modules.filter((m) => m.mode === state.modeFilter);
    }

    function getActiveModule() {
      return state.modules.find((m) => m.id === state.activeModuleId) || null;
    }

    function ensureActiveModuleVisible() {
      const visible = getVisibleModules();
      if (!visible.length) {
        state.activeModuleId = "";
        return;
      }
      if (!visible.some((m) => m.id === state.activeModuleId)) {
        state.activeModuleId = visible[0].id;
      }
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60).toString().padStart(2, "0");
      const sec = Math.floor(seconds % 60).toString().padStart(2, "0");
      return `${min}:${sec}`;
    }

    function switchLayer(layer) {
      state.layer = layer;
      saveState();
      renderLayer();
    }

    function setModeFilter(mode) {
      state.modeFilter = mode;
      ensureActiveModuleVisible();
      stopTimer();
      saveState();
      renderSop();
    }

    function selectModule(moduleId) {
      if (state.activeModuleId === moduleId) {
        return;
      }
      state.activeModuleId = moduleId;
      stopTimer();
      saveState();
      renderSop();
    }

    function renderLayer() {
      const sop = state.layer === "sop";
      document.getElementById("layerSopBtn").classList.toggle("active", sop);
      document.getElementById("layerDashboardBtn").classList.toggle("active", !sop);
      document.getElementById("sopView").classList.toggle("active", sop);
      document.getElementById("dashboardView").classList.toggle("active", !sop);
      document.title = sop ? "POS Console V2 - SOP ÊâßË°åÂ±Ç" : "POS Console V2 - Dashboard ÂÜ≥Á≠ñÂ±Ç";

      if (sop) {
        renderSop();
      } else {
        renderDashboard();
      }
    }

    function renderSop() {
      renderModeFilter();
      renderModuleList();
      renderModuleDetail();
    }

    function renderModeFilter() {
      const container = document.getElementById("modeFilter");
      container.innerHTML = "";
      ["work", "comm", "sleep"].forEach((mode) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `chip ${state.modeFilter === mode ? "active" : ""}`;
        btn.textContent = MODE_LABEL[mode];
        btn.onclick = () => setModeFilter(mode);
        container.appendChild(btn);
      });
    }

    function renderModuleList() {
      ensureActiveModuleVisible();
      const list = document.getElementById("moduleList");
      list.innerHTML = "";
      const modules = getVisibleModules();

      if (!modules.length) {
        const empty = document.createElement("p");
        empty.className = "empty-note";
        empty.textContent = "ÂΩìÂâçÁ≠õÈÄâ‰∏ãÊ≤°ÊúâÊ®°Âùó„ÄÇ";
        list.appendChild(empty);
        return;
      }

      modules.forEach((module) => {
        const card = document.createElement("article");
        card.className = `module-card ${module.id === state.activeModuleId ? "active" : ""}`;
        card.onclick = () => selectModule(module.id);

        const index = document.createElement("div");
        index.className = `module-index ${MODE_COLOR_CLASS[module.mode]}`;
        index.textContent = module.order;

        const info = document.createElement("div");
        const title = document.createElement("h3");
        title.className = "module-name";
        title.textContent = module.title;

        const meta = document.createElement("div");
        meta.className = "module-meta";
        const progressNum = Math.round(moduleProgress(module));
        meta.innerHTML = `
          <span>Mode: ${MODE_LABEL[module.mode]}</span>
          <span>${module.duration} ÂàÜÈíü</span>
          <span>${progressNum}% ÂÆåÊàê</span>
        `;

        const progressWrap = document.createElement("div");
        progressWrap.className = "module-progress";
        const fill = document.createElement("div");
        fill.className = "module-progress-fill";
        fill.style.width = percent(moduleProgress(module));
        progressWrap.appendChild(fill);

        info.appendChild(title);
        info.appendChild(meta);
        info.appendChild(progressWrap);

        card.appendChild(index);
        card.appendChild(info);
        list.appendChild(card);
      });
    }

    function renderModuleDetail() {
      const module = getActiveModule();
      const container = document.getElementById("moduleDetail");
      container.innerHTML = "";

      if (!module) {
        container.innerHTML = '<p class="empty-note">ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê®°Âùó„ÄÇ</p>';
        return;
      }

      const runningThisModule = timerInterval && timerModuleId === module.id;

      const head = document.createElement("div");
      head.className = "detail-head";

      const left = document.createElement("div");
      const title = document.createElement("h2");
      title.className = "detail-title";
      title.textContent = module.title;
      const sub = document.createElement("p");
      sub.className = "detail-sub";
      sub.textContent = `${module.intent} | ${MODE_LABEL[module.mode]}`;
      left.appendChild(title);
      left.appendChild(sub);

      const timer = document.createElement("div");
      timer.className = "timer";
      const timerTop = document.createElement("div");
      timerTop.className = "timer-top";
      const clock = document.createElement("button");
      clock.type = "button";
      clock.id = "timerClock";
      clock.className = "timer-clock";
      clock.title = "ÁÇπÂáª‰øÆÊîπËÆ°Êó∂Êó∂ÈïøÔºàÂàÜÈíüÔºâ";
      clock.textContent = formatTime(module.remainingSeconds);
      clock.onclick = () => editModuleDuration(module.id);
      const timerActions = document.createElement("div");
      timerActions.className = "timer-actions";

      const runBtn = document.createElement("button");
      runBtn.type = "button";
      runBtn.className = "timer-btn primary";
      runBtn.textContent = runningThisModule ? "‚è∏" : "‚ñ∂";
      runBtn.onclick = toggleTimer;

      const resetBtn = document.createElement("button");
      resetBtn.type = "button";
      resetBtn.className = "timer-btn";
      resetBtn.textContent = "‚Ü∫";
      resetBtn.onclick = resetTimer;

      timerActions.appendChild(runBtn);
      timerActions.appendChild(resetBtn);

      const budgetMini = document.createElement("div");
      budgetMini.className = "budget-mini";
      const budgetTotal = document.createElement("span");
      budgetTotal.className = "budget-total";
      budgetTotal.textContent = `${state.dailyBudgetMinutes}`;
      const budgetSyncBtn = document.createElement("button");
      budgetSyncBtn.type = "button";
      budgetSyncBtn.className = "timer-mini-btn";
      budgetSyncBtn.title = "ÊåâËÆ°Êó∂ÊÄªÂíåÂêåÊ≠•ÊÄªÈ¢ÑÁÆó";
      budgetSyncBtn.textContent = "‚àë";
      budgetSyncBtn.onclick = syncDailyBudgetToModules;
      budgetMini.appendChild(budgetTotal);
      budgetMini.appendChild(budgetSyncBtn);

      timerTop.appendChild(clock);
      timerTop.appendChild(budgetMini);
      timer.appendChild(timerTop);
      timer.appendChild(timerActions);

      head.appendChild(left);
      head.appendChild(timer);

      const todoSection = document.createElement("section");
      todoSection.className = "section";
      const todoHead = document.createElement("div");
      todoHead.className = "section-head";
      const todoTitle = document.createElement("h3");
      todoTitle.className = "section-title";
      todoTitle.textContent = "SOP Todo ListÔºàÊîØÊåÅ‰∫åÁ∫ß checklistÔºâ";
      const addTodoBtn = document.createElement("button");
      addTodoBtn.type = "button";
      addTodoBtn.className = "section-action-btn";
      addTodoBtn.title = "Êñ∞Â¢ûÂæÖÂäû";
      addTodoBtn.textContent = "+";
      addTodoBtn.onclick = addTodo;
      todoHead.appendChild(todoTitle);
      todoHead.appendChild(addTodoBtn);
      todoSection.appendChild(todoHead);

      const todoList = document.createElement("div");
      todoList.className = "todo-list";

      module.todos.forEach((todo, idx) => {
        const node = document.createElement("div");
        node.className = "todo-node";

        const row = document.createElement("div");
        row.className = `todo-row ${todo.done ? "done" : ""} ${isReflectionTodo(todo) ? "reflection" : ""}`;

        const check = document.createElement("input");
        check.type = "checkbox";
        check.className = "todo-check";
        check.checked = todo.done;
        check.onchange = () => toggleTodo(idx);

        const input = document.createElement("textarea");
        input.rows = 1;
        input.className = "todo-input";
        input.value = todo.text;
        input.placeholder = isReflectionTodo(todo) ? "ReflectionÔºàÂèØÈÄâÔºâ‚Ä¶" : "Â°´ÂÜôÂÖ∑‰ΩìÂä®‰Ωú‚Ä¶";
        input.onchange = (event) => updateTodoText(idx, event.target.value);
        wireAutoGrow(input, 26);

        const actions = document.createElement("div");
        actions.className = "todo-main-actions";
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÈ°π";
        addSubBtn.onclick = () => addSubTodo(idx);

        const reflectBtn = document.createElement("button");
        reflectBtn.type = "button";
        reflectBtn.className = "mini-action";
        reflectBtn.textContent = "üìù";
        reflectBtn.title = "Ê∑ªÂä†ÂèçÊÄù";
        reflectBtn.onclick = () => addReflectionSubTodo(idx);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§‰ªªÂä°";
        del.onclick = () => deleteTodo(idx);

        actions.appendChild(addSubBtn);
        actions.appendChild(reflectBtn);
        actions.appendChild(del);

        row.appendChild(check);
        row.appendChild(input);
        row.appendChild(actions);
        node.appendChild(row);

        const subList = document.createElement("div");
        subList.className = "sub-list";
        const subItems = Array.isArray(todo.subs) ? todo.subs : [];
        subItems.forEach((sub, subIdx) => {
          const subRow = document.createElement("div");
          subRow.className = `sub-row ${sub.done ? "done" : ""}`;

          const subCheck = document.createElement("input");
          subCheck.type = "checkbox";
          subCheck.className = "todo-check";
          subCheck.checked = sub.done;
          subCheck.onchange = () => toggleSubTodo(idx, subIdx);

          const subInput = document.createElement("textarea");
          subInput.rows = 1;
          subInput.className = "todo-input";
          subInput.value = sub.text;
          subInput.placeholder = "‰∫åÁ∫ß checklist È°π‚Ä¶";
          subInput.onchange = (event) => updateSubTodoText(idx, subIdx, event.target.value);
          wireAutoGrow(subInput, 26);

          const subDel = document.createElement("button");
          subDel.type = "button";
          subDel.className = "todo-del";
          subDel.textContent = "üóë";
          subDel.title = "Âà†Èô§Â≠êÈ°π";
          subDel.onclick = () => deleteSubTodo(idx, subIdx);

          subRow.appendChild(subCheck);
          subRow.appendChild(subInput);
          subRow.appendChild(subDel);
          subList.appendChild(subRow);
        });

        if (subItems.length) {
          node.appendChild(subList);
        }

        todoList.appendChild(node);
      });

      todoSection.appendChild(todoList);
      const reflectHint = document.createElement("p");
      reflectHint.className = "hint";
      reflectHint.textContent = "ÊØèÊù° checklist ÂèØÁî®‚Äúüìù‚ÄùÊ∑ªÂä†ÂèçÊÄùÂ≠êÈ°πÔºõ‚Äú‚Ü≥‚ÄùÁî®‰∫éÊãÜÂàÜÊâßË°åÁªÜÈ°π„ÄÇ";
      todoSection.appendChild(reflectHint);

      container.appendChild(head);
      container.appendChild(todoSection);
    }

    function getTotalDurationMinutes() {
      return state.modules.reduce((sum, module) => sum + module.duration, 0);
    }

    function setModuleDuration(moduleId, minutes) {
      if (!Number.isFinite(minutes) || minutes <= 0) {
        return;
      }
      const module = state.modules.find((item) => item.id === moduleId);
      if (!module) {
        return;
      }
      stopTimer();
      const intMinutes = Math.round(minutes);
      module.duration = intMinutes;
      module.remainingSeconds = intMinutes * 60;
      saveState();
      renderSop();
    }

    function editModuleDuration(moduleId) {
      const module = state.modules.find((item) => item.id === moduleId);
      if (!module) {
        return;
      }
      const input = window.prompt("ËÆæÁΩÆËØ•Ê®°ÂùóËÆ°Êó∂ÔºàÂàÜÈíüÔºâ", String(module.duration));
      if (input === null) {
        return;
      }
      const minutes = Number(input);
      if (!Number.isFinite(minutes) || minutes <= 0) {
        alert("ËØ∑ËæìÂÖ•Â§ß‰∫é 0 ÁöÑÊï∞Â≠ó„ÄÇ");
        return;
      }
      setModuleDuration(moduleId, minutes);
    }

    function syncDailyBudgetToModules() {
      state.dailyBudgetMinutes = getTotalDurationMinutes();
      saveState();
      renderModuleDetail();
    }

    function toggleTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      module.todos[todoIndex].done = !module.todos[todoIndex].done;
      saveState();
      renderSop();
    }

    function updateTodoText(todoIndex, text) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      module.todos[todoIndex].text = text;
      saveState();
    }

    function deleteTodo(todoIndex) {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      module.todos.splice(todoIndex, 1);
      saveState();
      renderSop();
    }

    function addTodo() {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      module.todos.push({ text: "", done: false, subs: [] });
      saveState();
      renderSop();
    }

    function addSubTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      if (!Array.isArray(module.todos[todoIndex].subs)) {
        module.todos[todoIndex].subs = [];
      }
      module.todos[todoIndex].subs.push({ text: "", done: false });
      saveState();
      renderSop();
    }

    function addReflectionSubTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      if (!Array.isArray(module.todos[todoIndex].subs)) {
        module.todos[todoIndex].subs = [];
      }
      module.todos[todoIndex].subs.push({ text: "ReflectionÔºàÂèØÈÄâÔºâ", done: false });
      saveState();
      renderSop();
    }

    function toggleSubTodo(todoIndex, subIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs[subIndex].done = !module.todos[todoIndex].subs[subIndex].done;
      saveState();
      renderSop();
    }

    function updateSubTodoText(todoIndex, subIndex, text) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs[subIndex].text = text;
      saveState();
    }

    function deleteSubTodo(todoIndex, subIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs.splice(subIndex, 1);
      saveState();
      renderSop();
    }

    function isReflectionTodo(todo) {
      if (!todo || typeof todo.text !== "string") {
        return false;
      }
      return todo.text.trim().toLowerCase().startsWith("reflection");
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerModuleId = null;
    }

    function toggleTimer() {
      const module = getActiveModule();
      if (!module) {
        return;
      }

      if (timerInterval && timerModuleId === module.id) {
        stopTimer();
        saveState();
        renderModuleDetail();
        return;
      }

      stopTimer();
      timerModuleId = module.id;
      timerInterval = setInterval(() => {
        const active = state.modules.find((m) => m.id === timerModuleId);
        if (!active) {
          stopTimer();
          return;
        }
        if (active.remainingSeconds > 0) {
          active.remainingSeconds -= 1;
          saveState();
          if (state.activeModuleId === active.id) {
            const clock = document.getElementById("timerClock");
            if (clock) {
              clock.textContent = formatTime(active.remainingSeconds);
            }
          }
        }
        if (active.remainingSeconds <= 0) {
          active.remainingSeconds = 0;
          saveState();
          stopTimer();
          renderModuleDetail();
          alert(`Ê®°Âùó„Äå${active.title}„ÄçËÆ°Êó∂ÁªìÊùü„ÄÇ`);
        }
      }, 1000);

      renderModuleDetail();
    }

    function resetTimer() {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      stopTimer();
      module.remainingSeconds = module.duration * 60;
      saveState();
      renderModuleDetail();
    }

    function renderDashboard() {
      const grid = document.getElementById("domainGrid");
      if (!grid) {
        return;
      }
      grid.innerHTML = "";
      const pick = document.createElement("div");
      pick.className = "domain-pick";
      DOMAIN_ORDER.forEach((key) => {
        const domain = state.dashboard.domains[key];
        if (!domain) {
          return;
        }
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `domain-pick-btn ${state.dashboard.activeDomain === key ? "active" : ""}`;
        btn.textContent = domain.name;
        btn.onclick = () => selectDomain(key);
        pick.appendChild(btn);
      });

      const activeKey = DOMAIN_ORDER.includes(state.dashboard.activeDomain)
        ? state.dashboard.activeDomain
        : DOMAIN_ORDER[0];
      const activeDomain = state.dashboard.domains[activeKey];
      if (!activeDomain) {
        grid.appendChild(pick);
        return;
      }

      const focus = document.createElement("div");
      focus.className = "domain-focus";

      const card = document.createElement("article");
      card.className = "domain-card";
      card.style.borderLeft = `4px solid ${activeDomain.color}`;

      const head = document.createElement("div");
      head.className = "domain-head";
      const name = document.createElement("h3");
      name.className = "domain-name";
      name.style.color = activeDomain.color;
      name.textContent = activeDomain.name;
      head.appendChild(name);

      const content = document.createElement("div");
      content.className = "domain-content";

      const fqaBlock = document.createElement("div");
      fqaBlock.className = "detail-block";
      const fqaLabelRow = document.createElement("div");
      fqaLabelRow.className = "label-row";
      fqaLabelRow.innerHTML = '<p class="label">FQA</p>';
      const addFqaBtn = document.createElement("button");
      addFqaBtn.type = "button";
      addFqaBtn.className = "icon-round-btn";
      addFqaBtn.textContent = "+";
      addFqaBtn.title = "Êñ∞Â¢û FQA";
      addFqaBtn.onclick = () => addFqa(activeKey);
      fqaLabelRow.appendChild(addFqaBtn);
      fqaBlock.appendChild(fqaLabelRow);

      const fqaList = document.createElement("div");
      fqaList.className = "list-edit";
      activeDomain.fqas.forEach((item, idx) => {
        const fqaItem = document.createElement("div");
        fqaItem.className = "fqa-item";
        const fqaHead = document.createElement("div");
        fqaHead.className = "fqa-item-head";
        const qArea = document.createElement("textarea");
        qArea.className = "text-input";
        qArea.rows = 1;
        qArea.placeholder = "ÈóÆÈ¢ò...";
        qArea.value = item.question;
        qArea.onchange = (event) => updateFqaQuestion(activeKey, idx, event.target.value);
        wireAutoGrow(qArea, 34);
        const actions = document.createElement("div");
        actions.className = "fqa-actions";
        const answerBtn = document.createElement("button");
        answerBtn.type = "button";
        answerBtn.className = "icon-round-btn";
        answerBtn.textContent = "üí¨";
        answerBtn.title = "ÂõûÁ≠î";
        answerBtn.onclick = () => toggleFqaAnswer(activeKey, idx);
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "todo-del";
        delBtn.textContent = "üóë";
        delBtn.title = "Âà†Èô§ FQA";
        delBtn.onclick = () => deleteFqa(activeKey, idx);
        actions.appendChild(answerBtn);
        actions.appendChild(delBtn);
        fqaHead.appendChild(qArea);
        fqaHead.appendChild(actions);
        fqaItem.appendChild(fqaHead);

        if (item.expanded || item.answer) {
          const answerWrap = document.createElement("div");
          answerWrap.className = "fqa-answer";
          const answerArea = document.createElement("textarea");
          answerArea.className = "text-input";
          answerArea.rows = 1;
          answerArea.placeholder = "ÂõûÁ≠î...";
          answerArea.value = item.answer;
          answerArea.onchange = (event) => updateFqaAnswer(activeKey, idx, event.target.value);
          wireAutoGrow(answerArea, 34);
          answerWrap.appendChild(answerArea);
          fqaItem.appendChild(answerWrap);
        }

        fqaList.appendChild(fqaItem);
      });
      fqaBlock.appendChild(fqaList);

      const principlesBlock = document.createElement("div");
      principlesBlock.className = "detail-block";
      const pLabelRow = document.createElement("div");
      pLabelRow.className = "label-row";
      pLabelRow.innerHTML = '<p class="label">Principles</p>';
      const addPrincipleBtn = document.createElement("button");
      addPrincipleBtn.type = "button";
      addPrincipleBtn.className = "icon-round-btn";
      addPrincipleBtn.textContent = "+";
      addPrincipleBtn.title = "Êñ∞Â¢û Principle";
      addPrincipleBtn.onclick = () => addPrinciple(activeKey);
      pLabelRow.appendChild(addPrincipleBtn);
      principlesBlock.appendChild(pLabelRow);
      const principlesList = document.createElement("div");
      principlesList.className = "list-edit";
      activeDomain.principles.forEach((line, idx) => {
        const row = document.createElement("div");
        row.className = "line-edit";
        const input = document.createElement("textarea");
        input.className = "text-input";
        input.rows = 1;
        input.value = line;
        input.onchange = (event) => updatePrinciple(activeKey, idx, event.target.value);
        wireAutoGrow(input, 34);
        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§ Principle";
        del.onclick = () => deletePrinciple(activeKey, idx);
        row.appendChild(input);
        row.appendChild(del);
        principlesList.appendChild(row);
      });
      principlesBlock.appendChild(principlesList);

      const sopBlock = document.createElement("div");
      sopBlock.className = "detail-block";
      const sLabelRow = document.createElement("div");
      sLabelRow.className = "label-row";
      sLabelRow.innerHTML = '<p class="label">SOP‰∏éÊ®°Áâà</p>';
      const addSopBtn = document.createElement("button");
      addSopBtn.type = "button";
      addSopBtn.className = "icon-round-btn";
      addSopBtn.textContent = "+";
      addSopBtn.title = "Êñ∞Â¢û SOP/Ê®°Áâà";
      addSopBtn.onclick = () => addSop(activeKey);
      sLabelRow.appendChild(addSopBtn);
      sopBlock.appendChild(sLabelRow);

      const sopList = document.createElement("div");
      sopList.className = "list-edit";
      activeDomain.sops.forEach((item, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "fqa-item";
        const row = document.createElement("div");
        row.className = "sop-row";
        const check = document.createElement("input");
        check.type = "checkbox";
        check.className = "todo-check";
        check.checked = item.done;
        check.onchange = () => toggleSop(activeKey, idx);
        const text = document.createElement("textarea");
        text.className = "text-input";
        text.rows = 1;
        text.placeholder = "Â°´ÂÜô SOP ÊàñÊ®°ÁâàËØ¥Êòé...";
        text.value = item.text;
        text.onchange = (event) => updateSopText(activeKey, idx, event.target.value);
        wireAutoGrow(text, 34);
        const actions = document.createElement("div");
        actions.className = "fqa-actions";
        const attachBtn = document.createElement("button");
        attachBtn.type = "button";
        attachBtn.className = "icon-round-btn";
        attachBtn.textContent = "üìé";
        attachBtn.title = "Ê∑ªÂä†Êñá‰ª∂";
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.style.display = "none";
        fileInput.onchange = (event) => handleSopFileSelect(activeKey, idx, event);
        attachBtn.onclick = () => fileInput.click();
        const downBtn = document.createElement("button");
        downBtn.type = "button";
        downBtn.className = "icon-round-btn";
        downBtn.textContent = "‚§ì";
        downBtn.title = "‰∏ãËΩΩÊñá‰ª∂";
        downBtn.disabled = !item.fileData;
        downBtn.onclick = () => downloadSopFile(activeKey, idx);
        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§Êù°ÁõÆ";
        del.onclick = () => deleteSop(activeKey, idx);
        actions.appendChild(attachBtn);
        actions.appendChild(downBtn);
        actions.appendChild(del);
        row.appendChild(check);
        row.appendChild(text);
        row.appendChild(actions);
        wrap.appendChild(row);
        wrap.appendChild(fileInput);
        if (item.fileName) {
          const fileMeta = document.createElement("div");
          fileMeta.className = "sop-file";
          fileMeta.textContent = `Êñá‰ª∂Ôºö${item.fileName}`;
          wrap.appendChild(fileMeta);
        }
        sopList.appendChild(wrap);
      });
      sopBlock.appendChild(sopList);

      content.appendChild(fqaBlock);
      content.appendChild(principlesBlock);
      content.appendChild(sopBlock);

      card.appendChild(head);
      card.appendChild(content);
      focus.appendChild(card);

      grid.appendChild(pick);
      grid.appendChild(focus);
    }

    function selectDomain(key) {
      if (!DOMAIN_ORDER.includes(key)) {
        return;
      }
      state.dashboard.activeDomain = key;
      saveState();
      renderDashboard();
    }

    function addFqa(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.fqas.push({ question: "", answer: "", expanded: false });
      saveState();
      renderDashboard();
    }

    function updateFqaQuestion(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].question = value;
      saveState();
    }

    function updateFqaAnswer(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].answer = value;
      saveState();
    }

    function toggleFqaAnswer(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].expanded = !domain.fqas[idx].expanded;
      saveState();
      renderDashboard();
    }

    function deleteFqa(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.fqas.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function addPrinciple(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.principles.push("");
      saveState();
      renderDashboard();
    }

    function updatePrinciple(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || typeof domain.principles[idx] !== "string") {
        return;
      }
      domain.principles[idx] = value;
      saveState();
    }

    function deletePrinciple(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.principles.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function addSop(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.sops.push({ text: "", done: false, fileName: "", fileType: "", fileData: "" });
      saveState();
      renderDashboard();
    }

    function updateSopText(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      domain.sops[idx].text = value;
      saveState();
    }

    function toggleSop(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      domain.sops[idx].done = !domain.sops[idx].done;
      saveState();
      renderDashboard();
    }

    function deleteSop(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.sops.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function handleSopFileSelect(key, idx, event) {
      const file = event.target.files?.[0];
      if (!file) {
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        alert("Êñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã© 2MB ‰ª•ÂÜÖÊñá‰ª∂„ÄÇ");
        event.target.value = "";
        return;
      }
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        event.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        domain.sops[idx].fileName = file.name;
        domain.sops[idx].fileType = file.type || "";
        domain.sops[idx].fileData = typeof reader.result === "string" ? reader.result : "";
        saveState();
        renderDashboard();
      };
      reader.readAsDataURL(file);
      event.target.value = "";
    }

    function downloadSopFile(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx] || !domain.sops[idx].fileData) {
        return;
      }
      const item = domain.sops[idx];
      const a = document.createElement("a");
      a.href = item.fileData;
      a.download = item.fileName || `sop-file-${idx + 1}`;
      a.click();
    }

    function exportData() {
      const now = new Date();
      const stamp = [
        now.getFullYear(),
        String(now.getMonth() + 1).padStart(2, "0"),
        String(now.getDate()).padStart(2, "0"),
        String(now.getHours()).padStart(2, "0"),
        String(now.getMinutes()).padStart(2, "0")
      ].join("");
      const csvEscape = (value) => {
        const str = value == null ? "" : String(value);
        return `"${str.replace(/"/g, "\"\"")}"`;
      };

      const rows = [];
      rows.push([
        "Section",
        "Category",
        "Group",
        "Item",
        "SubItem",
        "Status",
        "Value",
        "Extra"
      ]);

      rows.push(["Meta", "DailyBudgetMinutes", "", "", "", "", state.dailyBudgetMinutes, ""]);

      state.modules.forEach((module) => {
        rows.push([
          "SOP",
          "Module",
          module.title,
          "Timer",
          "",
          "",
          module.duration,
          `remaining=${module.remainingSeconds}`
        ]);

        module.todos.forEach((todo, todoIdx) => {
          rows.push([
            "SOP",
            "Todo",
            module.title,
            `${todoIdx + 1}`,
            "",
            todo.done ? "done" : "pending",
            todo.text,
            ""
          ]);
          (todo.subs || []).forEach((sub, subIdx) => {
            rows.push([
              "SOP",
              "SubTodo",
              module.title,
              `${todoIdx + 1}`,
              `${subIdx + 1}`,
              sub.done ? "done" : "pending",
              sub.text,
              ""
            ]);
          });
        });
      });

      DOMAIN_ORDER.forEach((key) => {
        const domain = state.dashboard.domains[key];
        if (!domain) {
          return;
        }
        (domain.fqas || []).forEach((item, idx) => {
          rows.push([
            "Dashboard",
            "FQA",
            domain.name,
            `${idx + 1}`,
            "Q",
            "",
            item.question,
            ""
          ]);
          rows.push([
            "Dashboard",
            "FQA",
            domain.name,
            `${idx + 1}`,
            "A",
            "",
            item.answer,
            ""
          ]);
        });

        (domain.principles || []).forEach((line, idx) => {
          rows.push([
            "Dashboard",
            "Principles",
            domain.name,
            `${idx + 1}`,
            "",
            "",
            line,
            ""
          ]);
        });

        (domain.sops || []).forEach((item, idx) => {
          rows.push([
            "Dashboard",
            "SOP‰∏éÊ®°Áâà",
            domain.name,
            `${idx + 1}`,
            "",
            item.done ? "done" : "pending",
            item.text,
            item.fileName || ""
          ]);
        });
      });

      const csv = "\ufeff" + rows.map((row) => row.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pos-console-export-${stamp}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener("beforeunload", () => {
      stopTimer();
    });

    function init() {
      state = loadState();
      ensureActiveModuleVisible();
      if (!DOMAIN_ORDER.includes(state.dashboard.activeDomain)) {
        state.dashboard.activeDomain = DOMAIN_ORDER[0];
      }
      renderLayer();
    }

    init();
  </script>
</body>
</html>
