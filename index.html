<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2f4858">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="POS Console">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <title>POS Console V2</title>
  <style>
    :root {
      --bg-base: #f4efe5;
      --bg-surface: #fffaf1;
      --bg-panel: #ffffff;
      --text-main: #1f2933;
      --text-sub: #52606d;
      --line: #e9dfce;
      --work: #9d3d2f;
      --comm: #0f766e;
      --sleep: #205295;
      --accent: #8a6f43;
      --ok: #2f855a;
      --danger: #c53030;
      --shadow-soft: 0 12px 30px rgba(58, 42, 22, 0.08);
      --shadow-card: 0 6px 14px rgba(58, 42, 22, 0.06);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --font-main: "Avenir Next", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      --font-display: "Iowan Old Style", "Songti SC", "STSong", serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      color: var(--text-main);
      background:
        radial-gradient(circle at 15% 10%, #f2d4b4 0%, transparent 30%),
        radial-gradient(circle at 90% 90%, #d8ebe6 0%, transparent 34%),
        linear-gradient(145deg, #f6f1e8, #f2ecdf);
      min-height: 100vh;
      padding: 24px;
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
      background: var(--bg-surface);
      border: 1px solid #eadfce;
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .topbar {
      padding: 12px 16px 10px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(120deg, rgba(157, 61, 47, 0.08), rgba(32, 82, 149, 0.08)),
        #fff9f0;
    }

    .title {
      margin: 0;
      font-family: var(--font-display);
      font-size: 22px;
      letter-spacing: 0.15px;
      font-weight: 700;
    }

    .purpose {
      margin: 3px 0 0;
      color: var(--text-sub);
      font-size: 12px;
      line-height: 1.35;
      max-width: 920px;
      opacity: 0.85;
    }

    .head-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .layer-switch {
      display: inline-flex;
      gap: 6px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 3px;
      background: #fff;
    }

    .layer-btn {
      border: none;
      background: transparent;
      color: var(--text-sub);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .layer-btn.active {
      background: #20262f;
      color: #fff;
      box-shadow: 0 4px 10px rgba(32, 38, 47, 0.25);
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tool-btn {
      border: 1px solid #d7cab5;
      background: #fffdf8;
      color: #664f2e;
      border-radius: 999px;
      padding: 7px 13px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tool-btn:hover {
      transform: translateY(-1px);
      background: #fff8ec;
    }

    .tool-icon-btn {
      width: 30px;
      height: 30px;
      border: 1px solid #e4d7c3;
      border-radius: 50%;
      background: #fffdf8;
      color: #8a7350;
      font-size: 13px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.7;
      transition: 0.2s ease;
    }

    .tool-icon-btn:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    .tool-icon-btn.cloud-ready {
      opacity: 1;
      color: #1f7a4c;
      border-color: #b8dfc8;
      background: #f3fff8;
    }

    .tool-icon-btn.cloud-busy {
      opacity: 1;
      color: #855b1f;
      border-color: #e7d4b4;
      background: #fff9ef;
    }

    .cloud-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(23, 28, 35, 0.42);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .cloud-modal {
      width: min(560px, 100%);
      border: 1px solid #e8dccb;
      border-radius: 14px;
      background: #fffdf8;
      box-shadow: 0 18px 45px rgba(27, 31, 36, 0.28);
      overflow: hidden;
    }

    .cloud-modal-head {
      padding: 12px 14px;
      border-bottom: 1px solid #efe2d0;
      background: #fff7ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .cloud-modal-title {
      margin: 0;
      font-size: 15px;
      font-weight: 800;
      color: #4c3a1f;
    }

    .cloud-modal-body {
      padding: 12px 14px;
      display: grid;
      gap: 10px;
    }

    .cloud-modal-row {
      display: grid;
      gap: 6px;
    }

    .cloud-modal-label {
      margin: 0;
      font-size: 12px;
      color: #725c38;
      font-weight: 700;
    }

    .cloud-modal-input {
      width: 100%;
      border: 1px solid #e3d6c2;
      border-radius: 9px;
      padding: 9px 10px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: #1f2933;
      font-family: inherit;
    }

    .cloud-modal-input:focus {
      border-color: #bda582;
      box-shadow: 0 0 0 2px rgba(189, 165, 130, 0.2);
    }

    .cloud-modal-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #5d4a2e;
    }

    .cloud-modal-error {
      min-height: 18px;
      margin: 0;
      font-size: 12px;
      color: var(--danger);
    }

    .cloud-modal-foot {
      padding: 10px 14px 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .cloud-modal-btn {
      border: 1px solid #d9c7aa;
      background: #fffefb;
      color: #6a5432;
      border-radius: 9px;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .cloud-modal-btn.primary {
      background: #2f4858;
      color: #fff;
      border-color: #2f4858;
    }

    .goal-fab-wrap {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 5000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      pointer-events: none;
    }

    .fab-icon-row {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      pointer-events: auto;
    }

    .goal-fab-btn {
      width: 46px;
      height: 46px;
      border: 1px solid #d8c8ae;
      border-radius: 50%;
      background: #fffdf8;
      color: #7a6340;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 10px 22px rgba(39, 28, 16, 0.18);
      pointer-events: auto;
    }

    .goal-fab-btn.active {
      background: #2f4858;
      color: #fff;
      border-color: #2f4858;
    }

    .goal-fab-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .inbox-panel {
      width: min(360px, calc(100vw - 24px));
      border: 1px solid #e8dccb;
      border-radius: 12px;
      background: #fffdf8;
      box-shadow: 0 14px 32px rgba(27, 31, 36, 0.24);
      overflow: hidden;
      display: none;
      pointer-events: auto;
      max-height: min(64vh, 500px);
    }

    .goal-fab-wrap.inbox-expanded .inbox-panel {
      display: flex;
      flex-direction: column;
    }

    .inbox-panel-head {
      padding: 10px 12px;
      border-bottom: 1px solid #efe2d0;
      background: #fff7ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .inbox-panel-title {
      margin: 0;
      font-size: 13px;
      font-weight: 800;
      color: #574429;
    }

    .inbox-panel-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .inbox-panel-body {
      padding: 10px 12px 12px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .inbox-empty {
      margin: 0;
      font-size: 12px;
      color: #6e7b88;
      line-height: 1.5;
    }

    .goal-panel {
      width: min(340px, calc(100vw - 24px));
      border: 1px solid #e8dccb;
      border-radius: 12px;
      background: #fffdf8;
      box-shadow: 0 14px 32px rgba(27, 31, 36, 0.24);
      overflow: hidden;
      opacity: 0;
      transform: translateY(8px) scale(0.98);
      max-height: 0;
      transition: opacity 0.2s ease, transform 0.2s ease, max-height 0.2s ease;
      pointer-events: none;
    }

    .goal-fab-wrap.goal-expanded .goal-panel {
      opacity: 1;
      transform: translateY(0) scale(1);
      max-height: 460px;
      pointer-events: auto;
    }

    .goal-panel-head {
      padding: 10px 12px;
      border-bottom: 1px solid #efe2d0;
      background: #fff7ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .goal-panel-title {
      margin: 0;
      font-size: 13px;
      font-weight: 800;
      color: #574429;
    }

    .goal-panel-head-right {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .goal-type-btn {
      border: 1px solid #dccbb1;
      background: #fffdf8;
      color: #7b6541;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      line-height: 1.2;
      cursor: pointer;
    }

    .goal-type-btn.active {
      border-color: #2f4858;
      background: #2f4858;
      color: #fff;
    }

    .goal-close-btn {
      width: 24px;
      height: 24px;
      border: 1px solid #dccbb1;
      border-radius: 50%;
      background: #fffdf8;
      color: #7a6340;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
    }

    .goal-panel-body {
      padding: 10px 12px 12px;
      display: grid;
      gap: 10px;
    }

    .goal-label {
      margin: 0;
      font-size: 12px;
      font-weight: 700;
      color: #755d39;
    }

    .goal-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .goal-mini-btn {
      width: 22px;
      height: 22px;
      border: 1px solid #d7c6a8;
      border-radius: 50%;
      background: #fffefb;
      color: #715934;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      flex: 0 0 auto;
    }

    .goal-sub-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .goal-sub-item {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 6px;
      align-items: start;
    }

    .goal-sub-remove {
      border: none;
      background: transparent;
      color: #9aa7b4;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
    }

    .goal-sub-remove:hover {
      background: #f4eee4;
      color: #b34545;
    }

    .goal-input {
      width: 100%;
      border: 1px solid #e3d6c2;
      border-radius: 9px;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: #1f2933;
      font-family: inherit;
      min-height: 32px;
      height: 32px;
      line-height: 1.4;
      resize: none;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      pointer-events: auto;
    }

    .goal-input:focus {
      border-color: #bda582;
      box-shadow: 0 0 0 2px rgba(189, 165, 130, 0.2);
    }

    .goal-hint {
      margin: 0;
      font-size: 11px;
      color: #7d8894;
      line-height: 1.4;
    }

    .goal-task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .goal-task-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
      padding: 4px 6px;
      border-radius: 9px;
    }

    .goal-task-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .goal-sub-row {
      grid-template-columns: minmax(0, 1fr) auto;
    }

    .goal-task-empty {
      margin: 0;
      font-size: 12px;
      color: #7a8490;
      line-height: 1.5;
    }

    main {
      padding: 18px;
    }

    .view {
      display: none;
      animation: fadeIn 0.35s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sop-layout {
      display: grid;
      grid-template-columns: 360px minmax(0, 1fr);
      gap: 14px;
    }

    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }

    .panel-head {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
    }

    .sop-head-two-row {
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 10px 12px;
    }

    .sop-head-two-row .panel-title {
      flex: 0 0 auto;
      white-space: nowrap;
      font-size: 14px;
      font-weight: 700;
    }

    .sop-head-two-row .mode-filter {
      padding: 0;
      border: none;
      background: transparent;
      width: auto;
      flex: 1 1 auto;
      flex-wrap: nowrap;
      gap: 6px;
    }

    .sop-head-two-row .chip {
      padding: 4px 9px;
      font-size: 11px;
      font-weight: 700;
    }

    .progress-wrap {
      min-width: 180px;
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      color: var(--text-sub);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f1e8d9;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #be5949, #8a6f43);
      transition: width 0.25s ease;
    }

    .mode-filter {
      padding: 10px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      background: #fffcf7;
    }

    .chip {
      border: 1px solid #e7dac6;
      background: #fff;
      color: var(--text-sub);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip.active {
      background: #2d3748;
      border-color: #2d3748;
      color: #fff;
    }

    .module-list {
      padding: 6px 8px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 5px;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .module-card {
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid #ede1d0;
      border-radius: var(--radius-md);
      padding: 4px 7px;
      margin-bottom: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fffdfa;
      min-width: max-content;
    }

    .module-card:hover {
      transform: none;
      border-color: #d6c3aa;
    }

    .module-card.active {
      border-width: 1px;
      border-color: #c8b293;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(58, 42, 22, 0.05);
    }

    .module-index {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 10px;
    }

    .badge-work { background: var(--work); }
    .badge-comm { background: var(--comm); }
    .badge-sleep { background: var(--sleep); }

    .module-name {
      margin: 0;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1px;
      white-space: nowrap;
    }

    .module-meta {
      margin-top: 3px;
      font-size: 12px;
      color: var(--text-sub);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .module-progress {
      margin-top: 8px;
      width: 100%;
      height: 5px;
      background: #f0e5d3;
      border-radius: 999px;
      overflow: hidden;
    }

    .module-card .module-meta,
    .module-card .module-progress {
      display: none;
    }

    .module-progress-fill {
      height: 100%;
      width: 0%;
      background: #3a6d63;
    }

    .detail {
      padding: 14px 18px 18px;
    }

    .timer {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 8px;
      min-width: 208px;
      background: #fffdf8;
    }

    .timer-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .timer-clock {
      font-family: "Menlo", "Consolas", monospace;
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      text-align: left;
      color: #2d3748;
      line-height: 1;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
    }

    .timer-actions {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .timer-btn {
      border: 1px solid #cdb99f;
      background: #fff;
      color: #5a4a30;
      font-size: 15px;
      font-weight: 700;
      border-radius: 10px;
      padding: 6px 6px;
      cursor: pointer;
    }

    .timer-btn.primary {
      background: #2f4858;
      color: #fff;
      border-color: #2f4858;
    }

    .timer-mini-btn {
      border: 1px solid #d8c4a7;
      background: #fffefb;
      color: #705836;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .budget-mini {
      display: flex;
      gap: 4px;
      align-items: center;
      opacity: 0.68;
    }

    .budget-total {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1;
      font-family: "Menlo", "Consolas", monospace;
    }

    .timer-float {
      width: min(240px, calc(100vw - 26px));
      border: 1px solid #e4d7c3;
      border-radius: 12px;
      background: rgba(255, 253, 248, 0.96);
      backdrop-filter: blur(4px);
      box-shadow: 0 10px 22px rgba(38, 27, 16, 0.16);
      padding: 7px;
      pointer-events: auto;
    }

    .timer-float.hidden {
      display: none;
    }

    .timer-float-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .timer-float-clock {
      font-family: "Menlo", "Consolas", monospace;
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
      border: none;
      background: transparent;
      color: #27364b;
      cursor: pointer;
      padding: 0;
    }

    .timer-float-budget {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      opacity: 0.76;
    }

    .timer-float-budget-total {
      font-size: 12px;
      color: #66707a;
      font-family: "Menlo", "Consolas", monospace;
      line-height: 1;
    }

    .timer-float-meta {
      margin: 4px 0 0;
      font-size: 10px;
      color: #79838d;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .timer-float-actions {
      margin-top: 6px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .timer-float-btn {
      border: 1px solid #cdb99f;
      background: #fff;
      color: #5a4a30;
      font-size: 14px;
      font-weight: 700;
      border-radius: 9px;
      padding: 5px 6px;
      cursor: pointer;
      line-height: 1;
    }

    .timer-float-btn.primary {
      background: #2f4858;
      color: #fff;
      border-color: #2f4858;
    }

    .section {
      margin-top: 18px;
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 14px;
      background: #fffdfa;
    }

    .detail .section {
      margin-top: 0;
      border: none;
      border-radius: 0;
      padding: 0;
      background: transparent;
    }

    .section-title {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 800;
      color: #503d23;
    }

    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .section-head .section-title {
      margin: 0;
    }

    .section-action-btn {
      border: 1px solid #d9c6aa;
      background: #fffefb;
      color: #715934;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 16px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .todo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .todo-node {
      border: 1px solid #efe3d1;
      border-radius: 10px;
      background: #fff;
      padding: 6px;
    }

    .todo-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
      padding: 4px 6px;
      border-radius: 9px;
    }

    .todo-row.reflection {
      background: #fff7ea;
      border: 1px dashed #dcc6a7;
      border-radius: 9px;
    }

    .todo-check {
      width: 16px;
      height: 16px;
      accent-color: #2f855a;
      cursor: pointer;
    }

    .todo-input {
      border: none;
      width: 100%;
      font-size: 14px;
      background: transparent;
      color: var(--text-main);
      outline: none;
      padding: 4px 0;
      font-family: inherit;
      line-height: 1.4;
      min-height: 26px;
      height: 26px;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    textarea.todo-input {
      resize: none;
    }

    .todo-row.done .todo-input {
      text-decoration: line-through;
      color: #8898a7;
    }

    .todo-main-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mini-action {
      border: 1px solid #dac7aa;
      background: #fffefb;
      color: #725d3c;
      border-radius: 7px;
      font-size: 12px;
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .todo-del {
      border: none;
      background: transparent;
      color: #9da9b5;
      cursor: pointer;
      font-size: 14px;
      padding: 3px 5px;
      border-radius: 6px;
    }

    .todo-del:hover {
      background: #f5efe4;
      color: var(--danger);
    }

    .sub-list {
      margin-left: 26px;
      margin-top: 6px;
      border-left: 2px solid #efe2ce;
      padding-left: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sub-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
      padding: 4px 6px;
      border-radius: 8px;
      background: #fffaf2;
      border: 1px solid #f3e6d5;
    }

    .sub-row .todo-check {
      width: 14px;
      height: 14px;
    }

    .sub-row.done .todo-input {
      text-decoration: line-through;
      color: #9aa5b1;
    }

    .small-btn {
      border: 1px dashed #ccb697;
      background: #fff;
      color: #715934;
      border-radius: 8px;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .hint {
      margin: 0;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .dashboard-single {
      display: block;
    }

    .dashboard-board {
      padding: 16px;
    }

    .domain-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .domain-pick {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .domain-pick-btn {
      border: 1px solid #decbb2;
      background: #fff;
      color: #6e5736;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }

    .domain-pick-btn.active {
      background: #2e3744;
      color: #fff;
      border-color: #2e3744;
    }

    .domain-focus {
      border: 1px solid #e7d7c3;
      border-radius: 12px;
      background: #fffdf9;
      overflow: hidden;
    }

    .domain-card {
      border: 1px solid #eadcc8;
      border-radius: var(--radius-md);
      background: #fffdf9;
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }

    .domain-head {
      padding: 12px;
      border-bottom: 1px solid #eadcc8;
      background: #fff8ee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .domain-name {
      margin: 0;
      font-size: 15px;
      font-weight: 800;
    }

    .domain-content {
      padding: 12px;
    }

    .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 7px;
    }

    .label-row .label {
      margin: 0;
    }

    .icon-round-btn {
      width: 24px;
      height: 24px;
      border: 1px solid #d9c7aa;
      background: #fffefb;
      color: #715934;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      line-height: 1;
    }

    .icon-round-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .fqa-item + .fqa-item {
      margin-top: 8px;
    }

    .expand-item {
      border: 1px solid #e8dccb;
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .expand-item + .expand-item {
      margin-top: 8px;
    }

    .expand-toggle {
      width: 100%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      text-align: left;
      padding: 8px 10px;
    }

    .expand-title {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      line-height: 1.3;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .expand-arrow {
      color: #8a7350;
      font-size: 13px;
      transition: transform 0.18s ease;
      flex: 0 0 auto;
    }

    .expand-item.expanded .expand-arrow {
      transform: rotate(90deg);
    }

    .expand-body {
      display: none;
      padding: 0 10px 10px;
      border-top: 1px solid #f0e3d1;
      background: #fffdfa;
    }

    .expand-item.expanded .expand-body {
      display: block;
    }

    .expand-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .expand-meta {
      margin: 0;
      font-size: 11px;
      color: #7c8794;
      line-height: 1.4;
    }

    .fqa-item-head {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .fqa-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .fqa-answer {
      margin-top: 6px;
    }

    .sop-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .sop-file {
      margin-top: 4px;
      font-size: 11px;
      color: #6f7b87;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .text-input {
      resize: none;
      min-height: 34px;
      height: 34px;
      overflow: hidden;
      line-height: 1.4;
      font-family: inherit;
    }

    .detail-block + .detail-block {
      margin-top: 14px;
    }

    .label {
      margin: 0 0 7px;
      font-size: 12px;
      color: #7c6542;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    .text-input {
      width: 100%;
      border: 1px solid #e7d8c3;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 14px;
      outline: none;
      background: #fffefb;
      color: #1f2933;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .list-edit {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .line-edit {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .kpi-row.done .text-input {
      text-decoration: line-through;
      color: #8898a7;
    }

    .empty-note {
      color: var(--text-sub);
      font-size: 13px;
      margin: 4px 0;
    }

    @media (max-width: 980px) {
      body {
        padding: 12px;
      }

      .purpose {
        display: none;
      }

      .sop-layout {
        grid-template-columns: 1fr;
      }

      .sop-head-two-row {
        padding: 8px 10px;
      }

      .domain-grid {
        grid-template-columns: 1fr;
      }

      .domain-pick {
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .domain-pick-btn {
        white-space: nowrap;
      }

      .timer {
        min-width: 100%;
      }

      .timer-clock {
        font-size: 30px;
      }

      .timer-float {
        width: min(200px, calc(100vw - 20px));
      }

      .timer-float-clock {
        font-size: 20px;
      }

      .module-list {
        padding: 5px 7px;
        gap: 4px;
      }

      .module-card {
        padding: 4px 6px;
        gap: 4px;
      }

      .module-index {
        width: 18px;
        height: 18px;
        font-size: 9px;
      }

      .module-name {
        font-size: 10.5px;
      }

      textarea.todo-input,
      textarea.text-input {
        font-size: 16px;
      }

      .sop-row,
      .fqa-item-head {
        align-items: start;
      }

      .goal-fab-wrap {
        right: 10px;
        bottom: 10px;
      }

      .goal-input {
        font-size: 16px;
      }

    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1 class="title">POS Console V2</h1>
      <p class="purpose">
        ÁõÆÊ†áÔºö‰ΩéÊ≥¢Âä®„ÄÅÂèØÂ§çÁõò„ÄÅÂèØÈïøÊúüÁßØÁ¥Ø„ÄÇ
      </p>
      <div class="head-row">
        <div class="layer-switch" role="tablist" aria-label="POS Layers">
          <button class="layer-btn active" id="layerSopBtn" type="button" onclick="switchLayer('sop')">SOP ÊâßË°åÂ±Ç</button>
          <button class="layer-btn" id="layerDashboardBtn" type="button" onclick="switchLayer('dashboard')">Dashboard ÂÜ≥Á≠ñÂ±Ç</button>
        </div>
        <div class="toolbar">
          <button id="cloudConfigBtn" class="tool-icon-btn" type="button" onclick="openCloudMenu()" title="Supabase ÈÖçÁΩÆ/ÁÆ°ÁêÜ" aria-label="Supabase ÈÖçÁΩÆ/ÁÆ°ÁêÜ">‚òÅ</button>
          <button id="cloudSyncBtn" class="tool-icon-btn" type="button" onclick="syncCloudBidirectional()" title="Supabase ÂèåÂêëÂêåÊ≠•" aria-label="Supabase ÂèåÂêëÂêåÊ≠•">‚áÖ</button>
          <button class="tool-icon-btn" type="button" onclick="triggerImport()" title="ÂØºÂÖ• CSV/JSON" aria-label="ÂØºÂÖ• CSV/JSON">‚§í</button>
          <button class="tool-icon-btn" type="button" onclick="exportData()" title="ÂØºÂá∫ CSV" aria-label="ÂØºÂá∫ CSV">‚§ì</button>
        </div>
      </div>
      <input id="importFileInput" type="file" accept=".csv,text/csv,application/json,.json" style="display:none" onchange="handleImportFile(event)">
    </header>

    <main>
      <section class="view active" id="sopView">
        <div class="sop-layout">
          <aside class="panel">
            <div class="panel-head sop-head-two-row">
              <h2 class="panel-title">‰ªäÊó• SOP ÊµÅÁ®ã</h2>
              <div class="mode-filter" id="modeFilter"></div>
            </div>
            <div class="module-list" id="moduleList"></div>
          </aside>

          <section class="panel detail" id="moduleDetail"></section>
        </div>
      </section>

      <section class="view" id="dashboardView">
        <section class="panel dashboard-single">
          <div class="dashboard-board">
            <div class="domain-grid" id="domainGrid"></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div class="goal-fab-wrap" id="goalFabWrap">
    <div class="inbox-panel" id="inboxPanel"></div>
    <div class="timer-float hidden" id="timerFloat"></div>
    <div class="goal-panel" id="goalPanel">
      <div class="goal-panel-head">
        <p class="goal-panel-title">ÁõÆÊ†áÈù¢Êùø</p>
        <div class="goal-panel-head-right">
          <button class="goal-type-btn active" id="goalTypeShortBtn" type="button" aria-label="ÂàáÊç¢Âà∞Áü≠ÊúüÁõÆÊ†á">Áü≠Êúü</button>
          <button class="goal-type-btn" id="goalTypeLongBtn" type="button" aria-label="ÂàáÊç¢Âà∞ÈïøÊúüÁõÆÊ†á">ÈïøÊúü</button>
          <button class="goal-close-btn" id="goalCloseBtn" type="button" aria-label="Êî∂Ëµ∑ÁõÆÊ†áÈù¢Êùø">√ó</button>
        </div>
      </div>
      <div class="goal-panel-body">
        <div class="section-head">
          <h3 class="section-title" id="goalListTitle">Áü≠ÊúüÁõÆÊ†á</h3>
          <button class="section-action-btn" id="addGoalItemBtn" type="button" title="Êñ∞Â¢ûÁõÆÊ†áÈ°π" aria-label="Êñ∞Â¢ûÁõÆÊ†áÈ°π">+</button>
        </div>
        <div class="goal-task-list" id="goalTaskList"></div>
        <p class="goal-hint">ÊØè‰∏™ÁõÆÊ†áÈ°πÂèØÁªßÁª≠Ê∑ªÂä†‰∫åÁ∫ßÊñáÂ≠óÊ°Ü„ÄÇ</p>
      </div>
    </div>
    <div class="fab-icon-row">
      <button class="goal-fab-btn" id="inboxFabBtn" type="button" aria-label="ÊâìÂºÄ Work Inbox" title="Inbox">üì•</button>
      <button class="goal-fab-btn" id="timerFabBtn" type="button" aria-label="Â±ïÂºÄËÆ°Êó∂Ë°®" title="ËÆ°Êó∂Ë°®">‚è±</button>
      <button class="goal-fab-btn" id="goalFabBtn" type="button" aria-label="Â±ïÂºÄÁõÆÊ†áÈù¢Êùø" title="Áü≠Êúü/ÈïøÊúüÁõÆÊ†á">üéØ</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const STORAGE_KEY = "pos_console_v2";
    const STATE_META_KEY = "pos_console_v2_meta";
    const SUPABASE_CONFIG_KEY = "pos_console_v2_supabase";
    const DEFAULT_SUPABASE_TABLE = "pos_console_states";
    const CLOUD_PUSH_DEBOUNCE_MS = 1600;
    const MODE_LABEL = { work: "Work", comm: "Communication", sleep: "Sleep" };
    const MODE_COLOR_CLASS = { work: "badge-work", comm: "badge-comm", sleep: "badge-sleep" };
    const DOMAIN_ORDER = ["health", "cognition", "relationship", "wealth"];

    const defaultState = {
      layer: "sop",
      modeFilter: "work",
      activeModuleId: "wake",
      dailyBudgetMinutes: 425,
      goals: {
        shortTerm: "",
        longTerm: "",
        shortTermSubs: [],
        longTermSubs: [],
        shortPlans: [{ text: "", subs: [] }],
        longPlans: [{ text: "", subs: [] }],
        activeType: "short",
        expanded: false
      },
      modules: [
        {
          id: "wake",
          order: 1,
          mode: "sleep",
          title: "Sleep Ëµ∑Â∫ä",
          duration: 25,
          intent: "ÊãâËµ∑Ë∫´‰Ωì‰∏éÊ≥®ÊÑèÂäõÔºå‰∏∫Êï¥Â§©ÂÜ≥Á≠ñË¥®ÈáèÊâìÂ∫ï„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "ÂºÄÁ™óËßÅÂÖâ 5 ÂàÜÈíüÔºåÂñù 500ml Ê∞¥", done: false },
            { text: "3-5 ÂàÜÈíüÊãâ‰º∏ÊàñËΩªÂ∫¶ÂøÉÁéáÊøÄÊ¥ª", done: false },
            { text: "Á°ÆËÆ§‰ªäÂ§©‰∏ªÁõÆÊ†á‰∏éÁ¶ÅÂÅö‰∫ãÈ°π", done: false }
          ],
          hint: "Sleep Ê®°Âùó‰ª•ÁîüÁêÜÁä∂ÊÄÅ‰∏éËäÇÂæãÁ®≥ÂÆö‰∏∫‰∏ª„ÄÇ"
        },
        {
          id: "work-start",
          order: 2,
          mode: "work",
          title: "Work ÂêØÂä®",
          duration: 30,
          intent: "Âø´ÈÄüËøõÂÖ•ÊâßË°åÁä∂ÊÄÅ„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "Êï¥ÁêÜÊ°åÈù¢ÂíåÊï∞Â≠óÁéØÂ¢ÉÔºåÂ±èËîΩÂπ≤Êâ∞", done: false },
            { text: "ÂõûÁúã DashboardÔºåÊòéÁ°Æ‰ªäÊó•ÊúÄÂÖ≥ÈîÆ‰∫ßÂá∫", done: false },
            { text: "Â∞Ü‰ªªÂä°ÊãÜ‰∏∫ 1 ‰∏™‰∏ª‰ªªÂä° + 2 ‰∏™Ê¨°‰ªªÂä°", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-1",
          order: 3,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ1",
          duration: 90,
          intent: "‰ºòÂÖàÊé®ËøõÊúÄÈ´òÊù†ÊùÜ‰∏ª‰∫ßÂá∫„ÄÇ",
          reflection: "",
          remainingSeconds: 90 * 60,
          todos: [
            { text: "ÂÖàÂÆåÊàêÊúÄÈöæ 20% Â∑•‰Ωú", done: false },
            { text: "ÊØè 30 ÂàÜÈíüÊ£ÄÊü•ÊòØÂê¶ÂÅèÁ¶ªÁõÆÊ†á", done: false },
            { text: "ËÆ∞ÂΩïÈòªÂ°ûÁÇπÂπ∂ÊèêÂá∫‰∏Ä‰∏™Êõø‰ª£ÊñπÊ°à", done: false }
          ],
          hint: ""
        },
        {
          id: "comm-1",
          order: 4,
          mode: "comm",
          title: "Comm 1",
          duration: 25,
          intent: "ËøõË°åÈ´ò‰ª∑ÂÄºÊ≤üÈÄöÔºåËÄåÈùû‰ø°ÊÅØÂ†ÜÁßØ„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "ÈÄâ 1 ‰∏™ÂÖ≥ÈîÆÂÖ≥Á≥ªÂØπË±°", done: false },
            { text: "ËæìÂá∫‰∏ÄÊ¨°Êúâ‰ª∑ÂÄºËß¶ËææÔºàÊú∫‰ºö/ËµÑÊ∫ê/ÂèçÈ¶àÔºâ", done: false },
            { text: "ËÆ∞ÂΩïÂêéÁª≠Âä®‰ΩúÂíåÊà™Ê≠¢Êó•Êúü", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-2",
          order: 5,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ2",
          duration: 90,
          intent: "ÂÆåÊàêÊ¨°Á∫ßÊ†∏ÂøÉ‰ªªÂä°ÔºåÂáèÂ∞ë‰ªªÂä°ÂÄ∫„ÄÇ",
          reflection: "",
          remainingSeconds: 90 * 60,
          todos: [
            { text: "Êé®ËøõÊ¨°‰∫ßÂá∫Âπ∂ÂΩ¢ÊàêÂèØ‰∫§‰ªòÁªìÊûú", done: false },
            { text: "ÂØπÊµÅÁ®ãËøõË°å 1 Ê¨°ÂæÆ‰ºòÂåñ", done: false },
            { text: "Ê≤âÊ∑ÄÂèØÂ§çÁî®Ê®°ÊùøÊàñÊ£ÄÊü•Âçï", done: false }
          ],
          hint: ""
        },
        {
          id: "work-inbox",
          order: 6,
          mode: "work",
          title: "Work Inbox",
          duration: 30,
          intent: "ÈõÜ‰∏≠Â§ÑÁêÜÁ¢é‰ªªÂä°ÔºåÈÅøÂÖç‰æµËöÄÊ∑±Â∫¶Êó∂Èó¥„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "Áªü‰∏ÄÂ§ÑÁêÜÁü≠ÂõûÂ§ç‰∏é‰∏¥Êó∂ËØ∑Ê±Ç", done: false },
            { text: "Âà§Êñ≠ÂèØÂà†Èô§/ÂèØÂßîÊ¥æ/ÂèØÂª∂Êúü‰∫ãÈ°π", done: false },
            { text: "ÊääÈúÄË¶ÅÊ∑±Â∫¶ÁöÑ‰∫ãÈ°πÁßªÂÖ•ÊòéÊó•ÈòüÂàó", done: false }
          ],
          hint: ""
        },
        {
          id: "comm-2",
          order: 7,
          mode: "comm",
          title: "Comm 2",
          duration: 25,
          intent: "ÂÅö‰∏ÄÊ¨°ÂÖ≥Á≥ªÊ∑±ÂåñÂä®‰ΩúÔºåÂΩ¢ÊàêÈïøÊúüÂ§çÂà©„ÄÇ",
          reflection: "",
          remainingSeconds: 25 * 60,
          todos: [
            { text: "Â§çÁõò Comm 1 ÊòØÂê¶‰∫ßÁîü‰ª∑ÂÄº‰∫§Êç¢", done: false },
            { text: "ÂèëÂá∫ 1 Êù°È´òË¥®ÈáèË∑üËøõ‰ø°ÊÅØ", done: false },
            { text: "Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ‰∏é‰∏ã‰∏ÄÊ¨°Ëß¶ËææÊó∂Èó¥", done: false }
          ],
          hint: ""
        },
        {
          id: "deep-3",
          order: 8,
          mode: "work",
          title: "Work Ê∑±Â∫¶ÁªÑ3",
          duration: 60,
          intent: "Â≠¶‰π†Âπ∂ÂçáÁ∫ßÁ≥ªÁªüËÉΩÂäõÔºåÂΩ¢Êàê‰∏≠ÈïøÊúüÊî∂Áõä„ÄÇ",
          reflection: "",
          remainingSeconds: 60 * 60,
          todos: [
            { text: "Â≠¶‰π†Âπ∂ËÆ≤Ëß£‰∏Ä‰∏™ÂÖ≥ÈîÆÊ¶ÇÂøµ/Ê®°Âûã", done: false },
            { text: "ÊääÊ¶ÇÂøµÂÜôÂÖ•Ëá™Â∑±ÁöÑÊµÅÁ®ãÁ≥ªÁªü", done: false },
            { text: "ÂÆö‰πâÊòéÂ§©ÂèØÈ™åËØÅÁöÑÂ∫îÁî®Âú∫ÊôØ", done: false }
          ],
          hint: ""
        },
        {
          id: "work-end",
          order: 9,
          mode: "work",
          title: "Work ÁªìÊùü‰∫§Êé•",
          duration: 20,
          intent: "ÂÆåÊàê‰∫§Êé•‰∏éÈó≠ÁéØÔºåÈôç‰ΩéÊòéÊó•ÂêØÂä®ÊàêÊú¨„ÄÇ",
          reflection: "",
          remainingSeconds: 20 * 60,
          todos: [
            { text: "Êõ¥Êñ∞Ë¥¶Êú¨/ÊåáÊ†áÂπ∂ËÆ∞ÂΩïÂÖ≥ÈîÆÊï∞ÊçÆ", done: false },
            { text: "ÂÜô‰∏ãÊòéÊó•ÂêØÂä®Ê∏ÖÂçïÔºàÂâç 3 È°πÔºâ", done: false },
            { text: "ÂàóÂá∫ 1 ‰∏™Á≥ªÁªü‰ºòÂåñÁÇπ", done: false }
          ],
          hint: ""
        },
        {
          id: "bedtime",
          order: 10,
          mode: "sleep",
          title: "Sleep ÂÖ•Áù°",
          duration: 30,
          intent: "ÈÄöËøáÁ®≥ÂÆöÂÖ•Áù°ÊµÅÁ®ãÈôç‰ΩéÊ¨°Êó•Ê≥¢Âä®„ÄÇ",
          reflection: "",
          remainingSeconds: 30 * 60,
          todos: [
            { text: "ËøúÁ¶ªÊâãÊú∫‰∏éÂº∫Âà∫ÊøÄÂÜÖÂÆπ 30 ÂàÜÈíü", done: false },
            { text: "ÁÆÄÂçïÊï¥ÁêÜÁéØÂ¢ÉÂπ∂ÂÆåÊàêÊ¥óÊº±", done: false },
            { text: "ÂëºÂê∏ÊîæÊùæ 3 ÂàÜÈíüÂêéÂÖ•Áù°", done: false }
          ],
          hint: "Sleep Ê®°ÂùóÈªòËÆ§Âè™ÂÅöÊâßË°å‰∏éÁîüÁêÜÂ§ç‰ΩçÔºåÈùûÂ§çÊùÇÂèçÊÄù„ÄÇ"
        }
      ],
      dashboard: {
        activeDomain: "health",
        domains: {
          health: {
            name: "Health",
            color: "#9d3d2f",
            fqas: [
              { question: "‰ªäÂ§©Ë∫´‰ΩìÊúâÂäõ„ÄÅÂ§¥ËÑëÊ∏ÖÈÜí„ÄÅÊÉÖÁª™Á®≥ÂÆöÂêóÔºü", answer: "", expanded: false }
            ],
            principles: [
              "‰ºòÂÖàÁ∫ßÂõ∫ÂÆöÔºöÁù°Áú† > ËøêÂä® > ÊîæÊùæ > Â≠¶‰π† > Â∑•‰Ωú",
              "‰ºòÂÖà‰øÆÂ§çÊ≥¢Âä®Ê∫êÔºå‰∏çÂ∏¶ÁùÄÈÄèÊîØÂÅöÂÜ≥Á≠ñ",
              "ÊØèÊó•ÊúÄÂ∞ë‰∏ÄÊ¨°‰∏ªÂä®ÊÅ¢Â§çÔºàÂëºÂê∏/Êï£Ê≠•/Êãâ‰º∏Ôºâ"
            ],
            sops: [
              { text: "Áù°Áú†Êó∂Èïø ‚â• 7.5h", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ËøêÂä® 30-60 ÂàÜÈíü", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "12:00-20:00 ËøõÈ£üÁ™óÂè£", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          cognition: {
            name: "Cognition",
            color: "#205295",
            fqas: [
              { question: "ÊàëÊòØÂê¶Âú®ÊûÑÂª∫‰∏çÊñ≠ÂçáÁ∫ßÁöÑÂ§ßËÑëÊìç‰ΩúÁ≥ªÁªüÔºü", answer: "", expanded: false }
            ],
            principles: [
              "ÂÖàÂÆö‰πâÁõÆÊ†áÂíåÁ∫¶ÊùüÔºåÂÜçÂèëÊï£‰∏éÂõûÂΩí",
              "ÊâæÂÖ≥ÈîÆÂèòÈáèÔºåÈÅøÂÖç‰ø°ÊÅØËøáËΩΩ",
              "ËæìÂá∫ÊØîËæìÂÖ•Êõ¥ÈáçË¶ÅÔºöÂ≠¶ÂÆåË¶ÅËÉΩËÆ≤ÊòéÁôΩ"
            ],
            sops: [
              { text: "ÂÆåÊàê 1 Ê¨°ÁªìÊûÑÂåñÂ§çÁõò", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂÜôÂá∫ 1 ‰∏™ÂèØÂ§çÁî®ÂÜ≥Á≠ñÊ®°Êùø", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂΩìÂ§©Ê¶ÇÂøµËÆ≤Ëß£ 10 ÂàÜÈíü", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          relationship: {
            name: "Relationship",
            color: "#0f766e",
            fqas: [
              { question: "‰ªäÂ§©ÊàëÊòØÂê¶ÂØπ‰∏Ä‰ΩçÂÖ≥ÈîÆÂÖ≥Á≥ªÂÅö‰∫ÜÈ´òË¥®ÈáèËÅîÁ≥ªÔºü", answer: "", expanded: false }
            ],
            principles: [
              "ÂÖàÊèê‰æõ‰ª∑ÂÄºÔºåÂÜçÊèêÂá∫ËØ∑Ê±Ç",
              "ÂÖ≥Á≥ªÁª¥Êä§Ë¶ÅÂèØËøΩË∏™ÔºöËÆ∞ÂΩï -> ËøΩË∏™ -> Âä†Ê∑±",
              "Ê≤üÈÄöËøΩÊ±ÇÊ∏ÖÊô∞‰∏éÈïøÊúü‰ø°‰ªªÔºå‰∏çËøΩÊ±ÇÁü≠ÊúüÂ•ΩÊÑü"
            ],
            sops: [
              { text: "È´òË¥®ÈáèËß¶Ëææ >= 1 ‰∫∫", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "Êõ¥Êñ∞ÂÖ≥Á≥ªË∑üËøõËÆ∞ÂΩï", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "Êé®Âä® 1 Ê¨°ÂèåÂêëÂêà‰ΩúÊú∫‰ºö", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          },
          wealth: {
            name: "Wealth",
            color: "#8a6f43",
            fqas: [
              { question: "ÊàëÊòØÂê¶Âú®ÂÅöÈ¢ÑÁÆóÂÖÖË∂≥‰∏îËÉΩÊèêÂçáËá™Áî±Â∫¶ÁöÑ‰∫ãÔºü", answer: "", expanded: false }
            ],
            principles: [
              "Ê∏ÖÊô∞ÊÄùËÄÉÂÖà‰∫éË°åÂä®ÔºåÈÅøÂÖçÂÜ≤Âä®ÊäïÂÖ•",
              "‰∏çÂÅöÊó∂Èó¥ÊàñËµÑÈáëÈ¢ÑÁÆó‰∏çË∂≥ÁöÑÈ°πÁõÆ",
              "Áé∞ÈáëÊµÅ„ÄÅÂÆâÂÖ®Âû´„ÄÅÈïøÊúüÁßØÁ¥Ø‰∏âËÄÖÂπ∂Èáç"
            ],
            sops: [
              { text: "ÂΩìÊúàÁé∞ÈáëÊµÅ‰∏∫Ê≠£", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ÂÇ®ËìÑÁéáËææÂà∞ÁõÆÊ†áÂå∫Èó¥", done: false, fileName: "", fileType: "", fileData: "" },
              { text: "ËµÑ‰∫ßÈÖçÁΩÆÊåâËßÑÂàôÂ§çÁõò", done: false, fileName: "", fileType: "", fileData: "" }
            ]
          }
        }
      }
    };

    let state = null;
    let timerInterval = null;
    let timerModuleId = null;
    let autoGrowRefreshRaf = null;
    let autoGrowViewportBound = false;
    let localMeta = null;
    let supabaseConfig = null;
    let supabaseClient = null;
    let supabaseClientSignature = "";
    let cloudPushTimer = null;
    let cloudSyncInFlight = false;
    let goalWidgetBound = false;
    let timerFabBound = false;
    let timerFabExpanded = false;
    let inboxFabBound = false;
    let inboxFabExpanded = false;
    let dashboardItemExpanded = {};

    function clone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return mergeState(defaultState);
      }
      try {
        const saved = JSON.parse(raw);
        return mergeState(saved);
      } catch (error) {
        return mergeState(defaultState);
      }
    }

    function mergeState(saved) {
      const base = clone(defaultState);
      if (!saved || typeof saved !== "object") {
        return base;
      }

      if (saved.layer === "sop" || saved.layer === "dashboard") {
        base.layer = saved.layer;
      }
      if (MODE_LABEL[saved.modeFilter]) {
        base.modeFilter = saved.modeFilter;
      }
      if (typeof saved.activeModuleId === "string") {
        base.activeModuleId = saved.activeModuleId;
      }
      if (Number.isFinite(saved.dailyBudgetMinutes) && saved.dailyBudgetMinutes > 0) {
        base.dailyBudgetMinutes = Math.round(saved.dailyBudgetMinutes);
      }
      base.goals = normalizeGoals(saved.goals || {
        shortTerm: saved.shortTermGoal,
        longTerm: saved.longTermGoal,
        expanded: saved.goalPanelExpanded
      });

      if (Array.isArray(saved.modules)) {
        const savedMap = new Map(saved.modules.map((m) => [m.id, m]));
        base.modules = base.modules.map((m) => {
          const s = savedMap.get(m.id);
          if (!s || typeof s !== "object") {
            return {
              ...m,
              todos: m.todos.map((todo) => normalizeTodo(todo))
            };
          }
          const todos = Array.isArray(s.todos) && s.todos.length
            ? s.todos.map((todo) => normalizeTodo(todo))
            : m.todos.map((todo) => normalizeTodo(todo));
          const legacyReflection = typeof s.reflection === "string" ? s.reflection.trim() : "";
          if (legacyReflection) {
            todos.push({
              text: `ReflectionÔºàÂèØÈÄâÔºâÔºö${legacyReflection}`,
              done: false,
              subs: []
            });
          }
          return {
            ...m,
            title: typeof s.title === "string" ? s.title : m.title,
            duration: Number.isFinite(s.duration) && s.duration > 0 ? s.duration : m.duration,
            intent: typeof s.intent === "string" ? s.intent : m.intent,
            hint: typeof s.hint === "string" ? s.hint : m.hint,
            remainingSeconds: Number.isFinite(s.remainingSeconds) && s.remainingSeconds >= 0
              ? Math.floor(s.remainingSeconds)
              : m.duration * 60,
            todos
          };
        });
      }

      if (saved.dashboard && typeof saved.dashboard === "object") {
        const savedDashboard = saved.dashboard;
        if (DOMAIN_ORDER.includes(savedDashboard.activeDomain)) {
          base.dashboard.activeDomain = savedDashboard.activeDomain;
        }
        if (savedDashboard.domains && typeof savedDashboard.domains === "object") {
          DOMAIN_ORDER.forEach((key) => {
            const domainBase = base.dashboard.domains[key];
            const domainSaved = savedDashboard.domains[key];
            if (!domainSaved || typeof domainSaved !== "object") {
              return;
            }
            if (Array.isArray(domainSaved.principles)) {
              domainBase.principles = domainSaved.principles.map((line) => normalizePrinciple(line));
            }

            if (Array.isArray(domainSaved.fqas)) {
              domainBase.fqas = domainSaved.fqas.map((item) => normalizeFqa(item));
            } else {
              const legacyQuestion = typeof domainSaved.question === "string"
                ? domainSaved.question
                : (domainBase.fqas[0]?.question || "");
              domainBase.fqas = [{ question: legacyQuestion, answer: "", subs: [], expanded: false }];
            }

            if (Array.isArray(domainSaved.sops)) {
              domainBase.sops = domainSaved.sops.map((item) => normalizeSop(item));
            } else if (Array.isArray(domainSaved.kpis) && domainSaved.kpis.length) {
              domainBase.sops = domainSaved.kpis.map((item) => normalizeSop(item));
            }

            domainBase.fqas = (domainBase.fqas || []).map((item) => normalizeFqa(item));
            domainBase.principles = (domainBase.principles || []).map((line) => normalizePrinciple(line));
            domainBase.sops = (domainBase.sops || []).map((item) => normalizeSop(item));
          });
        }
      }

      DOMAIN_ORDER.forEach((key) => {
        const domainBase = base.dashboard.domains[key];
        if (!domainBase) {
          return;
        }
        domainBase.fqas = (domainBase.fqas || []).map((item) => normalizeFqa(item));
        domainBase.principles = (domainBase.principles || []).map((line) => normalizePrinciple(line));
        domainBase.sops = (domainBase.sops || []).map((item) => normalizeSop(item));
      });

      return base;
    }

    function normalizeSupabaseConfig(raw) {
      const fallback = {
        url: "",
        anonKey: "",
        workspace: "default",
        table: DEFAULT_SUPABASE_TABLE,
        autoSync: false
      };
      if (!raw || typeof raw !== "object") {
        return fallback;
      }
      return {
        url: typeof raw.url === "string" ? raw.url.trim() : "",
        anonKey: typeof raw.anonKey === "string" ? raw.anonKey.trim() : "",
        workspace: typeof raw.workspace === "string" && raw.workspace.trim()
          ? raw.workspace.trim()
          : "default",
        table: typeof raw.table === "string" && raw.table.trim()
          ? raw.table.trim()
          : DEFAULT_SUPABASE_TABLE,
        autoSync: Boolean(raw.autoSync)
      };
    }

    function loadSupabaseConfig() {
      const raw = localStorage.getItem(SUPABASE_CONFIG_KEY);
      if (!raw) {
        return normalizeSupabaseConfig(null);
      }
      try {
        return normalizeSupabaseConfig(JSON.parse(raw));
      } catch (error) {
        return normalizeSupabaseConfig(null);
      }
    }

    function saveSupabaseConfig(config) {
      const normalized = normalizeSupabaseConfig(config);
      localStorage.setItem(SUPABASE_CONFIG_KEY, JSON.stringify(normalized));
      supabaseConfig = normalized;
      supabaseClient = null;
      supabaseClientSignature = "";
      updateCloudButtons();
    }

    function clearSupabaseConfig() {
      localStorage.removeItem(SUPABASE_CONFIG_KEY);
      supabaseConfig = normalizeSupabaseConfig(null);
      supabaseClient = null;
      supabaseClientSignature = "";
      if (cloudPushTimer) {
        clearTimeout(cloudPushTimer);
        cloudPushTimer = null;
      }
      updateCloudButtons();
    }

    function loadLocalMeta() {
      const fallback = { localUpdatedAt: "", lastCloudSyncAt: "" };
      const raw = localStorage.getItem(STATE_META_KEY);
      if (!raw) {
        return fallback;
      }
      try {
        const parsed = JSON.parse(raw);
        return {
          localUpdatedAt: typeof parsed.localUpdatedAt === "string" ? parsed.localUpdatedAt : "",
          lastCloudSyncAt: typeof parsed.lastCloudSyncAt === "string" ? parsed.lastCloudSyncAt : ""
        };
      } catch (error) {
        return fallback;
      }
    }

    function saveLocalMeta() {
      localStorage.setItem(STATE_META_KEY, JSON.stringify(localMeta));
    }

    function setLocalMeta(partial) {
      if (!localMeta || typeof localMeta !== "object") {
        localMeta = loadLocalMeta();
      }
      localMeta = {
        ...localMeta,
        ...partial
      };
      saveLocalMeta();
    }

    function parseIsoTime(iso) {
      const time = Date.parse(String(iso || ""));
      return Number.isFinite(time) ? time : 0;
    }

    function isCloudConfigured() {
      if (!supabaseConfig) {
        supabaseConfig = loadSupabaseConfig();
      }
      return Boolean(supabaseConfig.url && supabaseConfig.anonKey && supabaseConfig.workspace);
    }

    function setCloudBusy(isBusy) {
      const btn = document.getElementById("cloudSyncBtn");
      if (!btn) {
        return;
      }
      btn.classList.toggle("cloud-busy", Boolean(isBusy));
    }

    function updateCloudButtons() {
      const configBtn = document.getElementById("cloudConfigBtn");
      const syncBtn = document.getElementById("cloudSyncBtn");
      if (!configBtn || !syncBtn) {
        return;
      }
      const ready = isCloudConfigured();
      configBtn.classList.toggle("cloud-ready", ready);
      syncBtn.classList.toggle("cloud-ready", ready);
      const desc = ready
        ? `${supabaseConfig.workspace} @ ${supabaseConfig.table}${supabaseConfig.autoSync ? "ÔºàËá™Âä®Ôºâ" : ""}`
        : "Êú™ÈÖçÁΩÆ";
      configBtn.title = `Supabase ÈÖçÁΩÆ/ÁÆ°ÁêÜÔºà${desc}Ôºâ`;
      syncBtn.title = `Supabase ÂèåÂêëÂêåÊ≠•Ôºà${desc}Ôºâ`;
    }

    function showSupabaseConfigModal(initialConfig) {
      return new Promise((resolve) => {
        const existing = document.getElementById("cloudConfigModal");
        if (existing) {
          existing.remove();
        }

        const backdrop = document.createElement("div");
        backdrop.className = "cloud-modal-backdrop";
        backdrop.id = "cloudConfigModal";

        const modal = document.createElement("div");
        modal.className = "cloud-modal";

        const head = document.createElement("div");
        head.className = "cloud-modal-head";
        const title = document.createElement("h3");
        title.className = "cloud-modal-title";
        title.textContent = "Supabase ‰∫ëÂêåÊ≠•ÈÖçÁΩÆ";
        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "cloud-modal-btn";
        closeBtn.textContent = "ÂÖ≥Èó≠";
        head.appendChild(title);
        head.appendChild(closeBtn);

        const body = document.createElement("div");
        body.className = "cloud-modal-body";

        const rowUrl = document.createElement("label");
        rowUrl.className = "cloud-modal-row";
        rowUrl.innerHTML = '<span class="cloud-modal-label">Project URL</span>';
        const inputUrl = document.createElement("input");
        inputUrl.className = "cloud-modal-input";
        inputUrl.type = "text";
        inputUrl.placeholder = "https://xxxx.supabase.co";
        inputUrl.value = initialConfig.url || "";
        rowUrl.appendChild(inputUrl);

        const rowKey = document.createElement("label");
        rowKey.className = "cloud-modal-row";
        rowKey.innerHTML = '<span class="cloud-modal-label">Anon Key</span>';
        const inputKey = document.createElement("input");
        inputKey.className = "cloud-modal-input";
        inputKey.type = "password";
        inputKey.placeholder = "eyJhbGciOi...";
        inputKey.value = initialConfig.anonKey || "";
        rowKey.appendChild(inputKey);

        const rowWorkspace = document.createElement("label");
        rowWorkspace.className = "cloud-modal-row";
        rowWorkspace.innerHTML = '<span class="cloud-modal-label">WorkspaceÔºàË∑®ËÆæÂ§á‰∏ÄËá¥Ôºâ</span>';
        const inputWorkspace = document.createElement("input");
        inputWorkspace.className = "cloud-modal-input";
        inputWorkspace.type = "text";
        inputWorkspace.placeholder = "default";
        inputWorkspace.value = initialConfig.workspace || "default";
        rowWorkspace.appendChild(inputWorkspace);

        const rowTable = document.createElement("label");
        rowTable.className = "cloud-modal-row";
        rowTable.innerHTML = '<span class="cloud-modal-label">Table</span>';
        const inputTable = document.createElement("input");
        inputTable.className = "cloud-modal-input";
        inputTable.type = "text";
        inputTable.placeholder = DEFAULT_SUPABASE_TABLE;
        inputTable.value = initialConfig.table || DEFAULT_SUPABASE_TABLE;
        rowTable.appendChild(inputTable);

        const rowAuto = document.createElement("label");
        rowAuto.className = "cloud-modal-check";
        const inputAuto = document.createElement("input");
        inputAuto.type = "checkbox";
        inputAuto.checked = Boolean(initialConfig.autoSync);
        rowAuto.appendChild(inputAuto);
        rowAuto.appendChild(document.createTextNode("ÂºÄÂêØËá™Âä®ÂêåÊ≠•ÔºàÊØèÊ¨°‰øùÂ≠òÂêéËá™Âä®‰∏ä‰º†Ôºâ"));

        const err = document.createElement("p");
        err.className = "cloud-modal-error";
        err.textContent = "";

        body.appendChild(rowUrl);
        body.appendChild(rowKey);
        body.appendChild(rowWorkspace);
        body.appendChild(rowTable);
        body.appendChild(rowAuto);
        body.appendChild(err);

        const foot = document.createElement("div");
        foot.className = "cloud-modal-foot";
        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "cloud-modal-btn";
        cancelBtn.textContent = "ÂèñÊ∂à";
        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.className = "cloud-modal-btn primary";
        saveBtn.textContent = "‰øùÂ≠ò";
        foot.appendChild(cancelBtn);
        foot.appendChild(saveBtn);

        modal.appendChild(head);
        modal.appendChild(body);
        modal.appendChild(foot);
        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);

        const close = (result) => {
          backdrop.remove();
          resolve(result);
        };

        const submit = () => {
          const url = String(inputUrl.value || "").trim();
          const anonKey = String(inputKey.value || "").trim();
          const workspace = String(inputWorkspace.value || "").trim() || "default";
          const table = String(inputTable.value || "").trim() || DEFAULT_SUPABASE_TABLE;
          const autoSync = Boolean(inputAuto.checked);

          if (!url) {
            err.textContent = "Project URL ‰∏çËÉΩ‰∏∫Á©∫„ÄÇ";
            inputUrl.focus();
            return;
          }
          if (!anonKey) {
            err.textContent = "Anon Key ‰∏çËÉΩ‰∏∫Á©∫„ÄÇ";
            inputKey.focus();
            return;
          }
          err.textContent = "";
          close({
            url,
            anonKey,
            workspace,
            table,
            autoSync
          });
        };

        closeBtn.onclick = () => close(null);
        cancelBtn.onclick = () => close(null);
        saveBtn.onclick = submit;

        backdrop.addEventListener("click", (event) => {
          if (event.target === backdrop) {
            close(null);
          }
        });

        modal.addEventListener("click", (event) => {
          event.stopPropagation();
        });

        inputUrl.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            inputKey.focus();
          }
        });
        inputKey.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            inputWorkspace.focus();
          }
        });
        inputWorkspace.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            inputTable.focus();
          }
        });
        inputTable.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            submit();
          }
        });

        setTimeout(() => inputUrl.focus(), 0);
      });
    }

    function cloudErrorMessage(error) {
      if (!error) {
        return "Êú™Áü•ÈîôËØØ";
      }
      if (typeof error.message === "string" && error.message.trim()) {
        return error.message;
      }
      return String(error);
    }

    function getSupabaseClient() {
      if (!isCloudConfigured()) {
        throw new Error("ËØ∑ÂÖàÈÖçÁΩÆ Supabase„ÄÇ");
      }
      if (!window.supabase || typeof window.supabase.createClient !== "function") {
        throw new Error("Supabase SDK Êú™Âä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú„ÄÇ");
      }
      const signature = `${supabaseConfig.url}|${supabaseConfig.anonKey}`;
      if (!supabaseClient || supabaseClientSignature !== signature) {
        supabaseClient = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
        supabaseClientSignature = signature;
      }
      return supabaseClient;
    }

    async function fetchCloudRecord() {
      const client = getSupabaseClient();
      const { data, error } = await client
        .from(supabaseConfig.table || DEFAULT_SUPABASE_TABLE)
        .select("workspace,payload,updated_at")
        .eq("workspace", supabaseConfig.workspace)
        .maybeSingle();
      if (error) {
        throw error;
      }
      return data || null;
    }

    async function pushStateToCloud(reason = "manual", silent = false) {
      if (!isCloudConfigured()) {
        if (!silent) {
          alert("ËØ∑ÂÖàÈÖçÁΩÆ Supabase„ÄÇ");
        }
        return false;
      }
      if (cloudSyncInFlight) {
        return false;
      }
      cloudSyncInFlight = true;
      setCloudBusy(true);
      try {
        const client = getSupabaseClient();
        const nowIso = new Date().toISOString();
        const payload = mergeState(state);
        const deviceName = (navigator.userAgent || "browser").slice(0, 160);
        const { error } = await client
          .from(supabaseConfig.table || DEFAULT_SUPABASE_TABLE)
          .upsert(
            {
              workspace: supabaseConfig.workspace,
              payload,
              updated_at: nowIso,
              updated_by: `${reason}:${deviceName}`
            },
            { onConflict: "workspace" }
          );
        if (error) {
          throw error;
        }
        setLocalMeta({
          localUpdatedAt: nowIso,
          lastCloudSyncAt: nowIso
        });
        if (!silent) {
          alert("Â∑≤Êé®ÈÄÅÂà∞ Supabase„ÄÇ");
        }
        return true;
      } catch (error) {
        if (!silent) {
          alert(`‰∫ëÁ´ØÊé®ÈÄÅÂ§±Ë¥•Ôºö${cloudErrorMessage(error)}`);
        }
        return false;
      } finally {
        cloudSyncInFlight = false;
        setCloudBusy(false);
        updateCloudButtons();
      }
    }

    function queueCloudPush(reason = "auto") {
      if (!isCloudConfigured() || !supabaseConfig.autoSync) {
        return;
      }
      if (cloudPushTimer) {
        clearTimeout(cloudPushTimer);
      }
      cloudPushTimer = setTimeout(() => {
        cloudPushTimer = null;
        pushStateToCloud(reason, true);
      }, CLOUD_PUSH_DEBOUNCE_MS);
    }

    function saveState(options = {}) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const updatedAt = typeof options.updatedAt === "string"
        ? options.updatedAt
        : new Date().toISOString();
      setLocalMeta({ localUpdatedAt: updatedAt });
      if (!options.skipCloud) {
        queueCloudPush("save");
      }
      updateCloudButtons();
    }

    function normalizeTodo(todo) {
      const normalized = {
        text: typeof todo?.text === "string" ? todo.text : "",
        done: Boolean(todo?.done),
        subs: []
      };
      if (Array.isArray(todo?.subs)) {
        normalized.subs = todo.subs.map((sub) => ({
          text: typeof sub?.text === "string" ? sub.text : "",
          done: Boolean(sub?.done)
        }));
      }
      return normalized;
    }

    function normalizeFqa(item) {
      const subs = Array.isArray(item?.subs)
        ? item.subs.map((sub) => {
          if (typeof sub === "string") {
            return sub;
          }
          return typeof sub?.text === "string" ? sub.text : "";
        })
        : [];
      return {
        question: typeof item?.question === "string" ? item.question : "",
        answer: typeof item?.answer === "string" ? item.answer : "",
        subs,
        expanded: Boolean(item?.expanded)
      };
    }

    function normalizePrinciple(item) {
      if (typeof item === "string") {
        return { text: item, subs: [] };
      }
      return {
        text: typeof item?.text === "string" ? item.text : "",
        subs: Array.isArray(item?.subs)
          ? item.subs.map((sub) => {
            if (typeof sub === "string") {
              return sub;
            }
            return typeof sub?.text === "string" ? sub.text : "";
          })
          : []
      };
    }

    function normalizeSop(item) {
      return {
        text: typeof item?.text === "string" ? item.text : "",
        done: Boolean(item?.done),
        fileName: typeof item?.fileName === "string" ? item.fileName : "",
        fileType: typeof item?.fileType === "string" ? item.fileType : "",
        fileData: typeof item?.fileData === "string" ? item.fileData : "",
        subs: Array.isArray(item?.subs)
          ? item.subs.map((sub) => {
            if (typeof sub === "string") {
              return sub;
            }
            return typeof sub?.text === "string" ? sub.text : "";
          })
          : []
      };
    }

    function firstLineText(value) {
      const raw = String(value == null ? "" : value);
      const line = raw.split(/\r?\n/)[0] || "";
      return line.trim();
    }

    function normalizeGoals(goals) {
      const normalizeSubs = (subs) => {
        if (!Array.isArray(subs)) {
          return [];
        }
        return subs.map((item) => (typeof item === "string" ? item : ""));
      };
      const normalizePlanItem = (item) => ({
        text: typeof item?.text === "string" ? item.text : "",
        subs: Array.isArray(item?.subs)
          ? item.subs.map((sub) => {
            if (typeof sub === "string") {
              return sub;
            }
            return typeof sub?.text === "string" ? sub.text : "";
          })
          : []
      });
      const normalizePlanList = (plans, fallbackText, fallbackSubs) => {
        const normalized = Array.isArray(plans)
          ? plans.map((item) => normalizePlanItem(item))
          : [];
        if (normalized.length) {
          return normalized;
        }
        const main = typeof fallbackText === "string" ? fallbackText : "";
        const subs = normalizeSubs(fallbackSubs);
        if (main || subs.length) {
          return [{ text: main, subs }];
        }
        return [{ text: "", subs: [] }];
      };
      const shortPlans = normalizePlanList(
        goals?.shortPlans,
        goals?.shortTerm,
        goals?.shortTermSubs
      );
      const longPlans = normalizePlanList(
        goals?.longPlans,
        goals?.longTerm,
        goals?.longTermSubs
      );
      const shortMain = shortPlans[0]?.text || "";
      const longMain = longPlans[0]?.text || "";
      const shortSubs = Array.isArray(shortPlans[0]?.subs) ? shortPlans[0].subs.slice() : [];
      const longSubs = Array.isArray(longPlans[0]?.subs) ? longPlans[0].subs.slice() : [];
      return {
        shortTerm: typeof goals?.shortTerm === "string" ? goals.shortTerm : shortMain,
        longTerm: typeof goals?.longTerm === "string" ? goals.longTerm : longMain,
        shortTermSubs: normalizeSubs(goals?.shortTermSubs).length
          ? normalizeSubs(goals?.shortTermSubs)
          : shortSubs,
        longTermSubs: normalizeSubs(goals?.longTermSubs).length
          ? normalizeSubs(goals?.longTermSubs)
          : longSubs,
        shortPlans,
        longPlans,
        activeType: goals?.activeType === "long" ? "long" : "short",
        expanded: Boolean(goals?.expanded)
      };
    }

    function getGoalPlansByType(type) {
      if (!state.goals || typeof state.goals !== "object") {
        state.goals = normalizeGoals(null);
      }
      const key = type === "long" ? "longPlans" : "shortPlans";
      if (!Array.isArray(state.goals[key])) {
        state.goals[key] = [{ text: "", subs: [] }];
      }
      if (!state.goals[key].length) {
        state.goals[key].push({ text: "", subs: [] });
      }
      return state.goals[key];
    }

    function syncLegacyGoalFields() {
      if (!state.goals || typeof state.goals !== "object") {
        state.goals = normalizeGoals(null);
      }
      const shortPlans = getGoalPlansByType("short");
      const longPlans = getGoalPlansByType("long");
      state.goals.shortTerm = shortPlans[0]?.text || "";
      state.goals.longTerm = longPlans[0]?.text || "";
      state.goals.shortTermSubs = Array.isArray(shortPlans[0]?.subs)
        ? shortPlans[0].subs.slice()
        : [];
      state.goals.longTermSubs = Array.isArray(longPlans[0]?.subs)
        ? longPlans[0].subs.slice()
        : [];
    }

    function fitTextareaHeight(textarea) {
      if (!textarea) {
        return;
      }
      const minHeight = Number(textarea.dataset.minHeight || 26);
      textarea.style.height = "0px";
      textarea.style.height = `${Math.max(textarea.scrollHeight, minHeight)}px`;
    }

    function refreshAutoGrowTextareas() {
      if (autoGrowRefreshRaf) {
        cancelAnimationFrame(autoGrowRefreshRaf);
      }
      autoGrowRefreshRaf = requestAnimationFrame(() => {
        autoGrowRefreshRaf = null;
        document.querySelectorAll("textarea.todo-input, textarea.text-input, textarea.goal-input").forEach((textarea) => {
          fitTextareaHeight(textarea);
        });
      });
    }

    function bindAutoGrowViewportListeners() {
      if (autoGrowViewportBound) {
        return;
      }
      autoGrowViewportBound = true;
      const onResize = () => refreshAutoGrowTextareas();
      window.addEventListener("resize", onResize, { passive: true });
      window.addEventListener("orientationchange", onResize, { passive: true });
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", onResize, { passive: true });
      }
    }

    function wireAutoGrow(textarea, minHeight = 26) {
      if (!textarea) {
        return;
      }
      textarea.dataset.minHeight = String(minHeight);
      const fit = () => fitTextareaHeight(textarea);
      fit();
      requestAnimationFrame(fit);
      setTimeout(fit, 0);
      textarea.addEventListener("input", fit);
      textarea.addEventListener("change", fit);
      textarea.addEventListener("focus", fit);
    }

    function percent(value) {
      return `${Math.max(0, Math.min(100, Math.round(value)))}%`;
    }

    function moduleProgress(module) {
      if (!module.todos.length) {
        return 0;
      }
      let totalCount = 0;
      let doneCount = 0;
      module.todos.forEach((todo) => {
        totalCount += 1;
        if (todo.done) {
          doneCount += 1;
        }
        if (Array.isArray(todo.subs)) {
          totalCount += todo.subs.length;
          doneCount += todo.subs.filter((sub) => sub.done).length;
        }
      });
      if (!totalCount) {
        return 0;
      }
      return (doneCount / totalCount) * 100;
    }

    function getVisibleModules() {
      return state.modules.filter((m) => m.mode === state.modeFilter);
    }

    function getActiveModule() {
      return state.modules.find((m) => m.id === state.activeModuleId) || null;
    }

    function ensureActiveModuleVisible() {
      const visible = getVisibleModules();
      if (!visible.length) {
        state.activeModuleId = "";
        return;
      }
      if (!visible.some((m) => m.id === state.activeModuleId)) {
        state.activeModuleId = visible[0].id;
      }
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60).toString().padStart(2, "0");
      const sec = Math.floor(seconds % 60).toString().padStart(2, "0");
      return `${min}:${sec}`;
    }

    function switchLayer(layer) {
      state.layer = layer;
      saveState();
      renderLayer();
    }

    function encodeBase64Utf8(value) {
      try {
        const bytes = new TextEncoder().encode(String(value));
        const chunkSize = 0x8000;
        let binary = "";
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
      } catch (error) {
        return "";
      }
    }

    function decodeBase64Utf8(value) {
      try {
        const binary = atob(String(value));
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder().decode(bytes);
      } catch (error) {
        return "";
      }
    }

    function parseCsv(text) {
      const content = String(text || "").replace(/^\uFEFF/, "");
      const rows = [];
      let row = [];
      let cell = "";
      let inQuotes = false;

      for (let i = 0; i < content.length; i += 1) {
        const ch = content[i];

        if (ch === "\"") {
          if (inQuotes && content[i + 1] === "\"") {
            cell += "\"";
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (!inQuotes && ch === ",") {
          row.push(cell);
          cell = "";
          continue;
        }

        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && content[i + 1] === "\n") {
            i += 1;
          }
          row.push(cell);
          rows.push(row);
          row = [];
          cell = "";
          continue;
        }

        cell += ch;
      }

      if (cell.length || row.length) {
        row.push(cell);
        rows.push(row);
      }

      return rows;
    }

    function parseExtra(extra) {
      const map = {};
      if (typeof extra !== "string" || !extra.trim()) {
        return map;
      }
      extra.split(";").forEach((part) => {
        const idx = part.indexOf("=");
        if (idx <= 0) {
          return;
        }
        const key = part.slice(0, idx).trim();
        const val = part.slice(idx + 1);
        if (key) {
          map[key] = val;
        }
      });
      return map;
    }

    function parseDoneStatus(value) {
      return String(value || "").trim().toLowerCase() === "done";
    }

    function importStateFromCsv(text) {
      const rows = parseCsv(text);
      if (!rows.length) {
        throw new Error("empty_csv");
      }

      const snapshotRow = rows.find((row) => row[0] === "Meta" && row[1] === "StateSnapshot");
      if (snapshotRow && snapshotRow[6]) {
        const snapshotRaw = decodeBase64Utf8(snapshotRow[6]);
        const snapshot = JSON.parse(snapshotRaw);
        return mergeState(snapshot);
      }

      const next = clone(defaultState);
      next.modules.forEach((module) => {
        module.todos = [];
        module.remainingSeconds = module.duration * 60;
      });
      DOMAIN_ORDER.forEach((key) => {
        const domain = next.dashboard.domains[key];
        domain.fqas = [];
        domain.principles = [];
        domain.sops = [];
      });

      const moduleById = new Map(next.modules.map((module) => [module.id, module]));
      const moduleByTitle = new Map(next.modules.map((module) => [module.title, module]));
      const domainByName = new Map(
        DOMAIN_ORDER.map((key) => [next.dashboard.domains[key].name, key])
      );

      const getModule = (group, extra) => {
        const extraMap = parseExtra(extra);
        if (extraMap.id && moduleById.has(extraMap.id)) {
          return moduleById.get(extraMap.id);
        }
        if (moduleByTitle.has(group)) {
          return moduleByTitle.get(group);
        }
        return null;
      };

      const ensureTodo = (module, idx) => {
        while (module.todos.length <= idx) {
          module.todos.push({ text: "", done: false, subs: [] });
        }
        if (!Array.isArray(module.todos[idx].subs)) {
          module.todos[idx].subs = [];
        }
        return module.todos[idx];
      };

      const ensureFqa = (domain, idx) => {
        while (domain.fqas.length <= idx) {
          domain.fqas.push({ question: "", answer: "", subs: [], expanded: false });
        }
        if (!Array.isArray(domain.fqas[idx].subs)) {
          domain.fqas[idx].subs = [];
        }
        return domain.fqas[idx];
      };

      const ensurePrinciple = (domain, idx) => {
        while (domain.principles.length <= idx) {
          domain.principles.push({ text: "", subs: [] });
        }
        if (typeof domain.principles[idx] === "string") {
          domain.principles[idx] = { text: domain.principles[idx], subs: [] };
        }
        if (!Array.isArray(domain.principles[idx].subs)) {
          domain.principles[idx].subs = [];
        }
        return domain.principles[idx];
      };

      const ensureSop = (domain, idx) => {
        while (domain.sops.length <= idx) {
          domain.sops.push({
            text: "",
            done: false,
            fileName: "",
            fileType: "",
            fileData: "",
            subs: []
          });
        }
        if (!Array.isArray(domain.sops[idx].subs)) {
          domain.sops[idx].subs = [];
        }
        return domain.sops[idx];
      };

      for (let i = 1; i < rows.length; i += 1) {
        const row = rows[i];
        if (!row || !row.length) {
          continue;
        }
        const section = row[0] || "";
        const category = row[1] || "";
        const group = row[2] || "";
        const item = row[3] || "";
        const subItem = row[4] || "";
        const status = row[5] || "";
        const value = row[6] || "";
        const extra = row[7] || "";
        const extraMap = parseExtra(extra);

        if (section === "Meta" && category === "DailyBudgetMinutes") {
          const budget = Number(value);
          if (Number.isFinite(budget) && budget > 0) {
            next.dailyBudgetMinutes = Math.round(budget);
          }
          continue;
        }

        if (section === "Meta" && category === "ShortTermGoal") {
          next.goals.shortTerm = value || "";
          continue;
        }

        if (section === "Meta" && category === "LongTermGoal") {
          next.goals.longTerm = value || "";
          continue;
        }

        if (section === "Meta" && category === "ShortTermGoalSub") {
          next.goals.shortTermSubs.push(value || "");
          continue;
        }

        if (section === "Meta" && category === "LongTermGoalSub") {
          next.goals.longTermSubs.push(value || "");
          continue;
        }

        if (section === "SOP") {
          const module = getModule(group, extra);
          if (!module) {
            continue;
          }

          if (category === "Module") {
            const duration = Number(value);
            if (Number.isFinite(duration) && duration > 0) {
              module.duration = Math.round(duration);
            }
            const remaining = Number(extraMap.remaining);
            module.remainingSeconds = Number.isFinite(remaining) && remaining >= 0
              ? Math.floor(remaining)
              : module.duration * 60;
            continue;
          }

          if (category === "Todo") {
            const todoIdx = Math.max(0, Number(item) - 1);
            const todo = ensureTodo(module, todoIdx);
            todo.text = value;
            todo.done = parseDoneStatus(status);
            continue;
          }

          if (category === "SubTodo") {
            const todoIdx = Math.max(0, Number(item) - 1);
            const subIdx = Math.max(0, Number(subItem) - 1);
            const todo = ensureTodo(module, todoIdx);
            while (todo.subs.length <= subIdx) {
              todo.subs.push({ text: "", done: false });
            }
            todo.subs[subIdx].text = value;
            todo.subs[subIdx].done = parseDoneStatus(status);
          }
          continue;
        }

        if (section === "Dashboard") {
          const key = extraMap.key || domainByName.get(group);
          if (!key || !next.dashboard.domains[key]) {
            continue;
          }
          const domain = next.dashboard.domains[key];
          const idx = Math.max(0, Number(item) - 1);

          if (category === "FQA") {
            const target = ensureFqa(domain, idx);
            if (subItem === "Q") {
              target.question = value;
            } else if (subItem === "A") {
              target.answer = value;
            }
            continue;
          }

          if (category === "Principles") {
            const target = ensurePrinciple(domain, idx);
            target.text = value;
            continue;
          }

          if (category === "SOP‰∏éÊ®°Áâà") {
            const target = ensureSop(domain, idx);
            target.text = value;
            target.done = parseDoneStatus(status);
            if (extraMap.fileNameB64) {
              target.fileName = decodeBase64Utf8(extraMap.fileNameB64);
            } else if (extraMap.fileName) {
              target.fileName = extraMap.fileName;
            }
            if (extraMap.fileTypeB64) {
              target.fileType = decodeBase64Utf8(extraMap.fileTypeB64);
            } else if (extraMap.fileType) {
              target.fileType = extraMap.fileType;
            }
            if (extraMap.fileDataB64) {
              target.fileData = decodeBase64Utf8(extraMap.fileDataB64);
            } else if (extraMap.fileData) {
              target.fileData = extraMap.fileData;
            } else if (row[7] && !extraMap.key) {
              target.fileName = row[7];
            }
          }
        }
      }

      return mergeState(next);
    }

    function applyImportedState(nextState) {
      stopTimer();
      state = mergeState(nextState);
      ensureActiveModuleVisible();
      saveState();
      renderLayer();
    }

    function applyCloudState(payload, remoteUpdatedAt = "") {
      stopTimer();
      state = mergeState(payload);
      ensureActiveModuleVisible();
      saveState({
        skipCloud: true,
        updatedAt: remoteUpdatedAt || new Date().toISOString()
      });
      setLocalMeta({
        lastCloudSyncAt: remoteUpdatedAt || new Date().toISOString()
      });
      renderLayer();
    }

    async function pullStateFromCloud({ onlyIfNewer = false, silent = false } = {}) {
      if (!isCloudConfigured()) {
        if (!silent) {
          alert("ËØ∑ÂÖàÈÖçÁΩÆ Supabase„ÄÇ");
        }
        return false;
      }
      if (cloudSyncInFlight) {
        return false;
      }
      cloudSyncInFlight = true;
      setCloudBusy(true);
      try {
        const remote = await fetchCloudRecord();
        if (!remote || !remote.payload) {
          if (!silent) {
            alert("‰∫ëÁ´ØÊöÇÊó†ÂèØÁî®Êï∞ÊçÆ„ÄÇ");
          }
          return false;
        }
        const remoteTime = parseIsoTime(remote.updated_at);
        const localTime = parseIsoTime(localMeta?.localUpdatedAt);
        if (onlyIfNewer && remoteTime <= localTime) {
          return false;
        }
        applyCloudState(remote.payload, remote.updated_at || "");
        if (!silent) {
          alert("Â∑≤‰ªé Supabase ÊãâÂèñÊï∞ÊçÆ„ÄÇ");
        }
        return true;
      } catch (error) {
        if (!silent) {
          alert(`‰∫ëÁ´ØÊãâÂèñÂ§±Ë¥•Ôºö${cloudErrorMessage(error)}`);
        }
        return false;
      } finally {
        cloudSyncInFlight = false;
        setCloudBusy(false);
        updateCloudButtons();
      }
    }

    async function syncCloudBidirectional(options = {}) {
      const silent = Boolean(options?.silent);
      if (!isCloudConfigured()) {
        if (!silent) {
          alert("ËØ∑ÂÖàÈÖçÁΩÆ Supabase„ÄÇ");
        }
        return false;
      }
      if (cloudSyncInFlight) {
        return false;
      }
      cloudSyncInFlight = true;
      setCloudBusy(true);
      try {
        const remote = await fetchCloudRecord();
        if (!remote || !remote.payload) {
          cloudSyncInFlight = false;
          setCloudBusy(false);
          const pushed = await pushStateToCloud("init-empty", true);
          if (!silent) {
            alert(pushed ? "‰∫ëÁ´Ø‰∏∫Á©∫ÔºåÂ∑≤‰∏ä‰º†Êú¨Âú∞Êï∞ÊçÆ„ÄÇ" : "‰∫ëÁ´Ø‰∏∫Á©∫Ôºå‰∏ä‰º†Â§±Ë¥•„ÄÇ");
          }
          return pushed;
        }
        const remoteTime = parseIsoTime(remote.updated_at);
        const localTime = parseIsoTime(localMeta?.localUpdatedAt);
        if (remoteTime > localTime) {
          applyCloudState(remote.payload, remote.updated_at || "");
          if (!silent) {
            alert("‰∫ëÁ´ØËæÉÊñ∞ÔºåÂ∑≤ÊãâÂèñÂà∞Êú¨Âú∞„ÄÇ");
          }
          return true;
        }
        cloudSyncInFlight = false;
        setCloudBusy(false);
        const pushed = await pushStateToCloud("sync", true);
        if (!silent) {
          alert(pushed ? "Êú¨Âú∞ËæÉÊñ∞ÔºåÂ∑≤Êé®ÈÄÅÂà∞‰∫ëÁ´Ø„ÄÇ" : "ÂêåÊ≠•Â§±Ë¥•„ÄÇ");
        }
        return pushed;
      } catch (error) {
        if (!silent) {
          alert(`ÂêåÊ≠•Â§±Ë¥•Ôºö${cloudErrorMessage(error)}`);
        }
        return false;
      } finally {
        cloudSyncInFlight = false;
        setCloudBusy(false);
        updateCloudButtons();
      }
    }

    async function configureSupabase() {
      const current = normalizeSupabaseConfig(supabaseConfig);
      const next = await showSupabaseConfigModal(current);
      if (!next) {
        return;
      }
      saveSupabaseConfig(next);

      try {
        setCloudBusy(true);
        await fetchCloudRecord();
        alert("Supabase Â∑≤ËøûÊé•ÊàêÂäü„ÄÇ");
      } catch (error) {
        alert(`ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºå‰ΩÜËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö${cloudErrorMessage(error)}`);
      } finally {
        setCloudBusy(false);
        updateCloudButtons();
      }
    }

    async function openCloudMenu() {
      const ready = isCloudConfigured();
      const menu = [
        "Supabase ‰∫ëÂêåÊ≠•",
        "1 ÈÖçÁΩÆ/‰øÆÊîπËøûÊé•",
        "2 ÂèåÂêëÂêåÊ≠•ÔºàÊé®ËçêÔºâ",
        "3 ‰ªÖ‰∏ä‰º†Êú¨Âú∞ -> ‰∫ëÁ´Ø",
        "4 ‰ªÖÊãâÂèñ‰∫ëÁ´Ø -> Êú¨Âú∞",
        "5 Ê∏ÖÈô§ËøûÊé•ÈÖçÁΩÆ",
        `ÂΩìÂâçÔºö${ready ? `${supabaseConfig.workspace} @ ${supabaseConfig.table}` : "Êú™ÈÖçÁΩÆ"}`
      ].join("\n");
      const choice = window.prompt(menu, ready ? "2" : "1");
      if (choice === null) {
        return;
      }
      const action = String(choice).trim();
      if (action === "1") {
        await configureSupabase();
        return;
      }
      if (action === "2") {
        await syncCloudBidirectional();
        return;
      }
      if (action === "3") {
        await pushStateToCloud("manual");
        return;
      }
      if (action === "4") {
        await pullStateFromCloud();
        return;
      }
      if (action === "5") {
        clearSupabaseConfig();
        alert("Supabase ÈÖçÁΩÆÂ∑≤Ê∏ÖÈô§„ÄÇ");
      }
    }

    async function initCloudSyncOnStartup() {
      if (!isCloudConfigured()) {
        updateCloudButtons();
        return;
      }
      await syncCloudBidirectional({ silent: true });
      updateCloudButtons();
    }

    function triggerImport() {
      const input = document.getElementById("importFileInput");
      if (!input) {
        return;
      }
      input.value = "";
      input.click();
    }

    function handleImportFile(event) {
      const file = event.target?.files?.[0];
      event.target.value = "";
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const content = typeof reader.result === "string" ? reader.result : "";
          if (!content.trim()) {
            alert("ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ");
            return;
          }
          const lowerName = String(file.name || "").toLowerCase();
          if (lowerName.endsWith(".json") || content.trim().startsWith("{")) {
            const parsed = JSON.parse(content);
            applyImportedState(parsed);
            alert("ÂØºÂÖ•ÊàêÂäüÔºöJSON Êï∞ÊçÆÂ∑≤ÊÅ¢Â§ç„ÄÇ");
            return;
          }
          const imported = importStateFromCsv(content);
          applyImportedState(imported);
          alert("ÂØºÂÖ•ÊàêÂäüÔºöCSV Êï∞ÊçÆÂ∑≤ÊÅ¢Â§ç„ÄÇ");
        } catch (error) {
          alert("ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÂÜÖÂÆπÊçüÂùè„ÄÇ");
        }
      };
      reader.readAsText(file);
    }

    function setModeFilter(mode) {
      state.modeFilter = mode;
      ensureActiveModuleVisible();
      stopTimer();
      saveState();
      renderSop();
    }

    function selectModule(moduleId) {
      if (state.activeModuleId === moduleId) {
        return;
      }
      state.activeModuleId = moduleId;
      stopTimer();
      saveState();
      renderSop();
    }

    function bindGoalWidgetEvents() {
      if (goalWidgetBound) {
        return;
      }
      goalWidgetBound = true;
      if (!state.goals || typeof state.goals !== "object") {
        state.goals = normalizeGoals(null);
      }
      const fabBtn = document.getElementById("goalFabBtn");
      const closeBtn = document.getElementById("goalCloseBtn");
      const shortBtn = document.getElementById("goalTypeShortBtn");
      const longBtn = document.getElementById("goalTypeLongBtn");
      const addGoalItemBtn = document.getElementById("addGoalItemBtn");
      if (!fabBtn || !closeBtn || !shortBtn || !longBtn || !addGoalItemBtn) {
        return;
      }

      fabBtn.onclick = () => {
        state.goals.expanded = !state.goals.expanded;
        saveState();
        renderGoalWidget();
      };
      closeBtn.onclick = () => {
        state.goals.expanded = false;
        saveState();
        renderGoalWidget();
      };

      shortBtn.onclick = () => {
        state.goals.activeType = "short";
        saveState();
        renderGoalWidget();
      };
      longBtn.onclick = () => {
        state.goals.activeType = "long";
        saveState();
        renderGoalWidget();
      };

      addGoalItemBtn.onclick = () => {
        const activeType = state.goals.activeType === "long" ? "long" : "short";
        const plans = getGoalPlansByType(activeType);
        plans.push({ text: "", subs: [] });
        syncLegacyGoalFields();
        saveState();
        renderGoalWidget();
      };
    }

    function renderGoalWidget() {
      if (!state.goals || typeof state.goals !== "object") {
        state.goals = normalizeGoals(null);
      }
      const wrap = document.getElementById("goalFabWrap");
      const fabBtn = document.getElementById("goalFabBtn");
      const shortBtn = document.getElementById("goalTypeShortBtn");
      const longBtn = document.getElementById("goalTypeLongBtn");
      const goalListTitle = document.getElementById("goalListTitle");
      const goalTaskList = document.getElementById("goalTaskList");
      if (!wrap || !fabBtn || !shortBtn || !longBtn || !goalListTitle || !goalTaskList) {
        return;
      }

      const activeType = state.goals.activeType === "long" ? "long" : "short";
      const activePlans = getGoalPlansByType(activeType);
      syncLegacyGoalFields();

      wrap.classList.toggle("goal-expanded", Boolean(state.goals.expanded));
      fabBtn.textContent = state.goals.expanded ? "√ó" : "üéØ";
      fabBtn.title = state.goals.expanded ? "Êî∂Ëµ∑ÁõÆÊ†áÈù¢Êùø" : "Â±ïÂºÄÁõÆÊ†áÈù¢Êùø";
      fabBtn.setAttribute("aria-label", state.goals.expanded ? "Êî∂Ëµ∑ÁõÆÊ†áÈù¢Êùø" : "Â±ïÂºÄÁõÆÊ†áÈù¢Êùø");

      shortBtn.classList.toggle("active", activeType === "short");
      longBtn.classList.toggle("active", activeType === "long");
      goalListTitle.textContent = activeType === "short" ? "Áü≠ÊúüÁõÆÊ†á" : "ÈïøÊúüÁõÆÊ†á";

      goalTaskList.innerHTML = "";
      if (!activePlans.length) {
        const empty = document.createElement("p");
        empty.className = "goal-task-empty";
        empty.textContent = "ÁÇπÂáª + Êñ∞Â¢ûÁõÆÊ†áÈ°π„ÄÇ";
        goalTaskList.appendChild(empty);
      }

      activePlans.forEach((item, idx) => {
        const node = document.createElement("div");
        node.className = "todo-node";

        const row = document.createElement("div");
        row.className = "goal-task-row";

        const input = document.createElement("textarea");
        input.rows = 1;
        input.className = "todo-input";
        input.placeholder = "Â°´ÂÜôÁõÆÊ†áÈ°π...";
        input.value = item.text || "";
        input.addEventListener("input", (event) => {
          const plans = getGoalPlansByType(activeType);
          if (!plans[idx]) {
            return;
          }
          plans[idx].text = event.target.value;
          syncLegacyGoalFields();
          saveState();
        });
        wireAutoGrow(input, 26);

        const actions = document.createElement("div");
        actions.className = "goal-task-actions";
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÈ°π";
        addSubBtn.onclick = () => {
          const plans = getGoalPlansByType(activeType);
          const current = plans[idx];
          if (!current) {
            return;
          }
          if (!Array.isArray(current.subs)) {
            current.subs = [];
          }
          current.subs.push("");
          syncLegacyGoalFields();
          saveState();
          renderGoalWidget();
        };
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "todo-del";
        delBtn.textContent = "üóë";
        delBtn.title = "Âà†Èô§ÁõÆÊ†áÈ°π";
        delBtn.onclick = () => {
          const plans = getGoalPlansByType(activeType);
          if (!plans[idx]) {
            return;
          }
          if (plans.length === 1) {
            plans[0] = { text: "", subs: [] };
          } else {
            plans.splice(idx, 1);
          }
          syncLegacyGoalFields();
          saveState();
          renderGoalWidget();
        };
        actions.appendChild(addSubBtn);
        actions.appendChild(delBtn);

        row.appendChild(input);
        row.appendChild(actions);
        node.appendChild(row);

        const subs = Array.isArray(item.subs) ? item.subs : [];
        if (subs.length) {
          const subList = document.createElement("div");
          subList.className = "sub-list";
          subs.forEach((subText, subIdx) => {
            const subRow = document.createElement("div");
            subRow.className = "sub-row goal-sub-row";

            const subInput = document.createElement("textarea");
            subInput.rows = 1;
            subInput.className = "todo-input";
            subInput.placeholder = "‰∫åÁ∫ßÁõÆÊ†á...";
            subInput.value = subText || "";
            subInput.addEventListener("input", (event) => {
              const plans = getGoalPlansByType(activeType);
              const current = plans[idx];
              if (!current || !Array.isArray(current.subs) || typeof current.subs[subIdx] !== "string") {
                return;
              }
              current.subs[subIdx] = event.target.value;
              syncLegacyGoalFields();
              saveState();
            });
            wireAutoGrow(subInput, 26);

            const subDel = document.createElement("button");
            subDel.type = "button";
            subDel.className = "todo-del";
            subDel.textContent = "üóë";
            subDel.title = "Âà†Èô§‰∫åÁ∫ßÈ°π";
            subDel.onclick = () => {
              const plans = getGoalPlansByType(activeType);
              const current = plans[idx];
              if (!current || !Array.isArray(current.subs) || typeof current.subs[subIdx] !== "string") {
                return;
              }
              current.subs.splice(subIdx, 1);
              syncLegacyGoalFields();
              saveState();
              renderGoalWidget();
            };

            subRow.appendChild(subInput);
            subRow.appendChild(subDel);
            subList.appendChild(subRow);
          });
          node.appendChild(subList);
        }

        goalTaskList.appendChild(node);
      });
    }

    function bindTimerFabEvents() {
      if (timerFabBound) {
        return;
      }
      timerFabBound = true;
      const timerFabBtn = document.getElementById("timerFabBtn");
      if (!timerFabBtn) {
        return;
      }
      timerFabBtn.onclick = () => {
        timerFabExpanded = !timerFabExpanded;
        renderFloatingTimer();
      };
    }

    function getWorkInboxModule() {
      if (!Array.isArray(state?.modules)) {
        return null;
      }
      const direct = state.modules.find((module) => module.id === "work-inbox");
      if (direct) {
        return direct;
      }
      return state.modules.find((module) => {
        const tag = `${module.id || ""} ${module.title || ""}`.toLowerCase();
        return module.mode === "work" && tag.includes("inbox");
      }) || null;
    }

    function openWorkInboxFromFab() {
      const target = getWorkInboxModule();
      if (!target) {
        alert("Êú™ÊâæÂà∞ Work Inbox Ê®°Âùó„ÄÇ");
        return;
      }
      inboxFabExpanded = false;
      state.layer = "sop";
      state.modeFilter = target.mode || "work";
      state.activeModuleId = target.id;
      saveState();
      renderLayer();
    }

    function bindInboxFabEvents() {
      if (inboxFabBound) {
        return;
      }
      inboxFabBound = true;
      const btn = document.getElementById("inboxFabBtn");
      if (!btn) {
        return;
      }
      btn.onclick = () => {
        const target = getWorkInboxModule();
        if (!target) {
          alert("Êú™ÊâæÂà∞ Work Inbox Ê®°Âùó„ÄÇ");
          return;
        }
        inboxFabExpanded = !inboxFabExpanded;
        renderInboxFabButton();
        renderInboxPanel();
      };
    }

    function renderInboxFabButton() {
      const btn = document.getElementById("inboxFabBtn");
      if (!btn) {
        return;
      }
      const target = getWorkInboxModule();
      const hasTarget = Boolean(target);
      btn.disabled = !hasTarget;
      if (!hasTarget) {
        inboxFabExpanded = false;
        btn.classList.remove("active");
        btn.title = "Êú™ÊâæÂà∞ Work Inbox";
        btn.setAttribute("aria-label", "Êú™ÊâæÂà∞ Work Inbox");
        return;
      }
      const active = inboxFabExpanded;
      btn.classList.toggle("active", active);
      btn.title = active ? "Êî∂Ëµ∑ Inbox Âç°Áâá" : "Â±ïÂºÄ Inbox Âç°Áâá";
      btn.setAttribute("aria-label", active ? "Êî∂Ëµ∑ Inbox Âç°Áâá" : "Â±ïÂºÄ Inbox Âç°Áâá");
    }

    function mutateWorkInbox(mutator) {
      const module = getWorkInboxModule();
      if (!module || typeof mutator !== "function") {
        return;
      }
      mutator(module);
      saveState();
      if (state.layer === "sop") {
        renderModuleList();
        if (state.activeModuleId === module.id) {
          renderModuleDetail();
        }
      }
      renderInboxPanel();
    }

    function renderInboxPanel() {
      const wrap = document.getElementById("goalFabWrap");
      const panel = document.getElementById("inboxPanel");
      if (!wrap || !panel) {
        return;
      }
      const module = getWorkInboxModule();
      const visible = Boolean(module && inboxFabExpanded);
      wrap.classList.toggle("inbox-expanded", visible);
      panel.innerHTML = "";
      if (!visible) {
        return;
      }

      const head = document.createElement("div");
      head.className = "inbox-panel-head";
      const title = document.createElement("p");
      title.className = "inbox-panel-title";
      title.textContent = "Inbox Âø´ÈÄüÂç°Áâá";
      const headActions = document.createElement("div");
      headActions.className = "inbox-panel-actions";
      const openBtn = document.createElement("button");
      openBtn.type = "button";
      openBtn.className = "goal-mini-btn";
      openBtn.textContent = "‚Üó";
      openBtn.title = "ÊâìÂºÄ Work Inbox Ê®°Âùó";
      openBtn.setAttribute("aria-label", "ÊâìÂºÄ Work Inbox Ê®°Âùó");
      openBtn.onclick = openWorkInboxFromFab;
      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.className = "goal-close-btn";
      closeBtn.textContent = "√ó";
      closeBtn.title = "Êî∂Ëµ∑ Inbox Âç°Áâá";
      closeBtn.setAttribute("aria-label", "Êî∂Ëµ∑ Inbox Âç°Áâá");
      closeBtn.onclick = () => {
        inboxFabExpanded = false;
        renderInboxFabButton();
        renderInboxPanel();
      };
      headActions.appendChild(openBtn);
      headActions.appendChild(closeBtn);
      head.appendChild(title);
      head.appendChild(headActions);

      const body = document.createElement("div");
      body.className = "inbox-panel-body";

      const top = document.createElement("div");
      top.className = "section-head";
      const listTitle = document.createElement("h3");
      listTitle.className = "section-title";
      listTitle.textContent = "Work Inbox";
      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "section-action-btn";
      addBtn.textContent = "+";
      addBtn.title = "Êñ∞Â¢ûÂæÖÂäû";
      addBtn.onclick = () => mutateWorkInbox((target) => {
        target.todos.push({ text: "", done: false, subs: [] });
      });
      top.appendChild(listTitle);
      top.appendChild(addBtn);
      body.appendChild(top);

      const todos = Array.isArray(module.todos) ? module.todos : [];
      if (!todos.length) {
        const empty = document.createElement("p");
        empty.className = "inbox-empty";
        empty.textContent = "ÂΩìÂâçÊ≤°ÊúâÂæÖÂäûÔºåÁÇπÂáª + Êñ∞Â¢û„ÄÇ";
        body.appendChild(empty);
      } else {
        const list = document.createElement("div");
        list.className = "todo-list";
        todos.forEach((todo, idx) => {
          const node = document.createElement("div");
          node.className = "todo-node";
          const row = document.createElement("div");
          row.className = `todo-row ${todo.done ? "done" : ""} ${isReflectionTodo(todo) ? "reflection" : ""}`;

          const check = document.createElement("input");
          check.type = "checkbox";
          check.className = "todo-check";
          check.checked = Boolean(todo.done);
          check.onchange = () => mutateWorkInbox((target) => {
            if (!target.todos[idx]) {
              return;
            }
            target.todos[idx].done = !target.todos[idx].done;
          });

          const input = document.createElement("textarea");
          input.rows = 1;
          input.className = "todo-input";
          input.value = todo.text || "";
          input.placeholder = isReflectionTodo(todo) ? "ReflectionÔºàÂèØÈÄâÔºâ‚Ä¶" : "Â°´ÂÜôÂÖ∑‰ΩìÂä®‰Ωú‚Ä¶";
          input.onchange = (event) => mutateWorkInbox((target) => {
            if (!target.todos[idx]) {
              return;
            }
            target.todos[idx].text = event.target.value;
          });
          wireAutoGrow(input, 26);

          const actions = document.createElement("div");
          actions.className = "todo-main-actions";
          const addSubBtn = document.createElement("button");
          addSubBtn.type = "button";
          addSubBtn.className = "mini-action";
          addSubBtn.textContent = "‚Ü≥";
          addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÈ°π";
          addSubBtn.onclick = () => mutateWorkInbox((target) => {
            const current = target.todos[idx];
            if (!current) {
              return;
            }
            if (!Array.isArray(current.subs)) {
              current.subs = [];
            }
            current.subs.push({ text: "", done: false });
          });
          const reflectBtn = document.createElement("button");
          reflectBtn.type = "button";
          reflectBtn.className = "mini-action";
          reflectBtn.textContent = "üìù";
          reflectBtn.title = "Ê∑ªÂä†ÂèçÊÄù";
          reflectBtn.onclick = () => mutateWorkInbox((target) => {
            const current = target.todos[idx];
            if (!current) {
              return;
            }
            if (!Array.isArray(current.subs)) {
              current.subs = [];
            }
            current.subs.push({ text: "ReflectionÔºàÂèØÈÄâÔºâ", done: false });
          });
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "todo-del";
          delBtn.textContent = "üóë";
          delBtn.title = "Âà†Èô§‰ªªÂä°";
          delBtn.onclick = () => mutateWorkInbox((target) => {
            if (!target.todos[idx]) {
              return;
            }
            target.todos.splice(idx, 1);
          });
          actions.appendChild(addSubBtn);
          actions.appendChild(reflectBtn);
          actions.appendChild(delBtn);

          row.appendChild(check);
          row.appendChild(input);
          row.appendChild(actions);
          node.appendChild(row);

          const subItems = Array.isArray(todo.subs) ? todo.subs : [];
          if (subItems.length) {
            const subList = document.createElement("div");
            subList.className = "sub-list";
            subItems.forEach((sub, subIdx) => {
              const subRow = document.createElement("div");
              subRow.className = `sub-row ${sub.done ? "done" : ""}`;

              const subCheck = document.createElement("input");
              subCheck.type = "checkbox";
              subCheck.className = "todo-check";
              subCheck.checked = Boolean(sub.done);
              subCheck.onchange = () => mutateWorkInbox((target) => {
                const current = target.todos[idx];
                if (!current || !Array.isArray(current.subs) || !current.subs[subIdx]) {
                  return;
                }
                current.subs[subIdx].done = !current.subs[subIdx].done;
              });

              const subInput = document.createElement("textarea");
              subInput.rows = 1;
              subInput.className = "todo-input";
              subInput.value = sub.text || "";
              subInput.placeholder = "‰∫åÁ∫ß checklist È°π‚Ä¶";
              subInput.onchange = (event) => mutateWorkInbox((target) => {
                const current = target.todos[idx];
                if (!current || !Array.isArray(current.subs) || !current.subs[subIdx]) {
                  return;
                }
                current.subs[subIdx].text = event.target.value;
              });
              wireAutoGrow(subInput, 26);

              const subDel = document.createElement("button");
              subDel.type = "button";
              subDel.className = "todo-del";
              subDel.textContent = "üóë";
              subDel.title = "Âà†Èô§Â≠êÈ°π";
              subDel.onclick = () => mutateWorkInbox((target) => {
                const current = target.todos[idx];
                if (!current || !Array.isArray(current.subs) || !current.subs[subIdx]) {
                  return;
                }
                current.subs.splice(subIdx, 1);
              });

              subRow.appendChild(subCheck);
              subRow.appendChild(subInput);
              subRow.appendChild(subDel);
              subList.appendChild(subRow);
            });
            node.appendChild(subList);
          }

          list.appendChild(node);
        });
        body.appendChild(list);
      }

      const hint = document.createElement("p");
      hint.className = "hint";
      hint.textContent = "‰∏é Work Inbox ‰ΩøÁî®Âêå‰∏Ä‰ªΩÂÜÖÂÆπÔºåÊîπÂä®‰ºöÂÆûÊó∂ÂêåÊ≠•„ÄÇ";
      body.appendChild(hint);

      panel.appendChild(head);
      panel.appendChild(body);
      refreshAutoGrowTextareas();
    }

    function renderLayer() {
      const sop = state.layer === "sop";
      document.getElementById("layerSopBtn").classList.toggle("active", sop);
      document.getElementById("layerDashboardBtn").classList.toggle("active", !sop);
      document.getElementById("sopView").classList.toggle("active", sop);
      document.getElementById("dashboardView").classList.toggle("active", !sop);
      document.title = sop ? "POS Console V2 - SOP ÊâßË°åÂ±Ç" : "POS Console V2 - Dashboard ÂÜ≥Á≠ñÂ±Ç";

      if (sop) {
        renderSop();
      } else {
        renderDashboard();
      }
      renderInboxFabButton();
      renderInboxPanel();
      renderFloatingTimer();
      renderGoalWidget();
    }

    function renderSop() {
      renderModeFilter();
      renderModuleList();
      renderModuleDetail();
      renderFloatingTimer();
      renderInboxFabButton();
      renderInboxPanel();
    }

    function renderModeFilter() {
      const container = document.getElementById("modeFilter");
      container.innerHTML = "";
      ["work", "comm", "sleep"].forEach((mode) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `chip ${state.modeFilter === mode ? "active" : ""}`;
        btn.textContent = MODE_LABEL[mode];
        btn.onclick = () => setModeFilter(mode);
        container.appendChild(btn);
      });
    }

    function renderModuleList() {
      ensureActiveModuleVisible();
      const list = document.getElementById("moduleList");
      list.innerHTML = "";
      const modules = getVisibleModules();

      if (!modules.length) {
        const empty = document.createElement("p");
        empty.className = "empty-note";
        empty.textContent = "ÂΩìÂâçÁ≠õÈÄâ‰∏ãÊ≤°ÊúâÊ®°Âùó„ÄÇ";
        list.appendChild(empty);
        return;
      }

      modules.forEach((module) => {
        const card = document.createElement("article");
        card.className = `module-card ${module.id === state.activeModuleId ? "active" : ""}`;
        card.onclick = () => selectModule(module.id);

        const index = document.createElement("div");
        index.className = `module-index ${MODE_COLOR_CLASS[module.mode]}`;
        index.textContent = module.order;

        const info = document.createElement("div");
        const title = document.createElement("h3");
        title.className = "module-name";
        title.textContent = module.title;

        const meta = document.createElement("div");
        meta.className = "module-meta";
        const progressNum = Math.round(moduleProgress(module));
        meta.innerHTML = `
          <span>Mode: ${MODE_LABEL[module.mode]}</span>
          <span>${module.duration} ÂàÜÈíü</span>
          <span>${progressNum}% ÂÆåÊàê</span>
        `;

        const progressWrap = document.createElement("div");
        progressWrap.className = "module-progress";
        const fill = document.createElement("div");
        fill.className = "module-progress-fill";
        fill.style.width = percent(moduleProgress(module));
        progressWrap.appendChild(fill);

        info.appendChild(title);
        info.appendChild(meta);
        info.appendChild(progressWrap);

        card.appendChild(index);
        card.appendChild(info);
        list.appendChild(card);
      });
    }

    function renderModuleDetail() {
      const module = getActiveModule();
      const container = document.getElementById("moduleDetail");
      container.innerHTML = "";

      if (!module) {
        container.innerHTML = '<p class="empty-note">ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê®°Âùó„ÄÇ</p>';
        renderFloatingTimer(null);
        return;
      }

      const todoSection = document.createElement("section");
      todoSection.className = "section";
      const todoHead = document.createElement("div");
      todoHead.className = "section-head";
      const todoTitle = document.createElement("h3");
      todoTitle.className = "section-title";
      todoTitle.textContent = "SOP Todo List";
      const addTodoBtn = document.createElement("button");
      addTodoBtn.type = "button";
      addTodoBtn.className = "section-action-btn";
      addTodoBtn.title = "Êñ∞Â¢ûÂæÖÂäû";
      addTodoBtn.textContent = "+";
      addTodoBtn.onclick = addTodo;
      todoHead.appendChild(todoTitle);
      todoHead.appendChild(addTodoBtn);
      todoSection.appendChild(todoHead);

      const todoList = document.createElement("div");
      todoList.className = "todo-list";

      module.todos.forEach((todo, idx) => {
        const node = document.createElement("div");
        node.className = "todo-node";

        const row = document.createElement("div");
        row.className = `todo-row ${todo.done ? "done" : ""} ${isReflectionTodo(todo) ? "reflection" : ""}`;

        const check = document.createElement("input");
        check.type = "checkbox";
        check.className = "todo-check";
        check.checked = todo.done;
        check.onchange = () => toggleTodo(idx);

        const input = document.createElement("textarea");
        input.rows = 1;
        input.className = "todo-input";
        input.value = todo.text;
        input.placeholder = isReflectionTodo(todo) ? "ReflectionÔºàÂèØÈÄâÔºâ‚Ä¶" : "Â°´ÂÜôÂÖ∑‰ΩìÂä®‰Ωú‚Ä¶";
        input.onchange = (event) => updateTodoText(idx, event.target.value);
        wireAutoGrow(input, 26);

        const actions = document.createElement("div");
        actions.className = "todo-main-actions";
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÈ°π";
        addSubBtn.onclick = () => addSubTodo(idx);

        const reflectBtn = document.createElement("button");
        reflectBtn.type = "button";
        reflectBtn.className = "mini-action";
        reflectBtn.textContent = "üìù";
        reflectBtn.title = "Ê∑ªÂä†ÂèçÊÄù";
        reflectBtn.onclick = () => addReflectionSubTodo(idx);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§‰ªªÂä°";
        del.onclick = () => deleteTodo(idx);

        actions.appendChild(addSubBtn);
        actions.appendChild(reflectBtn);
        actions.appendChild(del);

        row.appendChild(check);
        row.appendChild(input);
        row.appendChild(actions);
        node.appendChild(row);

        const subList = document.createElement("div");
        subList.className = "sub-list";
        const subItems = Array.isArray(todo.subs) ? todo.subs : [];
        subItems.forEach((sub, subIdx) => {
          const subRow = document.createElement("div");
          subRow.className = `sub-row ${sub.done ? "done" : ""}`;

          const subCheck = document.createElement("input");
          subCheck.type = "checkbox";
          subCheck.className = "todo-check";
          subCheck.checked = sub.done;
          subCheck.onchange = () => toggleSubTodo(idx, subIdx);

          const subInput = document.createElement("textarea");
          subInput.rows = 1;
          subInput.className = "todo-input";
          subInput.value = sub.text;
          subInput.placeholder = "‰∫åÁ∫ß checklist È°π‚Ä¶";
          subInput.onchange = (event) => updateSubTodoText(idx, subIdx, event.target.value);
          wireAutoGrow(subInput, 26);

          const subDel = document.createElement("button");
          subDel.type = "button";
          subDel.className = "todo-del";
          subDel.textContent = "üóë";
          subDel.title = "Âà†Èô§Â≠êÈ°π";
          subDel.onclick = () => deleteSubTodo(idx, subIdx);

          subRow.appendChild(subCheck);
          subRow.appendChild(subInput);
          subRow.appendChild(subDel);
          subList.appendChild(subRow);
        });

        if (subItems.length) {
          node.appendChild(subList);
        }

        todoList.appendChild(node);
      });

      todoSection.appendChild(todoList);
      const reflectHint = document.createElement("p");
      reflectHint.className = "hint";
      reflectHint.textContent = "ÊØèÊù° checklist ÂèØÁî®‚Äúüìù‚ÄùÊ∑ªÂä†ÂèçÊÄùÂ≠êÈ°πÔºõ‚Äú‚Ü≥‚ÄùÁî®‰∫éÊãÜÂàÜÊâßË°åÁªÜÈ°π„ÄÇ";
      todoSection.appendChild(reflectHint);

      container.appendChild(todoSection);
      refreshAutoGrowTextareas();
    }

    function renderFloatingTimer(module = getActiveModule()) {
      const root = document.getElementById("timerFloat");
      const timerFabBtn = document.getElementById("timerFabBtn");
      if (!root || !timerFabBtn) {
        return;
      }
      const hasModule = Boolean(module);
      timerFabBtn.classList.toggle("active", Boolean(hasModule && timerFabExpanded));
      timerFabBtn.title = timerFabExpanded ? "Êî∂Ëµ∑ËÆ°Êó∂Ë°®" : "Â±ïÂºÄËÆ°Êó∂Ë°®";
      timerFabBtn.setAttribute("aria-label", timerFabExpanded ? "Êî∂Ëµ∑ËÆ°Êó∂Ë°®" : "Â±ïÂºÄËÆ°Êó∂Ë°®");

      if (!hasModule || !timerFabExpanded) {
        root.classList.add("hidden");
        root.innerHTML = "";
        return;
      }

      root.classList.remove("hidden");
      root.innerHTML = "";

      const runningThisModule = Boolean(timerInterval && timerModuleId === module.id);

      const top = document.createElement("div");
      top.className = "timer-float-top";

      const clock = document.createElement("button");
      clock.type = "button";
      clock.id = "timerFloatClock";
      clock.className = "timer-float-clock";
      clock.title = "ÁÇπÂáª‰øÆÊîπËÆ°Êó∂Êó∂ÈïøÔºàÂàÜÈíüÔºâ";
      clock.textContent = formatTime(module.remainingSeconds);
      clock.onclick = () => editModuleDuration(module.id);

      const budget = document.createElement("div");
      budget.className = "timer-float-budget";
      const budgetTotal = document.createElement("span");
      budgetTotal.className = "timer-float-budget-total";
      budgetTotal.textContent = `${state.dailyBudgetMinutes}`;
      const budgetSyncBtn = document.createElement("button");
      budgetSyncBtn.type = "button";
      budgetSyncBtn.className = "timer-mini-btn";
      budgetSyncBtn.title = "ÊåâËÆ°Êó∂ÊÄªÂíåÂêåÊ≠•ÊÄªÈ¢ÑÁÆó";
      budgetSyncBtn.textContent = "‚àë";
      budgetSyncBtn.onclick = syncDailyBudgetToModules;
      budget.appendChild(budgetTotal);
      budget.appendChild(budgetSyncBtn);

      top.appendChild(clock);
      top.appendChild(budget);

      const meta = document.createElement("p");
      meta.className = "timer-float-meta";
      meta.textContent = `${module.title} ¬∑ ${module.duration}m`;

      const actions = document.createElement("div");
      actions.className = "timer-float-actions";

      const runBtn = document.createElement("button");
      runBtn.type = "button";
      runBtn.className = "timer-float-btn primary";
      runBtn.textContent = runningThisModule ? "‚è∏" : "‚ñ∂";
      runBtn.onclick = toggleTimer;

      const resetBtn = document.createElement("button");
      resetBtn.type = "button";
      resetBtn.className = "timer-float-btn";
      resetBtn.textContent = "‚Ü∫";
      resetBtn.onclick = resetTimer;

      actions.appendChild(runBtn);
      actions.appendChild(resetBtn);

      root.appendChild(top);
      root.appendChild(meta);
      root.appendChild(actions);
    }

    function getTotalDurationMinutes() {
      return state.modules.reduce((sum, module) => sum + module.duration, 0);
    }

    function setModuleDuration(moduleId, minutes) {
      if (!Number.isFinite(minutes) || minutes <= 0) {
        return;
      }
      const module = state.modules.find((item) => item.id === moduleId);
      if (!module) {
        return;
      }
      stopTimer();
      const intMinutes = Math.round(minutes);
      module.duration = intMinutes;
      module.remainingSeconds = intMinutes * 60;
      saveState();
      renderSop();
    }

    function editModuleDuration(moduleId) {
      const module = state.modules.find((item) => item.id === moduleId);
      if (!module) {
        return;
      }
      const input = window.prompt("ËÆæÁΩÆËØ•Ê®°ÂùóËÆ°Êó∂ÔºàÂàÜÈíüÔºâ", String(module.duration));
      if (input === null) {
        return;
      }
      const minutes = Number(input);
      if (!Number.isFinite(minutes) || minutes <= 0) {
        alert("ËØ∑ËæìÂÖ•Â§ß‰∫é 0 ÁöÑÊï∞Â≠ó„ÄÇ");
        return;
      }
      setModuleDuration(moduleId, minutes);
    }

    function syncDailyBudgetToModules() {
      state.dailyBudgetMinutes = getTotalDurationMinutes();
      saveState();
      renderFloatingTimer();
    }

    function toggleTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      module.todos[todoIndex].done = !module.todos[todoIndex].done;
      saveState();
      renderSop();
    }

    function updateTodoText(todoIndex, text) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      module.todos[todoIndex].text = text;
      saveState();
    }

    function deleteTodo(todoIndex) {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      module.todos.splice(todoIndex, 1);
      saveState();
      renderSop();
    }

    function addTodo() {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      module.todos.push({ text: "", done: false, subs: [] });
      saveState();
      renderSop();
    }

    function addSubTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      if (!Array.isArray(module.todos[todoIndex].subs)) {
        module.todos[todoIndex].subs = [];
      }
      module.todos[todoIndex].subs.push({ text: "", done: false });
      saveState();
      renderSop();
    }

    function addReflectionSubTodo(todoIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex]) {
        return;
      }
      if (!Array.isArray(module.todos[todoIndex].subs)) {
        module.todos[todoIndex].subs = [];
      }
      module.todos[todoIndex].subs.push({ text: "ReflectionÔºàÂèØÈÄâÔºâ", done: false });
      saveState();
      renderSop();
    }

    function toggleSubTodo(todoIndex, subIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs[subIndex].done = !module.todos[todoIndex].subs[subIndex].done;
      saveState();
      renderSop();
    }

    function updateSubTodoText(todoIndex, subIndex, text) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs[subIndex].text = text;
      saveState();
    }

    function deleteSubTodo(todoIndex, subIndex) {
      const module = getActiveModule();
      if (!module || !module.todos[todoIndex] || !module.todos[todoIndex].subs[subIndex]) {
        return;
      }
      module.todos[todoIndex].subs.splice(subIndex, 1);
      saveState();
      renderSop();
    }

    function isReflectionTodo(todo) {
      if (!todo || typeof todo.text !== "string") {
        return false;
      }
      return todo.text.trim().toLowerCase().startsWith("reflection");
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerModuleId = null;
    }

    function toggleTimer() {
      const module = getActiveModule();
      if (!module) {
        return;
      }

      if (timerInterval && timerModuleId === module.id) {
        stopTimer();
        saveState();
        renderFloatingTimer(module);
        return;
      }

      stopTimer();
      timerModuleId = module.id;
      timerInterval = setInterval(() => {
        const active = state.modules.find((m) => m.id === timerModuleId);
        if (!active) {
          stopTimer();
          return;
        }
        if (active.remainingSeconds > 0) {
          active.remainingSeconds -= 1;
          saveState();
          if (state.activeModuleId === active.id) {
            const clock = document.getElementById("timerFloatClock");
            if (clock) {
              clock.textContent = formatTime(active.remainingSeconds);
            }
          }
        }
        if (active.remainingSeconds <= 0) {
          active.remainingSeconds = 0;
          saveState();
          stopTimer();
          renderFloatingTimer(active);
          alert(`Ê®°Âùó„Äå${active.title}„ÄçËÆ°Êó∂ÁªìÊùü„ÄÇ`);
        }
      }, 1000);

      renderFloatingTimer(module);
    }

    function resetTimer() {
      const module = getActiveModule();
      if (!module) {
        return;
      }
      stopTimer();
      module.remainingSeconds = module.duration * 60;
      saveState();
      renderFloatingTimer(module);
    }

    function getDashboardExpandKey(section, domainKey, idx) {
      return `${section}:${domainKey}:${idx}`;
    }

    function isDashboardEntryExpanded(section, domainKey, idx, fallback = false) {
      const key = getDashboardExpandKey(section, domainKey, idx);
      if (Object.prototype.hasOwnProperty.call(dashboardItemExpanded, key)) {
        return Boolean(dashboardItemExpanded[key]);
      }
      return fallback;
    }

    function toggleDashboardEntryExpanded(section, domainKey, idx) {
      const key = getDashboardExpandKey(section, domainKey, idx);
      dashboardItemExpanded[key] = !isDashboardEntryExpanded(section, domainKey, idx, false);
      renderDashboard();
    }

    function renderDashboard() {
      const grid = document.getElementById("domainGrid");
      if (!grid) {
        return;
      }
      grid.innerHTML = "";
      const pick = document.createElement("div");
      pick.className = "domain-pick";
      DOMAIN_ORDER.forEach((key) => {
        const domain = state.dashboard.domains[key];
        if (!domain) {
          return;
        }
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `domain-pick-btn ${state.dashboard.activeDomain === key ? "active" : ""}`;
        btn.textContent = domain.name;
        btn.onclick = () => selectDomain(key);
        pick.appendChild(btn);
      });

      const activeKey = DOMAIN_ORDER.includes(state.dashboard.activeDomain)
        ? state.dashboard.activeDomain
        : DOMAIN_ORDER[0];
      const activeDomain = state.dashboard.domains[activeKey];
      if (!activeDomain) {
        grid.appendChild(pick);
        return;
      }

      const focus = document.createElement("div");
      focus.className = "domain-focus";

      const card = document.createElement("article");
      card.className = "domain-card";
      card.style.borderLeft = `4px solid ${activeDomain.color}`;

      const head = document.createElement("div");
      head.className = "domain-head";
      const name = document.createElement("h3");
      name.className = "domain-name";
      name.style.color = activeDomain.color;
      name.textContent = activeDomain.name;
      head.appendChild(name);

      const content = document.createElement("div");
      content.className = "domain-content";

      const fqaBlock = document.createElement("div");
      fqaBlock.className = "detail-block";
      const fqaLabelRow = document.createElement("div");
      fqaLabelRow.className = "label-row";
      fqaLabelRow.innerHTML = '<p class="label">FQA</p>';
      const addFqaBtn = document.createElement("button");
      addFqaBtn.type = "button";
      addFqaBtn.className = "icon-round-btn";
      addFqaBtn.textContent = "+";
      addFqaBtn.title = "Êñ∞Â¢û FQA";
      addFqaBtn.onclick = () => addFqa(activeKey);
      fqaLabelRow.appendChild(addFqaBtn);
      fqaBlock.appendChild(fqaLabelRow);

      const fqaList = document.createElement("div");
      fqaList.className = "list-edit";
      activeDomain.fqas.forEach((item, idx) => {
        const subs = Array.isArray(item.subs) ? item.subs : [];
        const expanded = isDashboardEntryExpanded(
          "fqa",
          activeKey,
          idx,
          !item.question && !item.answer && !subs.length
        );
        const wrap = document.createElement("div");
        wrap.className = `expand-item ${expanded ? "expanded" : ""}`;
        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "expand-toggle";
        toggle.onclick = () => toggleDashboardEntryExpanded("fqa", activeKey, idx);
        const title = document.createElement("p");
        title.className = "expand-title";
        title.textContent = firstLineText(item.question || item.answer || subs[0] || "") || `FQA ${idx + 1}`;
        const arrow = document.createElement("span");
        arrow.className = "expand-arrow";
        arrow.textContent = "‚Ä∫";
        toggle.appendChild(title);
        toggle.appendChild(arrow);
        wrap.appendChild(toggle);

        const body = document.createElement("div");
        body.className = "expand-body";
        const bodyStack = document.createElement("div");
        bodyStack.className = "list-edit";

        const qArea = document.createElement("textarea");
        qArea.className = "text-input";
        qArea.rows = 1;
        qArea.placeholder = "ÈóÆÈ¢ò...";
        qArea.value = item.question;
        qArea.onchange = (event) => updateFqaQuestion(activeKey, idx, event.target.value);
        wireAutoGrow(qArea, 34);

        const answerArea = document.createElement("textarea");
        answerArea.className = "text-input";
        answerArea.rows = 1;
        answerArea.placeholder = "ÂõûÁ≠î...";
        answerArea.value = item.answer;
        answerArea.onchange = (event) => updateFqaAnswer(activeKey, idx, event.target.value);
        wireAutoGrow(answerArea, 34);

        const row = document.createElement("div");
        row.className = "expand-row";
        const meta = document.createElement("p");
        meta.className = "expand-meta";
        meta.textContent = "ÂèØÂú®‰∏ªÊñáÊú¨Ê°Ü‰∏ãÊ∑ªÂä†‰∫åÁ∫ßÊñáÊú¨Ê°Ü„ÄÇ";
        const rightActions = document.createElement("div");
        rightActions.className = "fqa-actions";
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÊñáÊú¨";
        addSubBtn.onclick = () => addFqaSub(activeKey, idx);
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "todo-del";
        delBtn.textContent = "üóë";
        delBtn.title = "Âà†Èô§ FQA";
        delBtn.onclick = () => deleteFqa(activeKey, idx);
        rightActions.appendChild(addSubBtn);
        rightActions.appendChild(delBtn);
        row.appendChild(meta);
        row.appendChild(rightActions);

        bodyStack.appendChild(qArea);
        bodyStack.appendChild(answerArea);
        subs.forEach((line, subIdx) => {
          const subRow = document.createElement("div");
          subRow.className = "line-edit";
          const subInput = document.createElement("textarea");
          subInput.className = "text-input";
          subInput.rows = 1;
          subInput.placeholder = "‰∫åÁ∫ßÊñáÊú¨...";
          subInput.value = line;
          subInput.onchange = (event) => updateFqaSub(activeKey, idx, subIdx, event.target.value);
          wireAutoGrow(subInput, 34);
          const subDel = document.createElement("button");
          subDel.type = "button";
          subDel.className = "todo-del";
          subDel.textContent = "üóë";
          subDel.title = "Âà†Èô§‰∫åÁ∫ßÊñáÊú¨";
          subDel.onclick = () => deleteFqaSub(activeKey, idx, subIdx);
          subRow.appendChild(subInput);
          subRow.appendChild(subDel);
          bodyStack.appendChild(subRow);
        });
        bodyStack.appendChild(row);
        body.appendChild(bodyStack);
        wrap.appendChild(body);
        fqaList.appendChild(wrap);
      });
      fqaBlock.appendChild(fqaList);

      const principlesBlock = document.createElement("div");
      principlesBlock.className = "detail-block";
      const pLabelRow = document.createElement("div");
      pLabelRow.className = "label-row";
      pLabelRow.innerHTML = '<p class="label">Principles</p>';
      const addPrincipleBtn = document.createElement("button");
      addPrincipleBtn.type = "button";
      addPrincipleBtn.className = "icon-round-btn";
      addPrincipleBtn.textContent = "+";
      addPrincipleBtn.title = "Êñ∞Â¢û Principle";
      addPrincipleBtn.onclick = () => addPrinciple(activeKey);
      pLabelRow.appendChild(addPrincipleBtn);
      principlesBlock.appendChild(pLabelRow);

      const principlesList = document.createElement("div");
      principlesList.className = "list-edit";
      activeDomain.principles.forEach((entry, idx) => {
        const principle = normalizePrinciple(entry);
        const subs = Array.isArray(principle.subs) ? principle.subs : [];
        const expanded = isDashboardEntryExpanded("principles", activeKey, idx, !principle.text && !subs.length);
        const wrap = document.createElement("div");
        wrap.className = `expand-item ${expanded ? "expanded" : ""}`;
        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "expand-toggle";
        toggle.onclick = () => toggleDashboardEntryExpanded("principles", activeKey, idx);
        const title = document.createElement("p");
        title.className = "expand-title";
        title.textContent = firstLineText(principle.text || subs[0] || "") || `Principle ${idx + 1}`;
        const arrow = document.createElement("span");
        arrow.className = "expand-arrow";
        arrow.textContent = "‚Ä∫";
        toggle.appendChild(title);
        toggle.appendChild(arrow);
        wrap.appendChild(toggle);

        const body = document.createElement("div");
        body.className = "expand-body";
        const row = document.createElement("div");
        row.className = "line-edit";
        const input = document.createElement("textarea");
        input.className = "text-input";
        input.rows = 1;
        input.value = principle.text;
        input.placeholder = "ÂéüÂàô...";
        input.onchange = (event) => updatePrinciple(activeKey, idx, event.target.value);
        wireAutoGrow(input, 34);
        const actions = document.createElement("div");
        actions.className = "fqa-actions";
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÊñáÊú¨";
        addSubBtn.onclick = () => addPrincipleSub(activeKey, idx);
        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§ Principle";
        del.onclick = () => deletePrinciple(activeKey, idx);
        actions.appendChild(addSubBtn);
        actions.appendChild(del);
        row.appendChild(input);
        row.appendChild(actions);
        body.appendChild(row);
        subs.forEach((line, subIdx) => {
          const subRow = document.createElement("div");
          subRow.className = "line-edit";
          const subInput = document.createElement("textarea");
          subInput.className = "text-input";
          subInput.rows = 1;
          subInput.placeholder = "‰∫åÁ∫ßÊñáÊú¨...";
          subInput.value = line;
          subInput.onchange = (event) => updatePrincipleSub(activeKey, idx, subIdx, event.target.value);
          wireAutoGrow(subInput, 34);
          const subDel = document.createElement("button");
          subDel.type = "button";
          subDel.className = "todo-del";
          subDel.textContent = "üóë";
          subDel.title = "Âà†Èô§‰∫åÁ∫ßÊñáÊú¨";
          subDel.onclick = () => deletePrincipleSub(activeKey, idx, subIdx);
          subRow.appendChild(subInput);
          subRow.appendChild(subDel);
          body.appendChild(subRow);
        });
        wrap.appendChild(body);
        principlesList.appendChild(wrap);
      });
      principlesBlock.appendChild(principlesList);

      const sopBlock = document.createElement("div");
      sopBlock.className = "detail-block";
      const sLabelRow = document.createElement("div");
      sLabelRow.className = "label-row";
      sLabelRow.innerHTML = '<p class="label">SOP‰∏éÊ®°Áâà</p>';
      const addSopBtn = document.createElement("button");
      addSopBtn.type = "button";
      addSopBtn.className = "icon-round-btn";
      addSopBtn.textContent = "+";
      addSopBtn.title = "Êñ∞Â¢û SOP/Ê®°Áâà";
      addSopBtn.onclick = () => addSop(activeKey);
      sLabelRow.appendChild(addSopBtn);
      sopBlock.appendChild(sLabelRow);

      const sopList = document.createElement("div");
      sopList.className = "list-edit";
      activeDomain.sops.forEach((item, idx) => {
        const subs = Array.isArray(item.subs) ? item.subs : [];
        const expanded = isDashboardEntryExpanded("sop", activeKey, idx, !item.text && !item.fileName && !subs.length);
        const wrap = document.createElement("div");
        wrap.className = `expand-item ${expanded ? "expanded" : ""}`;
        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "expand-toggle";
        toggle.onclick = () => toggleDashboardEntryExpanded("sop", activeKey, idx);
        const title = document.createElement("p");
        title.className = "expand-title";
        title.textContent = firstLineText(item.text || item.fileName || subs[0] || "") || `SOP Êù°ÁõÆ ${idx + 1}`;
        const arrow = document.createElement("span");
        arrow.className = "expand-arrow";
        arrow.textContent = "‚Ä∫";
        toggle.appendChild(title);
        toggle.appendChild(arrow);
        wrap.appendChild(toggle);

        const body = document.createElement("div");
        body.className = "expand-body";
        const row = document.createElement("div");
        row.className = "sop-row";
        const check = document.createElement("input");
        check.type = "checkbox";
        check.className = "todo-check";
        check.checked = item.done;
        check.onchange = () => toggleSop(activeKey, idx);

        const text = document.createElement("textarea");
        text.className = "text-input";
        text.rows = 1;
        text.placeholder = "Â°´ÂÜô SOP ÊàñÊ®°ÁâàËØ¥Êòé...";
        text.value = item.text;
        text.onchange = (event) => updateSopText(activeKey, idx, event.target.value);
        wireAutoGrow(text, 34);

        const actions = document.createElement("div");
        actions.className = "fqa-actions";
        const attachBtn = document.createElement("button");
        attachBtn.type = "button";
        attachBtn.className = "icon-round-btn";
        attachBtn.textContent = "üìé";
        attachBtn.title = "Ê∑ªÂä†Êñá‰ª∂";
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.style.display = "none";
        fileInput.onchange = (event) => handleSopFileSelect(activeKey, idx, event);
        attachBtn.onclick = () => fileInput.click();
        const downBtn = document.createElement("button");
        downBtn.type = "button";
        downBtn.className = "icon-round-btn";
        downBtn.textContent = "‚§ì";
        downBtn.title = "‰∏ãËΩΩÊñá‰ª∂";
        downBtn.disabled = !item.fileData;
        downBtn.onclick = () => downloadSopFile(activeKey, idx);
        const clearFileBtn = document.createElement("button");
        clearFileBtn.type = "button";
        clearFileBtn.className = "icon-round-btn";
        clearFileBtn.textContent = "‚úï";
        clearFileBtn.title = "Âà†Èô§Â∑≤‰∏ä‰º†Êñá‰ª∂";
        clearFileBtn.disabled = !item.fileData && !item.fileName;
        clearFileBtn.onclick = () => clearSopFile(activeKey, idx);
        const addSubBtn = document.createElement("button");
        addSubBtn.type = "button";
        addSubBtn.className = "mini-action";
        addSubBtn.textContent = "‚Ü≥";
        addSubBtn.title = "Êñ∞Â¢û‰∫åÁ∫ßÊñáÊú¨";
        addSubBtn.onclick = () => addSopSub(activeKey, idx);
        const del = document.createElement("button");
        del.type = "button";
        del.className = "todo-del";
        del.textContent = "üóë";
        del.title = "Âà†Èô§Êù°ÁõÆ";
        del.onclick = () => deleteSop(activeKey, idx);
        actions.appendChild(attachBtn);
        actions.appendChild(downBtn);
        actions.appendChild(clearFileBtn);
        actions.appendChild(addSubBtn);
        actions.appendChild(del);

        row.appendChild(check);
        row.appendChild(text);
        row.appendChild(actions);
        body.appendChild(row);
        body.appendChild(fileInput);

        if (item.fileName) {
          const fileMeta = document.createElement("div");
          fileMeta.className = "sop-file";
          fileMeta.textContent = `Êñá‰ª∂Ôºö${item.fileName}`;
          body.appendChild(fileMeta);
        }

        subs.forEach((line, subIdx) => {
          const subRow = document.createElement("div");
          subRow.className = "line-edit";
          const subInput = document.createElement("textarea");
          subInput.className = "text-input";
          subInput.rows = 1;
          subInput.placeholder = "‰∫åÁ∫ßÊñáÊú¨...";
          subInput.value = line;
          subInput.onchange = (event) => updateSopSub(activeKey, idx, subIdx, event.target.value);
          wireAutoGrow(subInput, 34);
          const subDel = document.createElement("button");
          subDel.type = "button";
          subDel.className = "todo-del";
          subDel.textContent = "üóë";
          subDel.title = "Âà†Èô§‰∫åÁ∫ßÊñáÊú¨";
          subDel.onclick = () => deleteSopSub(activeKey, idx, subIdx);
          subRow.appendChild(subInput);
          subRow.appendChild(subDel);
          body.appendChild(subRow);
        });

        wrap.appendChild(body);
        sopList.appendChild(wrap);
      });
      sopBlock.appendChild(sopList);

      content.appendChild(fqaBlock);
      content.appendChild(principlesBlock);
      content.appendChild(sopBlock);

      card.appendChild(head);
      card.appendChild(content);
      focus.appendChild(card);

      grid.appendChild(pick);
      grid.appendChild(focus);
      refreshAutoGrowTextareas();
    }

    function selectDomain(key) {
      if (!DOMAIN_ORDER.includes(key)) {
        return;
      }
      state.dashboard.activeDomain = key;
      saveState();
      renderDashboard();
    }

    function addFqa(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.fqas.push({ question: "", answer: "", subs: [], expanded: false });
      saveState();
      renderDashboard();
    }

    function updateFqaQuestion(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].question = value;
      saveState();
    }

    function updateFqaAnswer(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].answer = value;
      saveState();
    }

    function addFqaSub(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      if (!Array.isArray(domain.fqas[idx].subs)) {
        domain.fqas[idx].subs = [];
      }
      domain.fqas[idx].subs.push("");
      saveState();
      renderDashboard();
    }

    function updateFqaSub(key, idx, subIdx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx] || !Array.isArray(domain.fqas[idx].subs)) {
        return;
      }
      if (typeof domain.fqas[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.fqas[idx].subs[subIdx] = value;
      saveState();
    }

    function deleteFqaSub(key, idx, subIdx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx] || !Array.isArray(domain.fqas[idx].subs)) {
        return;
      }
      if (typeof domain.fqas[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.fqas[idx].subs.splice(subIdx, 1);
      saveState();
      renderDashboard();
    }

    function toggleFqaAnswer(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.fqas[idx]) {
        return;
      }
      domain.fqas[idx].expanded = !domain.fqas[idx].expanded;
      saveState();
      renderDashboard();
    }

    function deleteFqa(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.fqas.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function addPrinciple(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.principles.push({ text: "", subs: [] });
      saveState();
      renderDashboard();
    }

    function updatePrinciple(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.principles[idx]) {
        return;
      }
      if (typeof domain.principles[idx] === "string") {
        domain.principles[idx] = { text: domain.principles[idx], subs: [] };
      }
      domain.principles[idx].text = value;
      saveState();
    }

    function addPrincipleSub(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.principles[idx]) {
        return;
      }
      if (typeof domain.principles[idx] === "string") {
        domain.principles[idx] = { text: domain.principles[idx], subs: [] };
      }
      if (!Array.isArray(domain.principles[idx].subs)) {
        domain.principles[idx].subs = [];
      }
      domain.principles[idx].subs.push("");
      saveState();
      renderDashboard();
    }

    function updatePrincipleSub(key, idx, subIdx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.principles[idx]) {
        return;
      }
      if (typeof domain.principles[idx] === "string") {
        domain.principles[idx] = { text: domain.principles[idx], subs: [] };
      }
      if (!Array.isArray(domain.principles[idx].subs) || typeof domain.principles[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.principles[idx].subs[subIdx] = value;
      saveState();
    }

    function deletePrincipleSub(key, idx, subIdx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.principles[idx]) {
        return;
      }
      if (typeof domain.principles[idx] === "string") {
        domain.principles[idx] = { text: domain.principles[idx], subs: [] };
      }
      if (!Array.isArray(domain.principles[idx].subs) || typeof domain.principles[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.principles[idx].subs.splice(subIdx, 1);
      saveState();
      renderDashboard();
    }

    function deletePrinciple(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.principles.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function addSop(key) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.sops.push({ text: "", done: false, fileName: "", fileType: "", fileData: "", subs: [] });
      saveState();
      renderDashboard();
    }

    function updateSopText(key, idx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      domain.sops[idx].text = value;
      saveState();
    }

    function addSopSub(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      if (!Array.isArray(domain.sops[idx].subs)) {
        domain.sops[idx].subs = [];
      }
      domain.sops[idx].subs.push("");
      saveState();
      renderDashboard();
    }

    function updateSopSub(key, idx, subIdx, value) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx] || !Array.isArray(domain.sops[idx].subs)) {
        return;
      }
      if (typeof domain.sops[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.sops[idx].subs[subIdx] = value;
      saveState();
    }

    function deleteSopSub(key, idx, subIdx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx] || !Array.isArray(domain.sops[idx].subs)) {
        return;
      }
      if (typeof domain.sops[idx].subs[subIdx] !== "string") {
        return;
      }
      domain.sops[idx].subs.splice(subIdx, 1);
      saveState();
      renderDashboard();
    }

    function toggleSop(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      domain.sops[idx].done = !domain.sops[idx].done;
      saveState();
      renderDashboard();
    }

    function deleteSop(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain) {
        return;
      }
      domain.sops.splice(idx, 1);
      saveState();
      renderDashboard();
    }

    function clearSopFile(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        return;
      }
      domain.sops[idx].fileName = "";
      domain.sops[idx].fileType = "";
      domain.sops[idx].fileData = "";
      saveState();
      renderDashboard();
    }

    function handleSopFileSelect(key, idx, event) {
      const file = event.target.files?.[0];
      if (!file) {
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        alert("Êñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã© 2MB ‰ª•ÂÜÖÊñá‰ª∂„ÄÇ");
        event.target.value = "";
        return;
      }
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx]) {
        event.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        domain.sops[idx].fileName = file.name;
        domain.sops[idx].fileType = file.type || "";
        domain.sops[idx].fileData = typeof reader.result === "string" ? reader.result : "";
        saveState();
        renderDashboard();
      };
      reader.readAsDataURL(file);
      event.target.value = "";
    }

    function downloadSopFile(key, idx) {
      const domain = state.dashboard.domains[key];
      if (!domain || !domain.sops[idx] || !domain.sops[idx].fileData) {
        return;
      }
      const item = domain.sops[idx];
      const a = document.createElement("a");
      a.href = item.fileData;
      a.download = item.fileName || `sop-file-${idx + 1}`;
      a.click();
    }

    function exportData() {
      const now = new Date();
      const stamp = [
        now.getFullYear(),
        String(now.getMonth() + 1).padStart(2, "0"),
        String(now.getDate()).padStart(2, "0"),
        String(now.getHours()).padStart(2, "0"),
        String(now.getMinutes()).padStart(2, "0")
      ].join("");
      const csvEscape = (value) => {
        const str = value == null ? "" : String(value);
        return `"${str.replace(/"/g, "\"\"")}"`;
      };

      const rows = [];
      rows.push([
        "Section",
        "Category",
        "Group",
        "Item",
        "SubItem",
        "Status",
        "Value",
        "Extra"
      ]);

      rows.push(["Meta", "DailyBudgetMinutes", "", "", "", "", state.dailyBudgetMinutes, ""]);
      rows.push(["Meta", "ShortTermGoal", "", "", "", "", state.goals?.shortTerm || "", ""]);
      rows.push(["Meta", "LongTermGoal", "", "", "", "", state.goals?.longTerm || "", ""]);
      (state.goals?.shortTermSubs || []).forEach((line, idx) => {
        rows.push(["Meta", "ShortTermGoalSub", "", `${idx + 1}`, "", "", line, ""]);
      });
      (state.goals?.longTermSubs || []).forEach((line, idx) => {
        rows.push(["Meta", "LongTermGoalSub", "", `${idx + 1}`, "", "", line, ""]);
      });
      rows.push([
        "Meta",
        "StateSnapshot",
        "",
        "",
        "",
        "",
        encodeBase64Utf8(JSON.stringify(state)),
        "format=base64json"
      ]);

      state.modules.forEach((module) => {
        rows.push([
          "SOP",
          "Module",
          module.title,
          "Timer",
          "",
          "",
          module.duration,
          `id=${module.id};remaining=${module.remainingSeconds}`
        ]);

        module.todos.forEach((todo, todoIdx) => {
          rows.push([
            "SOP",
            "Todo",
            module.title,
            `${todoIdx + 1}`,
            "",
            todo.done ? "done" : "pending",
            todo.text,
            `id=${module.id}`
          ]);
          (todo.subs || []).forEach((sub, subIdx) => {
            rows.push([
              "SOP",
              "SubTodo",
              module.title,
              `${todoIdx + 1}`,
              `${subIdx + 1}`,
              sub.done ? "done" : "pending",
              sub.text,
              `id=${module.id}`
            ]);
          });
        });
      });

      DOMAIN_ORDER.forEach((key) => {
        const domain = state.dashboard.domains[key];
        if (!domain) {
          return;
        }
        (domain.fqas || []).forEach((item, idx) => {
          rows.push([
            "Dashboard",
            "FQA",
            domain.name,
            `${idx + 1}`,
            "Q",
            "",
            item.question,
            `key=${key}`
          ]);
          rows.push([
            "Dashboard",
            "FQA",
            domain.name,
            `${idx + 1}`,
            "A",
            "",
            item.answer,
            `key=${key}`
          ]);
        });

        (domain.principles || []).forEach((line, idx) => {
          const principle = normalizePrinciple(line);
          rows.push([
            "Dashboard",
            "Principles",
            domain.name,
            `${idx + 1}`,
            "",
            "",
            principle.text,
            `key=${key}`
          ]);
        });

        (domain.sops || []).forEach((item, idx) => {
          const sopExtra = [
            `key=${key}`,
            item.fileName ? `fileNameB64=${encodeBase64Utf8(item.fileName)}` : "",
            item.fileType ? `fileTypeB64=${encodeBase64Utf8(item.fileType)}` : "",
            item.fileData ? `fileDataB64=${encodeBase64Utf8(item.fileData)}` : ""
          ].filter(Boolean).join(";");
          rows.push([
            "Dashboard",
            "SOP‰∏éÊ®°Áâà",
            domain.name,
            `${idx + 1}`,
            "",
            item.done ? "done" : "pending",
            item.text,
            sopExtra
          ]);
        });
      });

      const csv = "\ufeff" + rows.map((row) => row.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pos-console-export-${stamp}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener("beforeunload", () => {
      stopTimer();
      if (cloudPushTimer) {
        clearTimeout(cloudPushTimer);
        cloudPushTimer = null;
      }
    });

    function registerServiceWorker() {
      const secure = window.isSecureContext
        || location.protocol === "https:"
        || location.hostname === "localhost"
        || location.hostname === "127.0.0.1";
      if (!secure || !("serviceWorker" in navigator)) {
        return;
      }
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }

    async function init() {
      state = loadState();
      localMeta = loadLocalMeta();
      supabaseConfig = loadSupabaseConfig();
      bindAutoGrowViewportListeners();
      bindGoalWidgetEvents();
      bindTimerFabEvents();
      bindInboxFabEvents();
      ensureActiveModuleVisible();
      if (!DOMAIN_ORDER.includes(state.dashboard.activeDomain)) {
        state.dashboard.activeDomain = DOMAIN_ORDER[0];
      }
      registerServiceWorker();
      updateCloudButtons();
      await initCloudSyncOnStartup();
      renderLayer();
    }

    init();
  </script>
</body>
</html>
